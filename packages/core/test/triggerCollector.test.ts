import { ServerlessTriggerCollector } from '../src';
import { join } from 'path';
import { clearAllModule } from '@midwayjs/decorator';
import { clearContainerCache } from '../src';

describe('/test/triggerCollector.test.ts', function () {

  it('should test with function router', async () => {
    clearAllModule();
    clearContainerCache();
    const collector = new ServerlessTriggerCollector(join(__dirname, './fixtures/base-app-func-router'));
    const result = await collector.getFunctionList();
    // expect(result.length).toEqual(8);
    console.log(JSON.stringify(result))
    expect(result).toEqual([{"prefix":"/","routerName":"","url":"/upload","requestMethod":"get","method":"upload","description":"","summary":"","handlerName":"helloHttpService.upload","funcHandlerName":"helloHttpService.upload","controllerId":"helloHttpService","middleware":[],"controllerMiddleware":[],"requestMetadata":[],"responseMetadata":[],"functionName":"helloHttpService_upload","functionTriggerName":"http","functionTriggerMetadata":{"path":"/upload","method":"get","functionName":"helloHttpService_upload"},"_pureRouter":"/upload","_level":1,"_paramString":"","_category":2},{"prefix":"/","routerName":"","url":"/update","requestMethod":"post","method":"invoke","description":"","summary":"","handlerName":"helloHttpService.invoke","funcHandlerName":"helloHttpService.invoke","controllerId":"helloHttpService","middleware":[],"controllerMiddleware":[],"requestMetadata":[],"responseMetadata":[],"functionName":"helloHttpService_invoke","functionTriggerName":"apigw","functionTriggerMetadata":{"path":"/update","method":"post","functionName":"helloHttpService_invoke"},"_pureRouter":"/update","_level":1,"_paramString":"","_category":2},{"prefix":"/","routerName":"","url":"/invoke","requestMethod":"get","method":"invoke","description":"","summary":"","handlerName":"helloHttpService.invoke","funcHandlerName":"helloHttpService.invoke","controllerId":"helloHttpService","middleware":[],"controllerMiddleware":[],"requestMetadata":[],"responseMetadata":[],"functionName":"helloHttpService_invoke","functionTriggerName":"http","functionTriggerMetadata":{"path":"/invoke","method":"get","functionName":"helloHttpService_invoke"},"_pureRouter":"/invoke","_level":1,"_paramString":"","_category":2},{"prefix":"/","routerName":"","url":"/other","requestMethod":"all","method":"handler","description":"","summary":"","handlerName":"helloHttpService.handler","funcHandlerName":"http.handler","controllerId":"helloHttpService","middleware":[],"controllerMiddleware":[],"requestMetadata":[],"responseMetadata":[],"_pureRouter":"/other","_level":1,"_paramString":"","_category":2},{"prefix":"/","routerName":"","url":"/","requestMethod":"get","method":"homeSet","description":"","summary":"","handlerName":"apiController.homeSet","funcHandlerName":"apiController.homeSet","controllerId":"apiController","middleware":[],"controllerMiddleware":[],"requestMetadata":[],"responseMetadata":[],"_pureRouter":"/","_level":1,"_paramString":"","_category":2},{"prefix":"/","routerName":"","url":"","requestMethod":"","method":"upload","description":"","summary":"","handlerName":"helloHttpService.upload","funcHandlerName":"helloHttpService.upload","controllerId":"helloHttpService","middleware":[],"controllerMiddleware":[],"requestMetadata":[],"responseMetadata":[],"functionName":"helloHttpService_upload","functionTriggerName":"hsf","functionTriggerMetadata":{"functionName":"helloHttpService_upload"},"_pureRouter":"","_level":0,"_paramString":"","_category":2},{"prefix":"/","routerName":"","url":"","requestMethod":"","method":"upload","description":"","summary":"","handlerName":"helloHttpService.upload","funcHandlerName":"http.upload","controllerId":"helloHttpService","middleware":["fmw:upload"],"controllerMiddleware":[],"requestMetadata":[],"responseMetadata":[],"_pureRouter":"","_level":0,"_paramString":"","_category":2},{"prefix":"/","routerName":"","url":"","requestMethod":"","method":"invoke","description":"","summary":"","handlerName":"helloHttpService.invoke","funcHandlerName":"helloHttpService.invoke","controllerId":"helloHttpService","middleware":[],"controllerMiddleware":[],"requestMetadata":[],"responseMetadata":[],"functionName":"helloHttpService_invoke","functionTriggerName":"timer","functionTriggerMetadata":{"type":"every","value":"5m","payload":"","functionName":"helloHttpService_invoke"},"_pureRouter":"","_level":0,"_paramString":"","_category":2}]);
  });

});
