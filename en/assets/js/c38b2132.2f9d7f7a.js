"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[30067],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>g});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),d=p(n),m=r,g=d["".concat(s,".").concat(m)]||d[m]||c[m]||i;return n?a.createElement(g,l(l({ref:t},u),{},{components:n})):a.createElement(g,l({ref:t},u))}));function g(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[d]="string"==typeof e?e:r,l[1]=o;for(var p=2;p<i;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},12550:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>c,frontMatter:()=>i,metadata:()=>o,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const i={},l="Parameter verification",o={unversionedId:"extensions/validate",id:"extensions/validate",title:"Parameter verification",description:"We often need to perform type checking and parameter conversion when calling a method. Midway provides a simple ability to quickly check the type of a parameter. This ability comes from joi.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/extensions/validate.md",sourceDirName:"extensions",slug:"/extensions/validate",permalink:"/en/docs/extensions/validate",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/extensions/validate.md",tags:[],version:"current",frontMatter:{},sidebar:"component",previous:{title:"Information viewing",permalink:"/en/docs/extensions/info"},next:{title:"Swagger",permalink:"/en/docs/extensions/swagger"}},s={},p=[{value:"Background",id:"background",level:2},{value:"Installation dependency",id:"installation-dependency",level:2},{value:"Open the component",id:"open-the-component",level:2},{value:"Define inspection rules",id:"define-inspection-rules",level:2},{value:"Check parameters",id:"check-parameters",level:2},{value:"Validate pipeline",id:"validate-pipeline",level:2},{value:"Custom validate pipeline",id:"custom-validate-pipeline",level:2},{value:"Check rule",id:"check-rule",level:2},{value:"Common verification writing",id:"common-verification-writing",level:3},{value:"Cascade Check",id:"cascade-check",level:3},{value:"Inheritance check",id:"inheritance-check",level:3},{value:"Multi-type verification",id:"multi-type-verification",level:3},{value:"Create a new DTO from the original DTO",id:"create-a-new-dto-from-the-original-dto",level:3},{value:"Reuse verification rules",id:"reuse-verification-rules",level:3},{value:"Multilingual",id:"multilingual",level:2},{value:"Specify the language through the decorator",id:"specify-the-language-through-the-decorator",level:3},{value:"Specify language through parameters",id:"specify-language-through-parameters",level:3},{value:"Translation in other languages",id:"translation-in-other-languages",level:3},{value:"Custom error text",id:"custom-error-text",level:2},{value:"Specifies the text of a single rule",id:"specifies-the-text-of-a-single-rule",level:3},{value:"Global Specify Partial Text",id:"global-specify-partial-text",level:3},{value:"Fully customize error text",id:"fully-customize-error-text",level:3},{value:"Default configuration",id:"default-configuration",level:2},{value:"Independent verification service",id:"independent-verification-service",level:2},{value:"Frequently Asked Questions",id:"frequently-asked-questions",level:2},{value:"1. Allow undefined fields",id:"1-allow-undefined-fields",level:3},{value:"2. Remove undefined attributes from parameters",id:"2-remove-undefined-attributes-from-parameters",level:3},{value:"3. Handling verification errors",id:"3-handling-verification-errors",level:3},{value:"4. Temporarily disable global verification",id:"4-temporarily-disable-global-verification",level:3}],u={toc:p},d="wrapper";function c(e){let{components:t,...n}=e;return(0,r.kt)(d,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"parameter-verification"},"Parameter verification"),(0,r.kt)("p",null,"We often need to perform type checking and parameter conversion when calling a method. Midway provides a simple ability to quickly check the type of a parameter. This ability comes from ",(0,r.kt)("a",{parentName:"p",href:"https://joi.dev/api/"},"joi"),"."),(0,r.kt)("p",null,"Related information:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null}))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Can be used for standard projects"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Can be used for Serverless"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Can be used for integration"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Contains independent main framework"),(0,r.kt)("td",{parentName:"tr",align:null},"\u274c")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Contains independent logs"),(0,r.kt)("td",{parentName:"tr",align:null},"\u274c")))),(0,r.kt)("h2",{id:"background"},"Background"),(0,r.kt)("p",null,"The most commonly used parameter check is the controller (Controller), and you can also use this capability in any Class."),(0,r.kt)("p",null,"Let's take the user used in the controller (Controller) as an example."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"\u279c  my_midway_app tree\n.\n\u251c\u2500\u2500 src\n\u2502   \u251c\u2500\u2500 controller\n\u2502   \u2502   \u2514\u2500\u2500 user.ts\n\u2502   \u251c\u2500\u2500 interface.ts\n\u2502   \u2514\u2500\u2500 service\n\u2502       \u2514\u2500\u2500 user.ts\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 tsconfig.json\n")),(0,r.kt)("p",null,"Under normal circumstances, we obtain all post results from the ",(0,r.kt)("inlineCode",{parentName:"p"},"body")," and perform some verifications."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/interface.ts\nexport interface User {\n  id: number;\n  firstName: string;\n  lastName: string;\n  age: number;\n}\n\n// src/controller/home.ts\nimport { Controller, Get, Provide } from '@midwayjs/core';\n\n@Controller('/api/user')\nexport class HomeController {\n\n  @Post('/')\n  async updateUser(@Body() user: User ) {\n    if ( !user.id || typeof user.id !== 'number') {\n        throw new Error('id error');\n    }\n\n    if (user.age <= 30) {\n        throw new Error('age not match');\n    }\n    // xxx\n  }\n}\n")),(0,r.kt)("p",null,"If each method needs to be verified in this way, it will be very complicated."),(0,r.kt)("p",null,"In response to this situation, Midway provides Validate components.  ",(0,r.kt)("inlineCode",{parentName:"p"},"@Validate")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"@Rule")," decorators are used to ",(0,r.kt)("strong",{parentName:"p"},"quickly define verification rules")," to help users ",(0,r.kt)("strong",{parentName:"p"},"reduce these duplicate codes"),"."),(0,r.kt)("p",null,"Note that starting with v3, ",(0,r.kt)("inlineCode",{parentName:"p"},"@Rule")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"@Validate")," decorators are exported from ",(0,r.kt)("inlineCode",{parentName:"p"},"@midwayjs/validate"),"."),(0,r.kt)("h2",{id:"installation-dependency"},"Installation dependency"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i @midwayjs/validate@3 --save\n")),(0,r.kt)("p",null,"Or reinstall the following dependencies in ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "dependencies": {\n    "@midwayjs/validate": "^3.0.0",\n    // ...\n  },\n  "devDependencies": {\n    // ...\n  }\n}\n')),(0,r.kt)("h2",{id:"open-the-component"},"Open the component"),(0,r.kt)("p",null,"Add components to ",(0,r.kt)("inlineCode",{parentName:"p"},"configuration.ts"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Configuration, App } from '@midwayjs/core';\nimport * as koa from '@midwayjs/koa';\nimport * as validate from '@midwayjs/validate';\nimport { join } from 'path';\n\n@Configuration({\n  imports: [koa, validate],\n  importConfigs: [join(__dirname, './config')]\n})\nexport class MainConfiguration {\n  @App()\n  app: koa.Application;\n\n  async onReady() {\n    // ...\n  }\n}\n")),(0,r.kt)("h2",{id:"define-inspection-rules"},"Define inspection rules"),(0,r.kt)("p",null,"According to the above logic, we need to ",(0,r.kt)("strong",{parentName:"p"},"redefine a new Class")," because the decorator can only be decorated on the actual Class, not the interface."),(0,r.kt)("p",null,"To facilitate subsequent processing, we put the user in a ",(0,r.kt)("inlineCode",{parentName:"p"},"src/dto")," directory."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Data Transfer Object DTO is a simple container for a set of aggregated data that needs to be transmitted across process or network boundaries. It should not contain business logic and limit its behavior to activities such as internal consistency checking and basic verification.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/dto/user.ts\nimport { Rule, RuleType } from '@midwayjs/validate';\n\nexport class UserDTO {\n  @Rule(RuleType.number().required())\n  id: number;\n\n  @Rule(RuleType.string().required())\n  firstName: string;\n\n  @Rule(RuleType.string().max(10))\n  lastName: string;\n\n  @Rule(RuleType.number().max(60))\n  age: number;\n}\n")),(0,r.kt)("p",null,"Since this class belongs to a ",(0,r.kt)("inlineCode",{parentName:"p"},"PlainObject")," and does not need to be managed by dependency injection, we do not need to provide a ",(0,r.kt)("inlineCode",{parentName:"p"},"@Provide")," decorator."),(0,r.kt)("p",null,"This User Class provides three attributes and their corresponding verification rules."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"id")," is a required number type."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"firstName")," a required string type"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"lastName")," an optional string type with a maximum length of 10"),(0,r.kt)("li",{parentName:"ul"},"A maximum number of ",(0,r.kt)("inlineCode",{parentName:"li"},"age")," is not more than 60.")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"@Rule")," decorator is used to ",(0,r.kt)("strong",{parentName:"p"},"modify the attributes")," that need to be verified. Its parameters are a chain method of verification rules provided by the ",(0,r.kt)("inlineCode",{parentName:"p"},"RuleType")," object."),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"The ",(0,r.kt)("inlineCode",{parentName:"p"},"RuleType")," here is the joi object itself.")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://joi.dev/api/"},"joi")," provides a lot of verification types. You can also verify fields in objects and arrays, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"RuleType.string().email()")," commonly used for strings, and regular check for ",(0,r.kt)("inlineCode",{parentName:"p"},"RuleType.string().pattern(/xxxx/)"),". You can query API documents of ",(0,r.kt)("a",{parentName:"p",href:"https://joi.dev/api/"},"joi"),"."),(0,r.kt)("h2",{id:"check-parameters"},"Check parameters"),(0,r.kt)("p",null,"After defining the type, it can be directly used in the business code, and the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Validate")," decorator is required to turn on the verification capability."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/home.ts\nimport { Controller, Get, Provide } from '@midwayjs/core';\nimport { UserDTO } from './dto/user';\n\n@Controller('/api/user')\nexport class HomeController {\n\n  @Post('/')\n  async updateUser(@Body() user: UserDTO ) {\n    // user.id\n  }\n}\n")),(0,r.kt)("p",null,"All the verification codes have disappeared, and the business has become purer. Of course, remember to replace the original user interface with Class."),(0,r.kt)("p",null,"Once the verification fails, the browser or console will report a similar error."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'ValidationError: "id" is required\n')),(0,r.kt)("p",null,"In addition, because the type of ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," is defined, the id is automatically changed to a number when a string is obtained."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"async updateUser(@Body() user: UserDTO ) {\n  // typeof user.id === 'number'\n}\n")),(0,r.kt)("p",null,"If you need to configure information separately at the method level, you can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Validate")," decorator, such as configuring the error status separately."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/home.ts\nimport { Controller, Get, Provide } from '@midwayjs/core';\nimport { Validate } from '@midwayjs/validate';\nimport { UserDTO } from './dto/user';\n\n@Controller('/api/user')\nexport class HomeController {\n\n   @Post('/')\n   @Validate({\n     errorStatus: 422,\n   })\n   async updateUser(@Body() user: UserDTO ) {\n     // user.id\n   }\n}\n")),(0,r.kt)("p",null,"In general, use the global default configuration."),(0,r.kt)("h2",{id:"validate-pipeline"},"Validate pipeline"),(0,r.kt)("p",null,"If your parameters are basic types, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"number"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"string"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"boolean"),", you can use the pipeline provided by the component for validation."),(0,r.kt)("p",null,"The default web parameter decorators can all be piped as the second argument."),(0,r.kt)("p",null,"for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { ParseIntPipe } from '@midwayjs/validate';\n\n@Controller('/api/user')\nexport class HomeController {\n\n   @Post('/update_age')\n   async updateAge(@Body('age', [ParseIntPipe]) age: number ) {\n     //...\n   }\n}\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"ParseIntPipe")," pipeline can convert strings and numeric data into numbers, so that the ",(0,r.kt)("inlineCode",{parentName:"p"},"age")," field obtained from the request parameters will pass the validation of the pipeline and be converted into a numeric format."),(0,r.kt)("p",null,"The built-in pipelines that can be used are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ParseIntPipe")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ParseFloatPipe")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ParseBoolPipe")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"DefaultValuePipe"))),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"ParseIntPipe")," is used to convert an argument to an integer."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { ParseIntPipe } from '@midwayjs/validate';\n\n//...\nasync update(@Body('age', [ParseIntPipe]) age: number) {\n   return age;\n}\n\nupdate({ age: '12'} ); => 12\nupdate({ age: '12.2'} ); => Error\nupdate({ age: 'abc'} ); => Error\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"ParseFloatPipe")," is used to convert the parameter to a floating point number."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { ParseFloatPipe } from '@midwayjs/validate';\n\n//...\nasync update(@Body('size', [ParseFloatPipe]) size: number) {\n   return size;\n}\n\nupdate({ size: '12.2'} ); => 12.2\nupdate({ size: '12'} ); => 12\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"ParseBoolPipe")," is used to convert parameters to boolean values."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { ParseBoolPipe } from '@midwayjs/validate';\n\n//...\nasync update(@Body('isMale', [ParseBoolPipe]) isMale: boolean) {\n   return isMale;\n}\n\nupdate({ isMale: 'true'} ); => true\nupdate({ isMale: '0'} ); => Error\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"DefaultValuePipe")," is used to set the default value."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { DefaultValuePipe } from '@midwayjs/validate';\n\n//...\nasync update(@Body('nickName', [new DefaultValuePipe('anonymous')]) nickName: string) {\n   return nickName;\n}\n\nupdate({ isMale: undefined} ); => 'anonymous'\n")),(0,r.kt)("p",null,"In non-Web scenarios, if there is no web class decorator such as ",(0,r.kt)("inlineCode",{parentName:"p"},"@Body"),", you can also use the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Valid")," decorator for validation."),(0,r.kt)("p",null,"For example in a service:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Valid } from '@midwayjs/validate';\nimport { Provide } from '@midwayjs/core';\n\n@Provide()\nexport class UserService {\n   async updateUser(@Valid() user: UserDTO ) {\n     //...\n   }\n}\n")),(0,r.kt)("p",null,"If the parameter is not DTO, there is no rule, and a validation rule in Joi format can also be passed through the parameter."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Valid, RuleType } from '@midwayjs/validate';\nimport { Provide } from '@midwayjs/core';\n\n@Provide()\nexport class UserService {\n   async updateUser(@Valid(RuleType. number(). required()) userAge: number ) {\n     //...\n   }\n}\n")),(0,r.kt)("h2",{id:"custom-validate-pipeline"},"Custom validate pipeline"),(0,r.kt)("p",null,"If the default pipeline does not meet the requirements, you can quickly implement a custom validation pipeline through inheritance. The component has provided a ",(0,r.kt)("inlineCode",{parentName:"p"},"ParsePipe")," class for quick writing."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Pipe } from '@midwayjs/core';\nimport { ParsePipe, RuleType } from '@midwayjs/validate';\n\n@Pipe()\nexport class ParseCustomDataPipe extends ParsePipe {\n   getSchema(): RuleType. AnySchema<any> {\n     //...\n   }\n}\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"getSchema")," method is used to return a validation rule conforming to ",(0,r.kt)("inlineCode",{parentName:"p"},"Joi")," format."),(0,r.kt)("p",null,"For example, the code of ",(0,r.kt)("inlineCode",{parentName:"p"},"ParseIntPipe")," is as follows. When the pipeline is executed, the schema will be automatically obtained for verification, and the value will be returned after the verification is successful."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Pipe } from '@midwayjs/core';\nimport { ParsePipe, RuleType } from '@midwayjs/validate';\n\n@Pipe()\nexport class ParseIntPipe extends ParsePipe {\n   getSchema() {\n     return RuleType.number().integer().required();\n   }\n}\n")),(0,r.kt)("h2",{id:"check-rule"},"Check rule"),(0,r.kt)("h3",{id:"common-verification-writing"},"Common verification writing"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"RuleType.number().required(); // Number, required\nRuleType.string().empty('') // string is not required\nRuleType.number().max(10).min(1); //Number, Maximum and Minimum\nRuleType.number().greater(10).less(50); // Number, greater than 10, less than 50\n\nRuleType.string().max(10).min(5); //String, maximum length 10, minimum 5\nRuleType.string().length(20); //String, length 20\nRuleType.string().pattern(/^[abc]+$/); // String, matching regular format\n\nRuleType.object().length(5); // Object, key number equals 5\n\n\nRuleType.array().items(RuleType.string()); //Array, each element is a string\nRuleType.array().max(10); // Array, maximum length is 10\nRuleType.array().min(10); //Array, minimum length is 10\nRuleType.array().length(10); // Array, length 10\n\nRuleType.string().allow('') // non-required fields pass in an empty string\n")),(0,r.kt)("h3",{id:"cascade-check"},"Cascade Check"),(0,r.kt)("p",null,"Midway supports that the attribute in the Class for each check is still an object."),(0,r.kt)("p",null,"We add an attribute ",(0,r.kt)("inlineCode",{parentName:"p"},"school")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"UserDTO")," and give a ",(0,r.kt)("inlineCode",{parentName:"p"},"SchoolDTO")," type."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Rule, RuleType } from '@midwayjs/validate';\n\nexport class SchoolDTO {\n  @Rule(RuleType.string().required())\n  name: string;\n  @Rule(RuleType.string())\n  address: string;\n}\n\nexport class UserDTO {\n  @Rule(RuleType.number().required())\n  id: number;\n\n  @Rule(RuleType.string().required())\n  firstName: string;\n\n  @Rule(RuleType.string().max(10))\n  lastName: string;\n\n  // Complex object\n  @Rule(getSchema(SchoolDTO).required())\n  school: SchoolDTO;\n\n  // Object array.\n  @Rule(RuleType.array().items(getSchema(SchoolDTO)).required())\n  schoolList: SchoolDTO[];\n}\n")),(0,r.kt)("p",null,"In this case, the parameter of the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Rule")," decorator can be the type that needs to be verified."),(0,r.kt)("h3",{id:"inheritance-check"},"Inheritance check"),(0,r.kt)("p",null,"Midway supports the verification inheritance method, which allows developers to verify parameters when they extract common object attributes."),(0,r.kt)("p",null,"For example, we ",(0,r.kt)("inlineCode",{parentName:"p"},"CommonUserDTO")," the following to extract some common attributes of the interface, and then ",(0,r.kt)("inlineCode",{parentName:"p"},"UserDTO")," specific parameters required as special interfaces."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Rule, RuleType } from '@midwayjs/validate';\n\nexport class CommonUserDTO {\n  @Rule(RuleType.string().required())\n  token: string;\n  @Rule(RuleType.string())\n  workId: string;\n}\n\nexport class UserDTO extends CommonUserDTO {\n\n  @Rule(RuleType.string().required())\n  name: string;\n}\n")),(0,r.kt)("p",null,"The old version needs to be added to the subclass, the new version does not need ~"),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"If the attribute name is the same, the rule of the current attribute is taken for verification and will not be merged with the parent class.")),(0,r.kt)("h3",{id:"multi-type-verification"},"Multi-type verification"),(0,r.kt)("p",null,"Starting from v3.4.5, Midway supports different types of verification for a certain attribute."),(0,r.kt)("p",null,"For example, a type can be either a normal type or a complex type."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Rule, RuleType, getSchema } from '@midwayjs/validate';\n\nexport class SchoolDTO {\n  @Rule(RuleType.string().required())\n  name: string;\n  @Rule(RuleType.string())\n  address: string;\n}\n\nexport class UserDTO {\n\n  @Rule(RuleType.string().required())\n  name: string;\n\n  @Rule(RuleType.alternatives([RuleType.string(), getSchema(SchoolDTO)]).required())\n  school: string | SchoolDTO;\n}\n")),(0,r.kt)("p",null,"We can use ",(0,r.kt)("inlineCode",{parentName:"p"},"getSchema")," methods to get the current joi schema from a DTO to perform complex logical processing."),(0,r.kt)("h3",{id:"create-a-new-dto-from-the-original-dto"},"Create a new DTO from the original DTO"),(0,r.kt)("p",null,"Sometimes, we want to get some attributes from a DTO and become a new DTO class."),(0,r.kt)("p",null,"Midway provides ",(0,r.kt)("inlineCode",{parentName:"p"},"PickDto")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"OmitDto")," methods to create a new DTO based on the existing DTO type."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"PickDto")," is used to get some attributes from the existing DTO and become the new DTO, while the ",(0,r.kt)("inlineCode",{parentName:"p"},"OmitDto")," is used to remove some of them, such:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/dto/user.ts\nimport { Rule, RuleType, PickDto } from '@midwayjs/validate';\n\nexport class UserDTO {\n  @Rule(RuleType.number().required())\n  id: number;\n\n  @Rule(RuleType.string().required())\n  firstName: string;\n\n  @Rule(RuleType.string().max(10))\n  lastName: string;\n\n  @Rule(RuleType.number().max(60))\n  age: number;\n}\n\n// Inherit a new DTO\nexport class SimpleUserDTO extends PickDto(UserDTO, ['firstName', 'lastName']) {}\n\n// const simpleUser = new SimpleUserDTO();\n// Contains only firstName and lastName attributes\n// simpleUser.firstName = xxx\n\nexport class NewUserDTO extends OmitDto(UserDTO, ['age']) {}\n\n// const newUser = new NewUserDTO();\n// newUser.age definition and attribute do not exist\n\n// Use\nasync login(@Body() user: NewUserDTO) {\n  // ...\n}\n\n")),(0,r.kt)("h3",{id:"reuse-verification-rules"},"Reuse verification rules"),(0,r.kt)("p",null,"If many fields are required for strings or similar requirements, writing the ",(0,r.kt)("inlineCode",{parentName:"p"},"RuleType.string().required()")," is a bit long, and the duplicate part can be assigned to a new rule object for reuse."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"\n// Define your department's specifications or commonly used ones in a document yourself.\nconst requiredString = RuleType.string().required();\n\nexport class UserDTO {\n\n  @Rule(requiredString) // So you don't have to write it so long\n  name: string;\n\n  @Rule(requiredString) // Same as above\n  nickName: string;\n\n  @Rule(requiredString) // Same as above\n  description: string;\n}\n\n// Define your department's specifications or commonly used ones in a document yourself.\nconst maxString = (length)=> RuleType.string().max(length);\n\nexport class UserDTO {\n\n  @Rule(requiredString) // Same as above\n  name: string;\n\n  @Rule(requiredString) // Same as above\n  nickName: string;\n\n  @Rule(requiredString) // Same as above\n  description: string;\n\n  @Rule(maxString(50)) // This way, you can change the parameter\n  info: string;\n\n  @Rule(maxString(50).required()) // This will do\n  info2: string;\n}\n")),(0,r.kt)("h2",{id:"multilingual"},"Multilingual"),(0,r.kt)("p",null,"In Validate, the ",(0,r.kt)("a",{parentName:"p",href:"./i18n"},"i18n")," component is also relied on to internationalize check messages."),(0,r.kt)("p",null,"By default, both ",(0,r.kt)("inlineCode",{parentName:"p"},"en_US")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"zh_CN")," are available. When a request fails, the specified language is returned."),(0,r.kt)("h3",{id:"specify-the-language-through-the-decorator"},"Specify the language through the decorator"),(0,r.kt)("p",null,"By default, messages will be returned following the ",(0,r.kt)("inlineCode",{parentName:"p"},"defaultLocale")," of i18n components and the browser's access language. However, we can specify the currently translated language in the decorator, such:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"@Controller('/user')\nexport class UserController {\n  @Post('/')\n  @Validate({\n    locale: 'en_US',\n  })\n  async getUser(@Body() bodyData: UserDTO) {\n    // ...\n  }\n}\n\n")),(0,r.kt)("h3",{id:"specify-language-through-parameters"},"Specify language through parameters"),(0,r.kt)("p",null,"In addition to decorator designation, we can also use the standard i18n to specify the language through parameters."),(0,r.kt)("p",null,"For example, Query parameters."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Get /user/get_user?locale=zh_CN\n")),(0,r.kt)("p",null,"For more information, see ",(0,r.kt)("a",{parentName:"p",href:"./i18n"},"i18n"),"."),(0,r.kt)("h3",{id:"translation-in-other-languages"},"Translation in other languages"),(0,r.kt)("p",null,"By default, Midway provides both ",(0,r.kt)("inlineCode",{parentName:"p"},"en_US")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"zh_CN")," translations. If additional translations are required, you can configure them in i18n."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  i18n: {\n    // Add translation\n    zh_TW: {\n      validate: require('../../locales/zh_TW.json')\n    },\n  }\n}\n")),(0,r.kt)("p",null,"If possible, we hope you will submit the translation to Midway for everyone to use."),(0,r.kt)("h2",{id:"custom-error-text"},"Custom error text"),(0,r.kt)("h3",{id:"specifies-the-text-of-a-single-rule"},"Specifies the text of a single rule"),(0,r.kt)("p",null,"If you only want to define an error message for a rule in a DTO, you can simply specify."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export class UserDTO {\n  @Rule(RuleType.number().required().error(new Error('my custom message')))\n  id: number;\n}\n")),(0,r.kt)("p",null,"All rules on this ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," attribute will return a custom message if the verification fails."),(0,r.kt)("h3",{id:"global-specify-partial-text"},"Global Specify Partial Text"),(0,r.kt)("p",null,"By configuring the ",(0,r.kt)("inlineCode",{parentName:"p"},"validate")," multilingual text table of the i18n component, you can selectively replace most of the check text, and all rules will apply the text."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  i18n: {\n    // Put your translated text here\n    localeTable: {\n      zh_CN: {\n        validate: {\n          'string. Max': 'Hello World',\n        },\n      },\n    },\n  }\n}\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"validate")," here is the language table keyword configured by the ",(0,r.kt)("inlineCode",{parentName:"p"},"@midwayjs/validate")," component in the i18n component."),(0,r.kt)("p",null,"Because the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/midwayjs/midway/tree/main/packages/validate/locales"},"default language table")," is also in the form of an object, we can easily find the fields and replace them."),(0,r.kt)("p",null,"Since these texts distinguish languages, they need to be handled carefully, for example, replacing different languages."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  i18n: {\n    // Put your translated text here\n    localeTable: {\n      zh_CN: {\n        validate: {\n          'string.max': '\u5b57\u7b26\u8d85\u957f',\n        },\n      },\n      en_US: {\n        validate: {\n          'string.max': 'string is too long',\n        },\n      },\n    },\n  }\n}\n")),(0,r.kt)("h3",{id:"fully-customize-error-text"},"Fully customize error text"),(0,r.kt)("p",null,"If you want to completely customize the wrong text, you can solve it by replacing the built-in language translation text."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  i18n: {\n    localeTable: {\n      // Replace Chinese translation\n      zh_CN: {\n        validate: require('../../locales/custom.json'),\n      },\n    },\n  }\n}\n")),(0,r.kt)("h2",{id:"default-configuration"},"Default configuration"),(0,r.kt)("p",null,"We can do some configuration for validate components."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Configuration Item"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"errorStatus"),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"When the verification error occurs, the returned Http status code takes effect in the http scenario. The default 422")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"locale"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"The default language for verifying the error text. Currently, there are two languages: ",(0,r.kt)("inlineCode",{parentName:"td"},"en_US")," and ",(0,r.kt)("inlineCode",{parentName:"td"},"zh_CN"),". The default language is ",(0,r.kt)("inlineCode",{parentName:"td"},"en_US"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"validationOptions"),(0,r.kt)("td",{parentName:"tr",align:null},"Joi's ValidationOptions options"),(0,r.kt)("td",{parentName:"tr",align:null},"Commonly used options are allowUnknown, stripUnknown and other options. If configured, the global validation allows undefined fields to appear. For more information, please see joi's ","[ValidationOptions option]","(",(0,r.kt)("a",{parentName:"td",href:"https://joi.dev/api/?v="},"https://joi.dev/api/?v=")," 17.6.0#anyvalidatevalue-options).")))),(0,r.kt)("h2",{id:"independent-verification-service"},"Independent verification service"),(0,r.kt)("p",null,"The bottom layer of the component provides a single instance of ",(0,r.kt)("inlineCode",{parentName:"p"},"ValidateService")," verification service class, which can be used in middleware or independent services if necessary. In fact, all the verification decorators will eventually go to this method."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"ValidateService")," provides a ",(0,r.kt)("inlineCode",{parentName:"p"},"validate")," method for verifying DTO."),(0,r.kt)("p",null,"Let's take the ",(0,r.kt)("inlineCode",{parentName:"p"},"UserDTO")," defined above as an example."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { ValidateService } from '@midwayjs/validate';\n\nexport class UserService {\n\n  @Inject()\n  validateService: ValidateService;\n\n  async inovke() {\n\n    // ...\n    const result = this.validateService.validate(UserDTO, {\n      name: 'harry',\n      nickName: 'harry'\n    });\n\n    // Failed to return to re. Error\n    // Successfully returned result.value\n  }\n}\n")),(0,r.kt)("p",null,"The result returned by the ",(0,r.kt)("inlineCode",{parentName:"p"},"validate")," method contains two attributes: ",(0,r.kt)("inlineCode",{parentName:"p"},"error")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"value"),". Failure will return a ",(0,r.kt)("inlineCode",{parentName:"p"},"MidwayValidationError")," error, and success will return a formatted DTO object."),(0,r.kt)("h2",{id:"frequently-asked-questions"},"Frequently Asked Questions"),(0,r.kt)("h3",{id:"1-allow-undefined-fields"},"1. Allow undefined fields"),(0,r.kt)("p",null,"Since some users want to allow undefined fields during parameter verification, they can be set separately on the global configuration and decorator. The former takes effect on the global and the latter takes effect on a single verification."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  validate: {\n    validationOptions: {\n      allowUnknown: true, // global takes effect\n    }\n  }\n}\n")),(0,r.kt)("p",null,"Or on the decorator."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"@Controller('/api/user')\nexport class HomeController {\n\n  @Post('/')\n  @Validate({\n    validationOptions: {\n      allowUnknown: true\n    }\n  })\n  async updateUser(@Body() user: UserDTO ) {\n    // user.id\n  }\n}\n")),(0,r.kt)("h3",{id:"2-remove-undefined-attributes-from-parameters"},"2. Remove undefined attributes from parameters"),(0,r.kt)("p",null,"It is also a validationOptions attribute, which can directly eliminate some attributes in the passed-in parameters."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  validate: {\n    validationOptions: {\n      stripUnknown: true, // global takes effect\n    }\n  }\n}\n")),(0,r.kt)("p",null,"Or on the decorator."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"@Controller('/api/user')\nexport class HomeController {\n\n  @Post('/')\n  @Validate({\n    validationOptions: {\n      stripUnknown: true\n    }\n  })\n  async updateUser(@Body() user: UserDTO ) {\n  }\n}\n")),(0,r.kt)("h3",{id:"3-handling-verification-errors"},"3. Handling verification errors"),(0,r.kt)("p",null,"As mentioned above, Midway will throw ",(0,r.kt)("inlineCode",{parentName:"p"},"MidwayValidationError")," error when the check fails, which we can handle in the ",(0,r.kt)("a",{parentName:"p",href:"../error_filter"},"exception handler"),"."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/filter/validate.filter\nimport { Catch } from '@midwayjs/core';\nimport { MidwayValidationError } from '@midwayjs/validate';\nimport { Context } from '@midwayjs/koa';\n\n@Catch(MidwayValidationError)\nexport class ValidateErrorFilter {\n  async catch(err: MidwayValidationError, ctx: Context) {\n    // ...\n    return {\n      status: 422\n      message: 'Check parameter error,' + err.message\n    }\n  }\n}\n")),(0,r.kt)("h3",{id:"4-temporarily-disable-global-verification"},"4. Temporarily disable global verification"),(0,r.kt)("p",null,"After the component is enabled, as long as the parameter uses DTO, it will be automatically verified. If a parameter does not need to be verified temporarily, you can use the following writing method."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"@Controller('/api/user')\nexport class HomeController {\n\n  @Post('/')\n  async updateUser(@Body() user: Partial<UserDTO> ) {\n  }\n}\n")))}c.isMDXComponent=!0}}]);