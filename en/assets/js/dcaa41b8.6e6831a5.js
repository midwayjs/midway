"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[77745],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=r.createContext({}),p=function(e){var t=r.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=p(e.components);return r.createElement(i.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=p(n),u=a,h=c["".concat(i,".").concat(u)]||c[u]||m[u]||o;return n?r.createElement(h,l(l({ref:t},d),{},{components:n})):r.createElement(h,l({ref:t},d))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,l=new Array(o);l[0]=u;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s[c]="string"==typeof e?e:a,l[1]=s;for(var p=2;p<o;p++)l[p]=n[p];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},39467:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>k,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var r=n(87462),a=(n(67294),n(3905));const o={},l=void 0,s={unversionedId:"controller",id:"controller",title:"controller",description:"\u200b\timport Tabs from '@theme/Tabs';",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/controller.md",sourceDirName:".",slug:"/controller",permalink:"/en/docs/controller",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/controller.md",tags:[],version:"current",frontMatter:{},sidebar:"common",previous:{title:"Create the first application",permalink:"/en/docs/quickstart"},next:{title:"Web middleware",permalink:"/en/docs/middleware"}},i={},p=[{value:"Routing",id:"routing",level:2},{value:"Routing method",id:"routing-method",level:2},{value:"Get request parameters",id:"get-request-parameters",level:2},{value:"Decorator parameter conventions",id:"decorator-parameter-conventions",level:3},{value:"Query",id:"query",level:3},{value:"Body",id:"body",level:3},{value:"Router Params",id:"router-params",level:3},{value:"Header",id:"header",level:3},{value:"Cookie",id:"cookie",level:3},{value:"Session",id:"session",level:3},{value:"Uploaded file",id:"uploaded-file",level:3},{value:"Other parameters",id:"other-parameters",level:3},{value:"Custom request parameter decorator",id:"custom-request-parameter-decorator",level:3},{value:"Request parameter type conversion",id:"request-parameter-type-conversion",level:2},{value:"Parameter verification",id:"parameter-verification",level:2},{value:"Set HTTP response",id:"set-http-response",level:2},{value:"Set the return value",id:"set-the-return-value",level:3},{value:"Set status code",id:"set-status-code",level:3},{value:"Set response header",id:"set-response-header",level:3},{value:"Redirection",id:"redirection",level:3},{value:"Response type",id:"response-type",level:3},{value:"Streaming response",id:"streaming-response",level:3},{value:"Internal redirection",id:"internal-redirection",level:2},{value:"Global route prefix",id:"global-route-prefix",level:2},{value:"Routing priority",id:"routing-priority",level:2}],d=e=>function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,a.kt)("div",t)},c=d("Tabs"),m=d("TabItem"),u={toc:p},h="wrapper";function k(e){let{components:t,...n}=e;return(0,a.kt)(h,(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"\u200b\timport Tabs from '@theme/Tabs';\nimport TabItem from '@theme/TabItem';"),(0,a.kt)("h1",{id:"routing-and-controller"},"Routing and controller"),(0,a.kt)("p",null,"In the common MVC architecture, C represents the controller, which is responsible for ",(0,a.kt)("strong",{parentName:"p"},"parsing the user's input and returning the corresponding results after processing.")),(0,a.kt)("p",null,'As shown in the figure, the client requests the controller of the server through the Http protocol, and the controller responds to the client after processing. This is the most basic "request-response" process.'),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://img.alicdn.com/imgextra/i1/O1CN01dYitV22ADuagILnp3_!!6000000008170-2-tps-1600-634.png",alt:"controller"})),(0,a.kt)("p",null,"Common ones are:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"In the ",(0,a.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Representational_state_transfer"},"RESTful")," interface, the controller accepts the user's parameters, returns the contents from the database to the user, or updates the user's request to the database."),(0,a.kt)("li",{parentName:"ul"},"In the HTML page request, the controller renders different templates to obtain HTML and returns it to the user according to the user's access to different URLs."),(0,a.kt)("li",{parentName:"ul"},"In a proxy server, the controller forwards the user's request to other servers and returns the processing results of other servers to the user.")),(0,a.kt)("p",null,"Generally speaking, the controller is often used to verify, convert, and call complex business logic on the user's request parameters, assemble the data after getting the corresponding business results, and then return."),(0,a.kt)("p",null,"In Midway, controllers ",(0,a.kt)("strong",{parentName:"p"},"also carry routing capabilities"),". Each controller can provide multiple routes, and different routes can perform different operations."),(0,a.kt)("p",null,"In the following example, we will demonstrate how to create a route in the controller."),(0,a.kt)("h2",{id:"routing"},"Routing"),(0,a.kt)("p",null,"Controller files are generally in the ",(0,a.kt)("inlineCode",{parentName:"p"},"src/controller")," directory, where we can create controller files. Midway annotates controllers with the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Controller()")," decorator, where the decorator has an optional parameter for route prefix (grouping), so that all routes under this controller will carry this prefix."),(0,a.kt)("p",null,"At the same time, Midway provides a method decorator for marking the type of request."),(0,a.kt)("p",null,"For example, we create a homepage controller to return a default",(0,a.kt)("inlineCode",{parentName:"p"},"/"),"route."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"\u279c  my_midway_app tree\n.\n\u251c\u2500\u2500 src\n\u2502   \u2514\u2500\u2500 controller\n\u2502       \u2514\u2500\u2500 home.ts\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 tsconfig.json\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/home.ts\n\nimport { Controller, Get } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n\n  @Get('/')\n  async home() {\n    return \"Hello Midwayjs!\";\n  }\n}\n\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"@Controller")," decorator tells the framework that this is a class of type Web Controller, and the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Get")," decorator tells the framework that the decorated ",(0,a.kt)("inlineCode",{parentName:"p"},"home")," method will be exposed as a ",(0,a.kt)("inlineCode",{parentName:"p"},"/")," route, which can be accessed by ",(0,a.kt)("inlineCode",{parentName:"p"}," GET")," request to access."),(0,a.kt)("p",null,"The whole method returns a string, and in the browser you will receive the response type of ",(0,a.kt)("inlineCode",{parentName:"p"},"text/plain")," and a ",(0,a.kt)("inlineCode",{parentName:"p"},"200")," status code."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Routing methods are all async methods.")),(0,a.kt)("h2",{id:"routing-method"},"Routing method"),(0,a.kt)("p",null,"In the preceding example, you have created a ",(0,a.kt)("strong",{parentName:"p"},"GET")," route. In general, we will have other HTTP Methods, Midway provides more routing method decorators."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/home.ts\n\nimport { Controller, Get, Post } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n\n  @Get('/')\n  async home() {\n    return 'Hello Midwayjs!';\n  }\n\n  @Post('/update')\n  async updateData() {\n    return 'This is a post method'\n  }\n}\n\n")),(0,a.kt)("p",null,"Midway also provides other decorators, such as ",(0,a.kt)("inlineCode",{parentName:"p"},"@Get"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"@Post"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"@Put()"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"@Del()"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"@Patch()"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"@Options()"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"@Head()"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},"@All()"),"."),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"@All")," decorator is special, indicating that it can accept all types of HTTP methods."),(0,a.kt)("p",null,"You can bind multiple routes to the same method."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"@Get('/')\n@Get('/main')\nasync home() {\n  return 'Hello Midwayjs!';\n}\n")),(0,a.kt)("h2",{id:"get-request-parameters"},"Get request parameters"),(0,a.kt)("p",null,"Next, we will create an HTTP API about users. Similarly, we will create a ",(0,a.kt)("inlineCode",{parentName:"p"},"src/controller/user.ts")," file. This time we will add a routing prefix and more request types."),(0,a.kt)("p",null,"Let's take the user type as an example, first add a user type, and we usually put the defined content in the ",(0,a.kt)("inlineCode",{parentName:"p"},"src/interface.ts")," file."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"\u279c  my_midway_app tree\n.\n\u251c\u2500\u2500 src\n\u2502   \u251c\u2500\u2500 controller\n\u2502   \u2502   \u251c\u2500\u2500 user.ts\n\u2502   \u2502   \u2514\u2500\u2500 home.ts\n\u2502   \u2514\u2500\u2500 interface.ts\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 tsconfig.json\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/interface.ts\nexport interface User {\n  id: number;\n  name: string;\n  age: number;\n}\n")),(0,a.kt)("p",null,"Add a route prefix and the corresponding controller."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/user.ts\n\nimport { Controller } from '@midwayjs/core';\n\n@Controller('/api/user')\nexport class UserController {\n  // xxxx\n}\n\n")),(0,a.kt)("p",null,"Next, we will call different processing logic for different request types. Except for the request type, the requested data is generally dynamic and will be passed at different locations in HTTP, such as common Query,Body, etc."),(0,a.kt)("h3",{id:"decorator-parameter-conventions"},"Decorator parameter conventions"),(0,a.kt)("p",null,"Midway adds a common decorator for dynamic values. Take the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Query")," decorator as an example. The ",(0,a.kt)("inlineCode",{parentName:"p"},"@Query")," decorator obtains the query parameters in the URL and assigns them to the input parameters of the function. In the following example, the id is obtained from the query parameter of the route. If the URL is ",(0,a.kt)("inlineCode",{parentName:"p"},"/?id = 1"),", the value of the id is 1. At the same time, the route returns an object of the ",(0,a.kt)("inlineCode",{parentName:"p"},"User")," type."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/user.ts\n\nimport { Controller, Get, Query } from '@midwayjs/core';\n\n@Controller('/api/user')\nexport class UserController {\n  @Get('/')\n  async getUser(@Query('id') id: string): Promise<User> {\n    // xxxx\n  }\n}\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"@Query")," decorator has a parameter. You can pass in a specified string key to obtain the corresponding value and assign the value to the input parameter. If the parameter is not passed in, the entire query object is returned by default."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'// URL = /?id=1\nasync getUser(@Query(\'id\') id: string) // id = 1\nasync getUser(@Query() queryData) // {"id": "1"}\n')),(0,a.kt)("p",null,"Midway provides more decorators that get values from Query, Body, Header, etc., which are all out of the box and adapted to different upper-level Web frameworks."),(0,a.kt)("p",null,"The following are these decorators and the corresponding equivalent frame values."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Decorator"),(0,a.kt)("th",{parentName:"tr",align:null},"Express the corresponding method"),(0,a.kt)("th",{parentName:"tr",align:null},"Corresponding method of Koa/EggJS"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"@Session(key?: string)"),(0,a.kt)("td",{parentName:"tr",align:null},"req.session / req.session ","[key]"),(0,a.kt)("td",{parentName:"tr",align:null},"ctx.session / ctx.session ","[key]")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"@Param(key?: string)"),(0,a.kt)("td",{parentName:"tr",align:null},"req.params / req.params ","[key]"),(0,a.kt)("td",{parentName:"tr",align:null},"ctx.params / ctx.params ","[key]")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"@Body(key?: string)"),(0,a.kt)("td",{parentName:"tr",align:null},"req.body / req.body ","[key]"),(0,a.kt)("td",{parentName:"tr",align:null},"ctx.request.body / ctx.request.body ","[key]")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"@Query(key?: string)"),(0,a.kt)("td",{parentName:"tr",align:null},"req.query / req.query ","[key]"),(0,a.kt)("td",{parentName:"tr",align:null},"ctx.query / ctx.query","[key]")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"@Queries(key?: string)"),(0,a.kt)("td",{parentName:"tr",align:null},"-"),(0,a.kt)("td",{parentName:"tr",align:null},"-/ctx.queries ","[key]")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"@Headers(name?: string)"),(0,a.kt)("td",{parentName:"tr",align:null},"req.headers / req.headers ","[name]"),(0,a.kt)("td",{parentName:"tr",align:null},"ctx.headers / ctx.headers ","[name]")))),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},(0,a.kt)("strong",{parentName:"p"},"Note")," @Queries decorator is ",(0,a.kt)("strong",{parentName:"p"},"different from")," @Query."),(0,a.kt)("p",{parentName:"admonition"},"Queries will aggregate the same keys together and become an array. When the interface parameter accessed by the user is ",(0,a.kt)("inlineCode",{parentName:"p"},"/? When name = a & name = B"),", @Queries will return {name: ","[a, B]"," }, while Query will only return {name: B}")),(0,a.kt)("h3",{id:"query"},"Query"),(0,a.kt)("p",null,"The part after ",(0,a.kt)("inlineCode",{parentName:"p"},"?")," in the URL is a Query String, which is often used to pass parameters in GET type requests."),(0,a.kt)("p",null,"For example"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"GET /user?uid=1&sex=male\n")),(0,a.kt)("p",null,"It is the parameter passed by the user."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Get from Decorator")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/user.ts\nimport { Controller, Get, Query } from '@midwayjs/core';\n\n@Controller('/user')\nexport class UserController {\n  @Get('/')\n  async getUser(@Query('uid') uid: string): Promise<User> {\n    // xxxx\n  }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Get from an API operation")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/user.ts\nimport { Controller, Get, Inject } from '@midwayjs/core';\nimport { Context } from '@midwayjs/koa';\n\n@Controller('/user')\nexport class UserController {\n\n  @Inject()\n  ctx: Context;\n\n  @Get('/')\n  async getUser(): Promise<User> {\n    const query = this.ctx.query;\n    // {\n    //   uid: '1',\n    // sex: 'male',\n    //}\n  }\n}\n")),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},(0,a.kt)("strong",{parentName:"p"},"Note")," EggJS is different from other frameworks. When the key in the Query String is repeated, ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.query")," only takes the value of the first occurrence of the key, and subsequent occurrences will be ignored."),(0,a.kt)("p",{parentName:"admonition"},"For example, the value obtained by ",(0,a.kt)("inlineCode",{parentName:"p"},"GET /user?uid=1&uid=2")," through ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.query")," is ",(0,a.kt)("inlineCode",{parentName:"p"},"{ uid: '1' }"),".")),(0,a.kt)("h3",{id:"body"},"Body"),(0,a.kt)("p",null,"Although we can pass parameters through the URL, there are still many limitations:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"http://stackoverflow.com/questions/417142/what-is-the-maximum-length-of-a-url-in-different-browsers"},"The length of the URL is limited in the browser"),". If there are too many parameters to pass, the URL cannot be passed."),(0,a.kt)("li",{parentName:"ul"},"The server often records the complete URL of the access to the log file, and it is unsafe to pass some sensitive data through the URL.")),(0,a.kt)("p",null,"In the previous HTTP request message example, we saw that there is a body part after the header, and we usually pass the parameters of POST, PUT, DELETE and other methods in this part. When there is a body in a general request, the client (browser) will send a ",(0,a.kt)("inlineCode",{parentName:"p"},"Content-Type")," at the same time to tell the server what format the body of this request is. The two most commonly used data delivery formats in Web development are ",(0,a.kt)("inlineCode",{parentName:"p"},"JSON")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"Form"),"."),(0,a.kt)("p",null,"The framework has built-in ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/koajs/bodyparser"},"bodyParser")," middleware to parse requests in these two formats into objects and mount them to ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.request.body"),". HTTP protocol does not recommend passing body when accessing through GET and HEAD methods, so we cannot obtain content according to this method in GET and HEAD methods."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Get a single body")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/user.ts\n// POST /user/ HTTP/1.1\n// Host: localhost:3000\n// Content-Type: application/json; charset=UTF-8\n//\n// {\"uid\": \"1\", \"name\": \"harry\"}\nimport { Controller, Post, Body } from '@midwayjs/core';\n\n@Controller('/user')\nexport class UserController {\n  @Post('/')\n  async updateUser(@Body('uid') uid: string): Promise<User> {\n    // id is equivalent to ctx.request.body.uid\n  }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Get the entire body")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/user.ts\n// POST /user/ HTTP/1.1\n// Host: localhost:3000\n// Content-Type: application/json; charset=UTF-8\n//\n// {\"uid\": \"1\", \"name\": \"harry\"}\nimport { Controller, Post, Body } from '@midwayjs/core';\n\n@Controller('/user')\nexport class UserController {\n  @Post('/')\n  async updateUser(@Body() user: User): Promise<User> {\n    // user is equivalent to the entire body object of ctx.request.body\n    // => output user\n    // {\n    //   uid: '1',\n    //   name: 'harry',\n    // }\n  }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Get from an API operation")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/user.ts\n// POST /user/ HTTP/1.1\n// Host: localhost:3000\n// Content-Type: application/json; charset=UTF-8\n//\n// {\"uid\": \"1\", \"name\": \"harry\"}\nimport { Controller, Post, Inject } from '@midwayjs/core';\nimport { Context } from '@midwayjs/koa';\n\n@Controller('/user')\nexport class UserController {\n\n  @Inject()\n  ctx: Context;\n\n  @Post('/')\n  async getUser(): Promise<User> {\n    const body = this.ctx.request.body;\n    // {\n    // uid: '1',\n    // name: 'harry',\n    //}\n  }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Obtain query and body parameters")),(0,a.kt)("p",null,"Decorators can be used in combination."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"@Post('/')\nasync updateUser(@Body() user: User, @Query('pageIdx') pageIdx: number): Promise<User> {\n  // user gets it from body\n  // pageIdx obtained from query\n}\n")),(0,a.kt)("p",null,"The framework sets some default parameters for the bodyParser. After configuration, it has the following features:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If the request Content-Type is ",(0,a.kt)("inlineCode",{parentName:"li"},"application/json"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"application/json-patch + json"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"application/vnd.api + json"),", and ",(0,a.kt)("inlineCode",{parentName:"li"},"csp-report"),", the request body is parsed in json format and the maximum length of the body is limited to ",(0,a.kt)("inlineCode",{parentName:"li"},"1mb"),"."),(0,a.kt)("li",{parentName:"ul"},"When the request Content-Type is ",(0,a.kt)("inlineCode",{parentName:"li"},"application/x-www-form-urlencoded"),", the request body is parsed in the form format and the maximum length of the body is limited to ",(0,a.kt)("inlineCode",{parentName:"li"},"1mb"),"."),(0,a.kt)("li",{parentName:"ul"},"If the parsing is successful, the body must be an Object (possibly an array).")),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},"Common errors: ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.request.body")," is confused with ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.body"),", which is the abbreviation of ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.response.body"),".")),(0,a.kt)("h3",{id:"router-params"},"Router Params"),(0,a.kt)("p",null,"If the route is declared in the ",(0,a.kt)("inlineCode",{parentName:"p"},":xxx")," format, you can use ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.params")," to obtain the parameters."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Get from Decorator")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/user.ts\n// GET /user/1\nimport { Controller, Get, Param } from '@midwayjs/core';\n\n@Controller('/user')\nexport class UserController {\n  @Get('/:uid')\n  async getUser(@Param('uid') uid: string): Promise<User> {\n    // xxxx\n  }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Get from an API operation")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/user.ts\n// GET /user/1\nimport { Controller, Get, Inject } from '@midwayjs/core';\nimport { Context } from '@midwayjs/koa';\n\n@Controller('/user')\nexport class UserController {\n\n  @Inject()\n  ctx: Context;\n\n  @Get('/:uid')\n  async getUser(): Promise<User> {\n    const params = this.ctx.params;\n    // {\n    // uid: '1',\n    //}\n  }\n}\n")),(0,a.kt)("h3",{id:"header"},"Header"),(0,a.kt)("p",null,"In addition to getting parameters from the URL and request body, many parameters are passed through the request header. The framework provides some auxiliary properties and methods to obtain."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ctx.headers"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"ctx.header"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"ctx.request.headers"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"ctx.request.header"),": These methods are equivalent to obtaining the entire header object."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ctx.get(name)"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"ctx.request.get(name)"),": Gets the value of a field in the request header. If this field does not exist, an empty string is returned."),(0,a.kt)("li",{parentName:"ul"},"We recommend using ",(0,a.kt)("inlineCode",{parentName:"li"},"ctx.get(name)")," instead of ",(0,a.kt)("inlineCode",{parentName:"li"},"ctx.headers['name']"),", because the former will automatically handle case.")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Get from Decorator")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/user.ts\n// GET /user/1\nimport { Controller, Get, Headers } from '@midwayjs/core';\n\n@Controller('/user')\nexport class UserController {\n  @Get('/:uid')\n  async getUser(@Headers('cache-control') cacheSetting: string): Promise<User> {\n    // no-cache\n    // ...\n  }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Get from an API operation")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller/user.ts\n// GET /user/1\nimport { Controller, Get, Inject } from '@midwayjs/core';\nimport { Context } from '@midwayjs/koa';\n\n@Controller('/user')\nexport class UserController {\n\n  @Inject()\n  ctx: Context;\n\n  @Get('/:uid')\n  async getUser(): Promise<User> {\n    const cacheSetting = this.ctx.get('cache-control');\n    // no-cache\n  }\n}\n")),(0,a.kt)("h3",{id:"cookie"},"Cookie"),(0,a.kt)("p",null,"HTTP requests are stateless, but our Web applications usually need to know who initiated the request. To solve this problem, HTTP protocol designs a special request header: ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/HTTP_cookie"},"Cookie"),". The server can respond to a small amount of data to the client through the response header (set-cookie). The browser will follow the protocol to save the data and bring it with it when requesting the same service next time (the browser will also follow the protocol and only bring the corresponding cookie when visiting websites that meet the cookie specified rules to ensure security)."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"ctx.cookies")," allows us to set and read Cookie conveniently and safely in our Controller."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Inject, Controller, Get, Provide } from '@midwayjs/core';\nimport { Context } from '@midwayjs/koa';\n\n@Controller('/')\nexport class HomeController {\n  @Inject()\n  ctx: Context;\n\n  @Get('/')\n  async home() {\n    // set cookie\n    this.ctx.cookies.set('foo', 'bar', { encrypt: true });\n    // get cookie\n    this.ctx.cookies.get('foo', { encrypt: true });\n  }\n}\n")),(0,a.kt)("p",null,"Although a cookie is only a header in HTTP, you can set multiple key-value pairs in the format of ",(0,a.kt)("inlineCode",{parentName:"p"},"foo = bar;foo1 = bar1;"),"."),(0,a.kt)("p",null,"Cookie often plays a role in transmitting client identity information in Web applications. Therefore, there are many security-related configurations that cannot be ignored. The ",(0,a.kt)("a",{parentName:"p",href:"cookie_session#Default-Cookies"},"Cookie")," document describes the usage of cookies and security-related configuration items in detail."),(0,a.kt)("h3",{id:"session"},"Session"),(0,a.kt)("p",null,"Through Cookie, we can set a Session for each user to store information related to the user's identity. This information will be encrypted and stored in Cookie to maintain the user's identity across requests."),(0,a.kt)("p",null,"The framework has built-in ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/midwayjs/midway/tree/main/packages/session"},"Session")," plug-ins, which provide us with ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.session")," to access or modify the current user Session."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Inject, Controller, Get, Provide } from '@midwayjs/core';\nimport { Context } from '@midwayjs/koa';\n\n@Controller('/')\nexport class HomeController {\n  @Inject()\n  ctx: Context;\n\n  @Get('/')\n  async home() {\n    // Get the content on the Session\n    const userId = this.ctx.session.userId;\n    const posts = await this.ctx.service.post.fetch(userId);\n    // Modify the value of the Session\n    this.ctx.session.visited = ctx.session.visited? (ctx.session.visited + 1) : 1;\n    // ...\n  }\n}\n")),(0,a.kt)("p",null,"The use of the Session is very intuitive, just read it directly or modify it. If you want to delete it, assign it ",(0,a.kt)("inlineCode",{parentName:"p"},"null")," directly:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"ctx.session = null;\n")),(0,a.kt)("p",null,"Like Cookie, Session also has many security options and functions. It is better to read ","[Session]","(cookie_session# Default-session) documents for further understanding before using them."),(0,a.kt)("h3",{id:"uploaded-file"},"Uploaded file"),(0,a.kt)("p",null,"Generally, the ",(0,a.kt)("inlineCode",{parentName:"p"},"multipart/form-data")," protocol header is used to obtain the uploaded files by the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Files")," decorator. The upload function is provided by the upload component. For more information, see ",(0,a.kt)("a",{parentName:"p",href:"./extensions/upload"},"upload component"),"."),(0,a.kt)("h3",{id:"other-parameters"},"Other parameters"),(0,a.kt)("p",null,"There are also some more common parameter decorators and their corresponding methods."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Decorator"),(0,a.kt)("th",{parentName:"tr",align:null},"Express the corresponding method"),(0,a.kt)("th",{parentName:"tr",align:null},"Corresponding method of Koa/EggJS"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"@RequestPath"),(0,a.kt)("td",{parentName:"tr",align:null},"req.baseurl"),(0,a.kt)("td",{parentName:"tr",align:null},"ctx.path")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"@RequestIP"),(0,a.kt)("td",{parentName:"tr",align:null},"req.ip"),(0,a.kt)("td",{parentName:"tr",align:null},"ctx.ip")))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Obtain the body, path, and ip address")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"@Post('/')\nasync updateUser (\n  @Body('id') id: string,\n  @RequestPath() p: string\n  @RequestIP() ip: string): Promise<User> {\n\n}\n")),(0,a.kt)("h3",{id:"custom-request-parameter-decorator"},"Custom request parameter decorator"),(0,a.kt)("p",null,"You can quickly create custom request parameter decorators with ",(0,a.kt)("inlineCode",{parentName:"p"},"createRequestParamDecorator"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { createRequestParamDecorator } from '@midwayjs/core';\n\n// Implement decorator\nexport const Token = () => {\n  return createRequestParamDecorator(ctx => {\n    return ctx.headers.token;\n  });\n};\n\n// Use decorator\nexport class UserController {\n  async invoke(@Token() token: string) {\n    console.log(token);\n  }\n}\n")),(0,a.kt)("h2",{id:"request-parameter-type-conversion"},"Request parameter type conversion"),(0,a.kt)("p",null,"If it is a simple type, Midway will automatically convert the parameter to the user-declared type."),(0,a.kt)("p",null,"For example:"),(0,a.kt)("p",null,"Number type"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Get('/')\nasync getUser(@Query('id') id: number): Promise<User> {\n  console.log(typeof id) // number\n}\n")),(0,a.kt)("p",null,"Boolean type"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},'When the value is 0,"0", "false" is converted to false, and the rest return Boolean(value) values')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Get('/')\nasync getUser(@Query('id') id: boolean): Promise<User> {\n  console.log(typeof id) // boolean\n}\n")),(0,a.kt)("p",null,"If it is a complex type, if the specified type is Class, it will be automatically converted to an instance of the class."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// class\nclass UserDTO {\n  name: string;\n\n  getName() {\n    return this.name;\n  }\n}\n\n@Get('/')\nasync getUser(@Query() query: UserDTO): Promise<User> {\n  // query.getName()\n}\n")),(0,a.kt)("p",null,"If you do not want to be converted, you can use Interface."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"interface User {\n  name: string;\n}\n\n@Get('/')\nasync getUser(@Query() query: User): Promise<User> {\n  // ...\n}\n")),(0,a.kt)("h2",{id:"parameter-verification"},"Parameter verification"),(0,a.kt)("p",null,"The parameter verification function is provided by the validate component. For details, please refer to the ",(0,a.kt)("a",{parentName:"p",href:"./extensions/validate"},"validate component"),"."),(0,a.kt)("h2",{id:"set-http-response"},"Set HTTP response"),(0,a.kt)("h3",{id:"set-the-return-value"},"Set the return value"),(0,a.kt)("p",null,"Most of the data is sent to the requester through the body. Like the body in the request, the body sent in the response also needs a matching Content-Type to tell the client how to parse the data."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"As a RESTful API interface controller, we usually return a body with Content-Type in ",(0,a.kt)("inlineCode",{parentName:"li"},"application/json")," format and the content is a JSON string."),(0,a.kt)("li",{parentName:"ul"},"As a controller of an html page, we usually return a body with a Content-Type of ",(0,a.kt)("inlineCode",{parentName:"li"},"text/html")," format, and the content is html code segments.")),(0,a.kt)("p",null,"In Midway, you can simply use ",(0,a.kt)("inlineCode",{parentName:"p"},"return")," to return data."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, HttpCode } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n  @Inject()\n  ctx: Context;\n\n  @Get('/')\n  async home() {\n    // Return string\n    return \"Hello Midwayjs!\";\n\n    // Return json\n    return {\n      a: 1\n      b: 2\n    };\n\n    // return html\n    return '<html><h1>Hello</h1></html>';\n\n    // Return to stream\n    return fs.createReadStream('./good.png');\n  }\n}\n")),(0,a.kt)("p",null,"You can also use koa's native API."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, HttpCode } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n\n  @Get('/')\n  async home() {\n    // Return string\n    this.ctx.body = \"Hello Midwayjs!\";\n\n    // Return JSON\n    this.ctx.body = {\n      a: 1,\n      b: 2,\n    };\n\n    // return html\n    this.ctx.body = '<html><h1>Hello</h1></html>';\n\n    // Return to stream\n    this.ctx.body = fs.createReadStream('./good.png');\n  }\n}\n")),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},"Note: ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.body")," is the abbreviation of ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.response.body"),". Do not confuse it with ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.request.body"),".")),(0,a.kt)("h3",{id:"set-status-code"},"Set status code"),(0,a.kt)("p",null,"By default, the ",(0,a.kt)("strong",{parentName:"p"},"status code")," of the response is always ",(0,a.kt)("strong",{parentName:"p"},"200"),", and we can easily change this behavior by adding a ",(0,a.kt)("inlineCode",{parentName:"p"},"@HttpCode")," decorator at the handler layer or through the API."),(0,a.kt)("p",null,"When sending an error, such as ",(0,a.kt)("inlineCode",{parentName:"p"},"4xx/5xx"),", you can use ",(0,a.kt)("a",{parentName:"p",href:"error_filter"},"exception handling")," to throw an error."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Using a Decorator")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, HttpCode } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n\n  @Get('/')\n  @HttpCode(201)\n  async home() {\n    return \"Hello Midwayjs!\";\n  }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: API operation")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, Inject } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n  @Inject()\n  ctx: Context;\n\n  @Get('/')\n  async home() {\n    this.ctx.status = 201;\n    // ...\n  }\n}\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"The status code cannot be modified after the response stream is closed (after response.end).")),(0,a.kt)("h3",{id:"set-response-header"},"Set response header"),(0,a.kt)("p",null,"Midway provides a ",(0,a.kt)("inlineCode",{parentName:"p"},"@SetHeader")," decorator or an API to simply set up a custom response header."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Using a Decorator")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, SetHeader } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n\n  @Get('/')\n  @SetHeader('x-bbb', '123')\n  async home() {\n    return \"Hello Midwayjs!\";\n  }\n}\n\n")),(0,a.kt)("p",null,"When there are multiple response headers that need to be modified, you can directly pass in the object."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, SetHeader } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n\n  @Get('/')\n  @SetHeader({\n    'x-bbb ': '123',\n    'x-ccc ': '234'\n  })\n  async home() {\n    return \"Hello Midwayjs!\";\n  }\n}\n\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: API operation")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, Inject } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n  @Inject()\n  ctx: Context;\n\n  @Get('/')\n  async home() {\n    this.ctx.set('x-bbb', '123');\n    // ...\n  }\n}\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"The response header cannot be modified after the response flow is closed (after response.end).")),(0,a.kt)("h3",{id:"redirection"},"Redirection"),(0,a.kt)("p",null,"If you need to simply redirect a route to another route, you can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Redirect")," decorator. The parameters of the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Redirect")," decorator are a redirect URL and an optional status code. The default redirect status code is ",(0,a.kt)("inlineCode",{parentName:"p"},"302")," ."),(0,a.kt)("p",null,"In addition, you can jump through the API."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Using a Decorator")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, Redirect } from '@midwayjs/core';\n\n@Controller('/')\nexport class LoginController {\n\n  @Get('/login_check')\n  async check() {\n    // TODO\n  }\n\n  @Get('/login')\n  @Redirect('/login_check')\n  async login() {\n    // TODO\n  }\n\n  @Get('/login_another')\n  @Redirect('/login_check', 302)\n  async loginAnother() {\n    // TODO\n  }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: API operation")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, Inject } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n  @Inject()\n  ctx: Context;\n\n  @Get('/')\n  async home() {\n    this.ctx.redirect('/login_check');\n    // ...\n  }\n}\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"Redirection cannot be modified after the response flow is closed (after response.end).")),(0,a.kt)("h3",{id:"response-type"},"Response type"),(0,a.kt)("p",null,"Although the browser will automatically judge the best response content based on the content, we often encounter situations that need to be set manually. We also provide a ",(0,a.kt)("inlineCode",{parentName:"p"},"@ContentType")," decorator for setting the response type."),(0,a.kt)("p",null,"In addition, it can also be set through API."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Using a Decorator")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, ContentType } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n\n  @Get('/')\n  @ContentType('html')\n  async login() {\n    return '<body>hello world</body>';\n  }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: API operation")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, Inject } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n  @Inject()\n  ctx: Context;\n\n  @Get('/')\n  async home() {\n    this.ctx.type = 'html';\n    // ...\n  }\n}\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"The response type cannot be modified after the response flow is closed (after response.end).")),(0,a.kt)("h3",{id:"streaming-response"},"Streaming response"),(0,a.kt)("p",null,"If you want to stream data back, you can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"write")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"end")," methods on the Node.js raw response object."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, Inject, sleep } from '@midwayjs/core';\nimport { Context } from '@midwayjs/koa';\n\n@Controller('/')\nexport class HomeController {\n   @Inject()\n   ctx: Context;\n  \n   @Get('/')\n   async home() {\n     this.ctx.status = 200;\n     this.ctx.set('Transfer-Encoding', 'chunked');\n     for (let i = 0; i < 100; i++) {\n       await sleep(100);\n       this.ctx.res.write('abc'.repeat(100));\n     }\n    \n     this.ctx.res.end();\n   }\n}\n")),(0,a.kt)("h2",{id:"internal-redirection"},"Internal redirection"),(0,a.kt)("p",null,"Starting from v3.12.0, the framework provides an internal redirect API ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.forward(url)"),", which only supports koa/egg type."),(0,a.kt)("p",null,"The difference from external redirection is that internal redirection does not modify the URL of the browser, but only flows inside the program."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Get, Inject } from '@midwayjs/core';\n\n@Controller('/')\nexport class HomeController {\n   @Inject()\n   ctx: Context;\n\n   @Get('/')\n   async home() {\n     return this.ctx.forward('/api');\n   }\n  \n   @Get('/api')\n   async api() {\n     return 'abc';\n   }\n}\n")),(0,a.kt)("p",null,"Note that there are some rules for internal redirects:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},"Redirection will retain all parameters of the original route, that is, transparently transmit the entire ctx"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li",start:2},(0,a.kt)("li",{parentName:"ol"},"Redirection can only be done in the same http method"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li",start:3},(0,a.kt)("li",{parentName:"ol"},"Redirection will not execute Web Middleware again, and guards will not be executed, but interceptors and parameter decorators will be executed")))),(0,a.kt)("h2",{id:"global-route-prefix"},"Global route prefix"),(0,a.kt)("p",null,"It needs to be set in the ",(0,a.kt)("inlineCode",{parentName:"p"},"src/config/config.default")," configuration."),(0,a.kt)("p",null,"Note that different components are configured under different keywords:"),(0,a.kt)(c,{mdxType:"Tabs"},(0,a.kt)(m,{value:"koa",label:"koa",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  koa: {\n    globalPrefix: '/v1'\n  }\n};\n"))),(0,a.kt)(m,{value:"egg",label:"Egg.js",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  egg: {\n    globalPrefix: '/v1'\n  }\n};\n"))),(0,a.kt)(m,{value:"express",label:"Express",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  express: {\n    globalPrefix: '/v1'\n  }\n};\n")))),(0,a.kt)("p",null,"After configuration, all routes automatically add this prefix."),(0,a.kt)("p",null,"If there are special routes that are not required, you can use the decorator parameters to ignore them."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: Controller Level Ignoring")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// All routes under this Controller will ignore the global prefix\n@Controller('/api', {ignoreGlobalPrefix: true})\nexport class HomeController {\n  // ...\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Example: route level ignored")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"@Controller('/')\nexport class HomeController {\n  // This route will not be ignored\n  @Get('/', {})\n  async homeSet() {\n  }\n\n  // The route ignores the global prefix\n  @Get('/bbc', {ignoreGlobalPrefix: true})\n  async homeSet2() {\n  }\n}\n")),(0,a.kt)("h2",{id:"routing-priority"},"Routing priority"),(0,a.kt)("p",null,"Midway has already sorted the routes uniformly, and the wildcard route will automatically reduce the priority and be loaded at the end."),(0,a.kt)("p",null,"The rules are as follows:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},"The absolute path rule has the highest priority, such as ",(0,a.kt)("inlineCode",{parentName:"li"},"/AB/cb/e"),"."))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li",start:2},(0,a.kt)("li",{parentName:"ol"},"The asterisk can only appear last and must be followed by/. For example, ",(0,a.kt)("inlineCode",{parentName:"li"},"/AB/cb/**")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li",start:3},(0,a.kt)("li",{parentName:"ol"},"If the absolute path and the general configuration can match one path, the absolute rule has a high priority, such as ",(0,a.kt)("inlineCode",{parentName:"li"},"/abc/*")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"/abc/d"),", then the next absolute route is matched when the ",(0,a.kt)("inlineCode",{parentName:"li"},"/abc/d")," request is requested."))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li",start:4},(0,a.kt)("li",{parentName:"ol"},"If multiple wildspaces match a path, the longest rule matches. For example, ",(0,a.kt)("inlineCode",{parentName:"li"},"/AB/**")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"/AB/cd/**")," hit ",(0,a.kt)("inlineCode",{parentName:"li"},"/AB/cd/**")," when matching ",(0,a.kt)("inlineCode",{parentName:"li"},"/AB/cd/f"),"."))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li",start:5},(0,a.kt)("li",{parentName:"ol"},"If both",(0,a.kt)("inlineCode",{parentName:"li"},"/"),"and ",(0,a.kt)("inlineCode",{parentName:"li"},"/*")," match",(0,a.kt)("inlineCode",{parentName:"li"},"/"),", the priority of",(0,a.kt)("inlineCode",{parentName:"li"},"/"),"is higher than that of ",(0,a.kt)("inlineCode",{parentName:"li"},"/*")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li",start:6},(0,a.kt)("li",{parentName:"ol"},"If the weights are the same, such as ",(0,a.kt)("inlineCode",{parentName:"li"},"/:page/page")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"/page/:page"),".")))),(0,a.kt)("p",null,"This rule is also consistent with the routing rules of the functions under the Serverless."),(0,a.kt)("p",null,'It is simply understood as "clear routes have the highest priority, long routes have the highest priority, and general distribution has the lowest priority".'),(0,a.kt)("p",null,"For example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"@Controller('/api')\nexport class APIController {\n  @Get('/invoke/*')\n  async invokeAll() {\n  }\n\n  @Get('/invoke/abc')\n  async invokeABC() {\n  }\n}\n")),(0,a.kt)("p",null,"In this case, ",(0,a.kt)("inlineCode",{parentName:"p"},"/invoke/abc")," is registered first to ensure higher priority."),(0,a.kt)("p",null,"The priority of different Controller will be sorted by length, and the",(0,a.kt)("inlineCode",{parentName:"p"},"/"),"root Controller will be loaded finally."))}k.isMDXComponent=!0}}]);