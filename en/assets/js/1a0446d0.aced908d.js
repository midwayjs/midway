"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[51541],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>g});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),s=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=s(e.components);return a.createElement(p.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=s(n),c=r,g=u["".concat(p,".").concat(c)]||u[c]||m[c]||i;return n?a.createElement(g,o(o({ref:t},d),{},{components:n})):a.createElement(g,o({ref:t},d))}));function g(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=c;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[u]="string"==typeof e?e:r,o[1]=l;for(var s=2;s<i;s++)o[s]=n[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},86797:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>l,toc:()=>s});var a=n(87462),r=(n(67294),n(3905));const i={},o="EggJS",l={unversionedId:"extensions/egg",id:"extensions/egg",title:"EggJS",description:"Midway can use EggJS as the upper-level Web framework. EggJS provides many commonly used plug-ins and API to help users quickly build enterprise-level Web applications. This chapter mainly introduces how EggJS uses its own capabilities in Midway.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/extensions/egg.md",sourceDirName:"extensions",slug:"/extensions/egg",permalink:"/en/docs/extensions/egg",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/extensions/egg.md",tags:[],version:"current",frontMatter:{},sidebar:"component",previous:{title:"Koa",permalink:"/en/docs/extensions/koa"},next:{title:"Express",permalink:"/en/docs/extensions/express"}},p={},s=[{value:"Installation dependency",id:"installation-dependency",level:2},{value:"Open the component",id:"open-the-component",level:2},{value:"The difference from the default EggJS",id:"the-difference-from-the-default-eggjs",level:2},{value:"Directory structure",id:"directory-structure",level:2},{value:"Configuration Definition",id:"configuration-definition",level:2},{value:"Using Egg plugin",id:"using-egg-plugin",level:2},{value:"Web middleware",id:"web-middleware",level:2},{value:"Middleware sequence",id:"middleware-sequence",level:2},{value:"BodyParser",id:"bodyparser",level:2},{value:"Schedule",id:"schedule",level:2},{value:"Log",id:"log",level:2},{value:"Exception handling",id:"exception-handling",level:2},{value:"Extended Application/Context/Request/Response",id:"extended-applicationcontextrequestresponse",level:2},{value:"Add extension logic",id:"add-extension-logic",level:3},{value:"Add extended definition",id:"add-extended-definition",level:3},{value:"Use egg-scripts deployment",id:"use-egg-scripts-deployment",level:2},{value:"Startup environment",id:"startup-environment",level:2},{value:"State type definition",id:"state-type-definition",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Default configuration",id:"default-configuration",level:3},{value:"Modify port",id:"modify-port",level:3},{value:"Global prefix",id:"global-prefix",level:3},{value:"Https configuration",id:"https-configuration",level:3},{value:"favicon settings",id:"favicon-settings",level:3},{value:"Modify context log",id:"modify-context-log",level:3},{value:"Query array parsing",id:"query-array-parsing",level:3},{value:"Common problem",id:"common-problem",level:2},{value:"1. generate ts definition",id:"1-generate-ts-definition",level:3},{value:"2. Special Situation of Configuration in EggJS",id:"2-special-situation-of-configuration-in-eggjs",level:3},{value:"3. Asynchronous initialization configuration cannot override plug-in configuration",id:"3-asynchronous-initialization-configuration-cannot-override-plug-in-configuration",level:3},{value:"4. default csrf error",id:"4-default-csrf-error",level:3},{value:"5. There is no definition problem",id:"5-there-is-no-definition-problem",level:3},{value:"6\u3001Get Http Server",id:"6get-http-server",level:3}],d={toc:s},u="wrapper";function m(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"eggjs"},"EggJS"),(0,r.kt)("p",null,"Midway can use EggJS as the upper-level Web framework. EggJS provides many commonly used plug-ins and API to help users quickly build enterprise-level Web applications. This chapter mainly introduces how EggJS uses its own capabilities in Midway."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null}))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Contains independent main framework"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Contains independent logs"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2705")))),(0,r.kt)("h2",{id:"installation-dependency"},"Installation dependency"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i @midwayjs/web@3 egg --save\n$ npm i @midwayjs/egg-ts-helper --save-dev\n")),(0,r.kt)("p",null,"For the EggJS scenario, these packages are listed below."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'  "dependencies": {\n    "@midwayjs/web": "^3.0.0",\n    "@midwayjs/core": "^3.0.0",\n    "egg": "^2.0.0 ",\n    "egg-scripts": "^2.10.0"\n  },\n  "devDependencies": {\n    "@midwayjs/egg-ts-helper": "^1.0.1 ",\n  },\n')),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"@midwayjs/web"),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Required")," ,Midway EggJS adaptation layer"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"@midwayjs/core"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Required")," ,Midway core package")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"egg"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Required")," ,EggJS dependent package, and other capabilities such as definition.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"egg-scripts"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Optional")," ,EggJS startup script")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"@midwayjs/egg-ts-helper"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Optional")," ,EggJS defines the generation tool.")))),(0,r.kt)("p",null,"Examples can also be created directly using scaffolding."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# npm v6\n$ npm init midway --type=egg-v3 my_project\n\n# npm v7\n$ npm init midway -- --type=egg-v3 my_project\n")),(0,r.kt)("h2",{id:"open-the-component"},"Open the component"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Configuration, App } from '@midwayjs/core';\nimport * as web from '@midwayjs/web';\nimport { join } from 'path';\n\n@Configuration({\n  imports: [web]\n  importConfigs: [join(__dirname, './config')]\n})\nexport class MainConfiguration {\n  @App()\n  app: web.Application;\n\n  async onReady() {\n        // ...\n  }\n}\n\n")),(0,r.kt)("h2",{id:"the-difference-from-the-default-eggjs"},"The difference from the default EggJS"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"starting from v3, midway provides more components, and most egg built-in plug-ins are disabled by default"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:2},(0,r.kt)("li",{parentName:"ol"},"The baseDir is adjusted to ",(0,r.kt)("inlineCode",{parentName:"li"},"src")," directory by default, and the server is ",(0,r.kt)("inlineCode",{parentName:"li"},"dist")," directory."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:3},(0,r.kt)("li",{parentName:"ol"},"disable egg-logger, replace all with @midwayjs/logger, and cannot switch")))),(0,r.kt)("p",null,"The entire architecture is as follows:\n",(0,r.kt)("img",{parentName:"p",src:"https://cdn.nlark.com/yuque/0/2021/png/501408/1614842824740-fc0c1432-3ace-4f77-b51f-15212984b168.png",alt:null})),(0,r.kt)("h2",{id:"directory-structure"},"Directory structure"),(0,r.kt)("p",null,"In addition to the directory structure provided by Midway, EggJS also has some special directory structures (immutable). The entire structure is as follows."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\u279c  my_midway_app tree\n.\n\u251c\u2500\u2500 src\n|   \u251c\u2500\u2500 app.ts                                                      ## EggJS Extended Worker Lifecycle File (optional)\n|   \u251c\u2500\u2500 agent.ts                                                ## EggJS Extended Agent Lifecycle File (Optional)\n|   \u251c\u2500\u2500 app                                                             ## EggJS fixed root directory (optional)\n|   \u2502   \u251c\u2500\u2500 public                                          ## The default directory for EggJS static hosting plug-ins (available)\n|   \u2502   |   \u2514\u2500\u2500 reset.css\n|   \u2502   \u251c\u2500\u2500 view (optional)                             ## ## The default directory for EggJS template rendering (available)\n|   \u2502   |   \u2514\u2500\u2500 home.tpl\n|   \u2502   \u2514\u2500\u2500 extend (optional)                           ## EggJS \u6269\u5c55\u76ee\u5f55\uff08\u53ef\u914d\uff09\n|   \u2502       \u251c\u2500\u2500 helper.ts (optional)\n|   \u2502       \u251c\u2500\u2500 request.ts (optional)\n|   \u2502       \u251c\u2500\u2500 response.ts (optional)\n|   \u2502       \u251c\u2500\u2500 context.ts (optional)\n|   \u2502       \u251c\u2500\u2500 application.ts (optional)\n|   \u2502       \u2514\u2500\u2500 agent.ts (optional)\n|   \u2502\n|   \u251c\u2500\u2500 config\n|   |   \u251c\u2500\u2500 plugin.ts\n|   |   \u251c\u2500\u2500 config.default.ts\n|   \u2502   \u251c\u2500\u2500 config.prod.ts\n|   |   \u251c\u2500\u2500 config.test.ts (\u53ef\u9009)\n|   |   \u251c\u2500\u2500 config.local.ts (\u53ef\u9009)\n|   |   \u2514\u2500\u2500 config.unittest.ts (\u53ef\u9009)\n\u2502   \u251c\u2500\u2500 controller                                              ## Midway controller directory (recommended)\n\u2502   \u251c\u2500\u2500 service                                                 ## Midway service directory (recommended)\n\u2502   \u2514\u2500\u2500 schedule\n\u2502\n\u251c\u2500\u2500 typings                                     ## EggJS defines the generation directory.\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 tsconfig.json\n")),(0,r.kt)("p",null,"The above is a complete picture of the directory structure of EggJS, which contains many specific directories of EggJS, some of which have been replaced by corresponding capabilities in the Midway system and can be replaced directly. The entire structure is basically equivalent to moving the directory structure of EggJS to the ",(0,r.kt)("inlineCode",{parentName:"p"},"src")," directory."),(0,r.kt)("p",null,"Since EggJS is a convention-based framework, the directory structure of the entire project is fixed. Here are some commonly used convention directories."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"th"},"src/app/public/**")),(0,r.kt)("th",{parentName:"tr",align:null},"Optional. For more information, see ",(0,r.kt)("a",{parentName:"th",href:"https://github.com/eggjs/egg-static"},"egg-static"),"."))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"src/config/config.{env}.ts")),(0,r.kt)("td",{parentName:"tr",align:null},"For more information about how to write a configuration file, see ",(0,r.kt)("a",{parentName:"td",href:"https://eggjs.org/zh-cn/basics/config.html"},"Configuration"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"src/config/plugin.js")),(0,r.kt)("td",{parentName:"tr",align:null},"For more information, see ",(0,r.kt)("a",{parentName:"td",href:"https://eggjs.org/zh-cn/basics/plugin.html"},"Plug-ins"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"test/**")),(0,r.kt)("td",{parentName:"tr",align:null},"For more information, see ",(0,r.kt)("a",{parentName:"td",href:"https://eggjs.org/zh-cn/core/unittest.html"},"Unit testing"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"src/app.js")," and ",(0,r.kt)("inlineCode",{parentName:"td"},"src/agent.js")),(0,r.kt)("td",{parentName:"tr",align:null},"It is used to customize initialization during startup. Optional. For more information, see ",(0,r.kt)("a",{parentName:"td",href:"https://eggjs.org/zh-cn/basics/app-start.html"},"Start customization"),". For more information about the role of ",(0,r.kt)("inlineCode",{parentName:"td"},"agent.js"),", see ","[Agent mechanism]","(",(0,r.kt)("a",{parentName:"td",href:"https://eggjs.org/zh-cn/core/cluster-and-ipc.html#agent-%E6%9C%BA%E5%88%25"},"https://eggjs.org/zh-cn/core/cluster-and-ipc.html#agent-%E6%9C%BA%E5%88%")," B6).")))),(0,r.kt)("h2",{id:"configuration-definition"},"Configuration Definition"),(0,r.kt)("p",null,"Midway provides the standard TS configuration writing of EggJS in the scaffold. The MidwayConfig includes the definition and attribute tips of the configuration in egg. The structure is as follows."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { MidwayConfig, MidwayAppInfo } from '@midwayjs/core';\n\nexport default (appInfo: MidwayAppInfo) => {\n  return {\n    // use for cookie sign key, should change to your own and keep security\n    keys: appInfo.name + '_xxxx',\n    egg: {\n      port: 7001\n    },\n    // security: {\n    //   csrf: false\n    // },\n  } as MidwayConfig;\n};\n\n")),(0,r.kt)("p",null,"In the form of this return method, it will be automatically executed during the run-time and merged into the complete configuration object."),(0,r.kt)("p",null,"The parameter of this function is of ",(0,r.kt)("inlineCode",{parentName:"p"},"MidwayAppConfig")," type and the value is the following."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"appInfo")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Description")))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"pkg"),(0,r.kt)("td",{parentName:"tr",align:null},"package.json")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"name"),(0,r.kt)("td",{parentName:"tr",align:null},"Application name, same as pkg.name")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"baseDir"),(0,r.kt)("td",{parentName:"tr",align:null},"The src (locally developed) or Dist (after online) Directory of the application code")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"appDir"),(0,r.kt)("td",{parentName:"tr",align:null},"Directory of application code")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"HOME"),(0,r.kt)("td",{parentName:"tr",align:null},"The user directory, for example, the admin account is/home/admin.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"root"),(0,r.kt)("td",{parentName:"tr",align:null},"The root directory of the application is only baseDir in local and unittest environments, and the others are HOME.")))),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Note that the ",(0,r.kt)("inlineCode",{parentName:"p"},"baseDir")," here is different from the ",(0,r.kt)("inlineCode",{parentName:"p"},"appDir")," and EggJS applications.")),(0,r.kt)("h2",{id:"using-egg-plugin"},"Using Egg plugin"),(0,r.kt)("p",null,"Plugin are one of EggJS's features. ",(0,r.kt)("inlineCode",{parentName:"p"},"@midwayjs/web")," also supports EggJS's plug-in system, but in the case of Midway components, Midway components are used as much as possible."),(0,r.kt)("p",null,"Plug-ins are generally reused by npm modules."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i egg-mysql --save\n")),(0,r.kt)("p",null,"Then, you must declare that it is enabled in the ",(0,r.kt)("inlineCode",{parentName:"p"},"src/config/plugin.js")," of the application or framework."),(0,r.kt)("p",null,"If there is an ",(0,r.kt)("inlineCode",{parentName:"p"},"export default"),", please write it in it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { EggPlugin } from 'egg';\nexport default {\n  static: false, // default is true\n  mysql: {\n    enable: true\n    package: 'egg-mysql'\n  }\n} as EggPlugin;\n\n")),(0,r.kt)("p",null,"If there is no ",(0,r.kt)("inlineCode",{parentName:"p"},"export default"),", you can export it directly."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/plugin.ts\n// Use mysql plug-in\nexport const mysql = {\n  enable: true\n  package: 'egg-mysql',\n};\n")),(0,r.kt)("p",null,"After opening the plug-in, we can use the functions provided by the plug-in in the business code. Generally, the plug-in mounts the object to the ",(0,r.kt)("inlineCode",{parentName:"p"},"app")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"ctx")," of EggJS, and then uses it directly."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"app.mysql.query(sql, values);           // Methods provided by egg\n")),(0,r.kt)("p",null,"In Midway, you can use ",(0,r.kt)("inlineCode",{parentName:"p"},"@App")," to obtain the ",(0,r.kt)("inlineCode",{parentName:"p"},"app")," object, and in the request scope, you can use ",(0,r.kt)("inlineCode",{parentName:"p"},"@Inject() ctx")," to obtain the ",(0,r.kt)("inlineCode",{parentName:"p"},"ctx")," object, so you can obtain the plug-in object by injection."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide, Inject, Get } from '@midwayjs/core';\nimport { Application, Context } from '@midwayjs/web';\n\n@Provide()\nexport class HomeController {\n\n  @App()\n  app: Application;\n\n  @Inject()\n  ctx: Context;\n\n  @Get('/')\n  async home() {\n    This. app.mysql.query (SQL, values); // Call methods on app (if any)\n    This. ctx.mysql.query (SQL, values); // Call the method mounted on ctx (if any)\n  }\n}\n")),(0,r.kt)("p",null,"In addition, you can directly inject plugins mounted by ",(0,r.kt)("inlineCode",{parentName:"p"},"app")," through the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Plugin")," decorator. By default, if no parameters are passed, the property name will be used as the key."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide, Get, Plugin } from '@midwayjs/core';\n\n@Provide()\nexport class HomeController {\n\n  @Plugin()\n  mysql: any;\n\n  @Get('/')\n  async home() {\n    this.mysql.query( SQL, values);\n  }\n}\n")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},(0,r.kt)("inlineCode",{parentName:"p"},"@Plugin() mysql")," is equivalent to ",(0,r.kt)("inlineCode",{parentName:"p"},"app.mysql"),".  The function of ",(0,r.kt)("inlineCode",{parentName:"p"},"@Plugin")," is to take the plug-in corresponding to the attribute name from the app object. Therefore, ",(0,r.kt)("inlineCode",{parentName:"p"},"@Plugin() xxx")," is equal to ",(0,r.kt)("inlineCode",{parentName:"p"},"app['xxx']"),".")),(0,r.kt)("h2",{id:"web-middleware"},"Web middleware"),(0,r.kt)("p",null,"The middleware sample is as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Middleware, IMiddleware } from '@midwayjs/core';\nimport { Context, NextFunction } from '@midwayjs/web';\n\n@Middleware()\nexport class ReportMiddleware implements IMiddleware<Context, NextFunction> {\n\n  resolve() {\n    return async (ctx: Context, next: NextFunction) => {\n      const startTime = Date.now();\n      await next();\n      console.log(Date.now() - startTime);\n    };\n  }\n\n}\n")),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Notice"),(0,r.kt)("ol",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"If you want to continue to use the traditional functional writing method of EggJS, you must put the file under ",(0,r.kt)("inlineCode",{parentName:"p"},"src/app/middleware"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The built-in middleware that comes with egg has been integrated")))),(0,r.kt)("p",null,"Application Middleware."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { App, Configuration } from '@midwayjs/core';\nimport * as egg from '@midwayjs/web';\nimport { ReportMiddleware } from './middleware/user.middleware';\n\n@Configuration({\n  imports: [egg]\n  // ...\n})\nexport class MainConfiguration {\n\n  @App()\n  app: egg.Application;\n\n  async onReady() {\n    this.app.useMiddleware(ReportMiddleware);\n  }\n}\n\n")),(0,r.kt)("p",null,"For more information, see ",(0,r.kt)("a",{parentName:"p",href:"../middleware"},"Web middleware"),"."),(0,r.kt)("h2",{id:"middleware-sequence"},"Middleware sequence"),(0,r.kt)("p",null,"Since egg also has its own middleware logic, in the new version, we have done a certain processing of the middleware loading sequence, and the execution sequence is as follows:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"middleware in the egg framework"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:2},(0,r.kt)("li",{parentName:"ol"},"the order in which egg plug-ins are added through config.coreMiddleware"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:3},(0,r.kt)("li",{parentName:"ol"},"The order in which the business code is configured in config.middleware"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:4},(0,r.kt)("li",{parentName:"ol"},"the order in which App. useMiddleware is added")))),(0,r.kt)("p",null,"Because midway's middleware will be post-loaded, we can customize sorting in the onReady."),(0,r.kt)("h2",{id:"bodyparser"},"BodyParser"),(0,r.kt)("p",null,"the ",(0,r.kt)("inlineCode",{parentName:"p"},"bodyParser")," feature of the egg. by default, it parses ",(0,r.kt)("inlineCode",{parentName:"p"},"post")," requests and automatically identifies the ",(0,r.kt)("inlineCode",{parentName:"p"},"json")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"form")," types."),(0,r.kt)("p",null,"If you need text or xml, you can configure it yourself."),(0,r.kt)("p",null,"The default size is limited to ",(0,r.kt)("inlineCode",{parentName:"p"},"1mb"),". You can set the size of each item separately."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nexport default {\n  // ...\n  bodyParser: {\n    formLimit: '1mb',\n    jsonLimit: '1mb',\n    textLimit: '1mb',\n    xmlLimit: '1mb',\n  },\n}\n")),(0,r.kt)("p",null,"Note that the type selection when using Postman for Post requests:"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img.alicdn.com/imgextra/i4/O1CN01QCdTsN1S347SuzZU5_!!6000000002190-2-tps-1017-690.png",alt:"postman"})),(0,r.kt)("h2",{id:"schedule"},"Schedule"),(0,r.kt)("p",null,"For more information about the start of v3, see ",(0,r.kt)("a",{parentName:"p",href:"./bull"},"bull components"),"."),(0,r.kt)("p",null,"To be compatible with the previous ",(0,r.kt)("a",{parentName:"p",href:"https://eggjs.org/zh-cn/basics/schedule.html"},"egg scheduled tasks"),", follow the following steps."),(0,r.kt)("p",null,"First install ",(0,r.kt)("inlineCode",{parentName:"p"},"midway-schedule")," dependencies."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i midway-schedule --save\n")),(0,r.kt)("p",null,"Add to the plug-in."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/plugin.ts\nexport default {\n  schedule: true\n  schedulePlus: {\n    enable: true\n    package: 'midway-schedule',\n  }\n}\n")),(0,r.kt)("p",null,"Please refer to the previous version of the document."),(0,r.kt)("h2",{id:"log"},"Log"),(0,r.kt)("p",null,"Since v3 cannot use egg-logger, see ",(0,r.kt)("a",{parentName:"p",href:"../logger"},"Logs"),"."),(0,r.kt)("h2",{id:"exception-handling"},"Exception handling"),(0,r.kt)("p",null,"EggJS framework provides a unified error handling mechanism through ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/eggjs/egg-onerror"},"onerror")," plug-ins, which will be used as Midway's bottom error logic and will not conflict with ",(0,r.kt)("a",{parentName:"p",href:"../error_filter"},"error filters"),"."),(0,r.kt)("p",null,"Any exception thrown in all processing methods (Middleware, Controller, Service) for a request will be captured by it and will automatically return different types of errors (based on ",(0,r.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7231#section-5.3.2"},"Content Negotiation"),") according to the type the request wants to obtain."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Format of request requirements"),(0,r.kt)("th",{parentName:"tr",align:null},"Environment"),(0,r.kt)("th",{parentName:"tr",align:null},"errorPageUrl whether to configure"),(0,r.kt)("th",{parentName:"tr",align:null},"Return content"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"HTML & TEXT"),(0,r.kt)("td",{parentName:"tr",align:null},"local & unittest"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"Onerror comes with an error page that displays detailed error information")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"HTML & TEXT"),(0,r.kt)("td",{parentName:"tr",align:null},"Other"),(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"Redirect to errorPageUrl")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"HTML & TEXT"),(0,r.kt)("td",{parentName:"tr",align:null},"Other"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"onerror comes with a simple error page without error information (not recommended)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"JSON & JSONP"),(0,r.kt)("td",{parentName:"tr",align:null},"local & unittest"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"JSON object or corresponding JSONP format response with detailed error information")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"JSON & JSONP"),(0,r.kt)("td",{parentName:"tr",align:null},"Other"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"JSON object or corresponding JSONP format response, without detailed error information")))),(0,r.kt)("p",null,"errorPageUrl attribute is supported in the configuration of the onerror plug-in. When the errorPageUrl is configured, once the user requests an exception to the HTML page applied online, it will be redirected to this address."),(0,r.kt)("p",null,"In ",(0,r.kt)("inlineCode",{parentName:"p"},"src/config/config.default.ts")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nmodule.exports = {\n  onerror: {\n    // When an exception occurs on the online page, redirect to this page\n    errorPageUrl: '/50x.html',\n  },\n};\n")),(0,r.kt)("h2",{id:"extended-applicationcontextrequestresponse"},"Extended Application/Context/Request/Response"),(0,r.kt)("h3",{id:"add-extension-logic"},"Add extension logic"),(0,r.kt)("p",null,"Although MidwayJS do not want to mount the attribute directly to koa's Context and App (which will cause uncertainty in management and definition), this function of EggJS is still available."),(0,r.kt)("p",null,"The file location is as follows."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\u279c  my_midway_app tree\n.\n\u251c\u2500\u2500 src\n\u2502   \u251c\u2500\u2500 app\n\u2502   \u2502   \u2514\u2500\u2500 extend\n\u2502   \u2502       \u251c\u2500\u2500 application.ts\n\u2502   \u2502       \u251c\u2500\u2500 context.ts\n\u2502   \u2502       \u251c\u2500\u2500 request.ts\n\u2502   \u2502       \u2514\u2500\u2500 response.ts\n\u2502   \u251c\u2500\u2500 config\n\u2502   \u2514\u2500\u2500 interface.ts\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 tsconfig.json\n")),(0,r.kt)("p",null,"The content is the same as the original EggJS."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/app/extend/context.ts\nexport default {\n  get hello() {\n    return 'hello world';\n  },\n};\n")),(0,r.kt)("h3",{id:"add-extended-definition"},"Add extended definition"),(0,r.kt)("p",null,"Context please use Midway to extend, please check the ",(0,r.kt)("a",{parentName:"p",href:"/docs/context_definition"},"extended context definition"),"."),(0,r.kt)("p",null,"For the rest, please expand in ",(0,r.kt)("inlineCode",{parentName:"p"},"src/interface.ts"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/interface.ts\ndeclare module 'egg' {\n  interface Request {\n    // ...\n  }\n  interface Response {\n    // ...\n  }\n  interface Application {\n    // ...\n  }\n}\n")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},(0,r.kt)("strong",{parentName:"p"},"Do not place the definition of business custom extensions under the root directory")," to avoid overwriting by ts-helper tools.``")),(0,r.kt)("h2",{id:"use-egg-scripts-deployment"},"Use egg-scripts deployment"),(0,r.kt)("p",null,"Since EggJS provides the default multi-process deployment tool ",(0,r.kt)("inlineCode",{parentName:"p"},"egg-scripts"),", Midway also continues to support this method. If the upper layer is EggJS, this deployment method is recommended."),(0,r.kt)("p",null,"First, in the dependency, ensure that the ",(0,r.kt)("inlineCode",{parentName:"p"},"egg-scripts")," package is installed."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i egg-scripts --save\n")),(0,r.kt)("p",null,"Add ",(0,r.kt)("inlineCode",{parentName:"p"},"npm scripts")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,r.kt)("p",null,"After the above code is built, use our ",(0,r.kt)("inlineCode",{parentName:"p"},"start")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"stop")," commands to start and stop."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"scripts": {\n  "start": "egg-scripts start --daemon --title=********* --framework=@midwayjs/web",\n  "stop": "egg-scripts stop --title=*********",\n}\n')),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},(0,r.kt)("inlineCode",{parentName:"p"},"*********")," is your project name.")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Note: ",(0,r.kt)("inlineCode",{parentName:"p"},"egg-scripts")," has limited support for Windows systems, see ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/eggjs/egg-scripts/pull/22"},"#22"),".")),(0,r.kt)("h4",{id:""}),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Start Parameters")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ egg-scripts start --port=7001 --daemon --title=egg-server-showcase\n")),(0,r.kt)("p",null,"Copy"),(0,r.kt)("p",null,"As shown in the above example, the following parameters are supported:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"`",(0,r.kt)("inlineCode",{parentName:"li"},"--port=7001")," Port number, the environment variable process.env.PORT will be read by default, if not passed, the framework's built-in port 7001 will be used.`"),(0,r.kt)("li",{parentName:"ul"},"Whether ",(0,r.kt)("inlineCode",{parentName:"li"},"--daemon")," is allowed in the background mode without nohup. If Docker is used, it is recommended to run directly at the foreground."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"--env=prod")," running environment of the framework. By default, the environment variable process.env.EGG_SERVER_ENV will be read. If it is not passed, the built-in environment prod of the framework will be used."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"--workers=2")," Number of Worker threads in the framework. By default, the number of app workers equivalent to the number of CPU cores will be created, which can make full use of CPU resources."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"--title=egg-server-showcase")," is used to facilitate grep in ps processes. the default value is egg-server-${appname}."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"--framework=yadan")," If the application uses a ",(0,r.kt)("a",{parentName:"li",href:"https://eggjs.org/zh-cn/advanced/framework.html"},"custom framework"),", you can configure the egg.framework of the package.json or specify this parameter."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"--ignore-stderr"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"--https.key")," specifies the full path of the key file that is required for HTTPS."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"--https.cert")," specifies the full path of the certificate file required for HTTPS."),(0,r.kt)("li",{parentName:"ul"},"All ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/eggjs/egg-cluster"},"egg-cluster")," Options support transparent transmission, such as -- port, etc.")),(0,r.kt)("p",null,"For more parameters, see the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/eggjs/egg-scripts"},"egg-scripts")," and ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/eggjs/egg-cluster"},"egg-cluster")," documents."),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Logs deployed using egg-scripts are stored in the ",(0,r.kt)("strong",{parentName:"p"},"user directory")," ",(0,r.kt)("strong",{parentName:"p"},",")," such as ",(0,r.kt)("inlineCode",{parentName:"p"},"/home/xxxx/logs"),".")),(0,r.kt)("h2",{id:"startup-environment"},"Startup environment"),(0,r.kt)("p",null,"The original egg uses ",(0,r.kt)("inlineCode",{parentName:"p"},"EGG_SERVER_ENV")," as an environmental sign, please use ",(0,r.kt)("inlineCode",{parentName:"p"},"MIDWAY_SERVER_ENV")," in Midway."),(0,r.kt)("h2",{id:"state-type-definition"},"State type definition"),(0,r.kt)("p",null,"There is a special State attribute in the Context of koa at the bottom of egg. The State definition can be extended in a similar way to Context."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/interface.ts\n\ndeclare module '@midwayjs/web/dist/interface' {\n  interface Context {\n    abc: string;\n  }\n\n  interface State{\n    bbb: string;\n    ccc: number;\n  }\n}\n")),(0,r.kt)("h2",{id:"configuration"},"Configuration"),(0,r.kt)("h3",{id:"default-configuration"},"Default configuration"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nexport default {\n  // ...\n  egg: {\n    port: 7001\n  },\n}\n")),(0,r.kt)("p",null,"All parameters of ",(0,r.kt)("inlineCode",{parentName:"p"},"@midwayjs/web")," are as follows:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Configuration Item"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"port"),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Required, Started Port")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"key"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Buffer")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"cert"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Buffer")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"ca"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Buffer")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"hostname"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"The hostname of the listener, the default 127.1")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"http2"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"Optional, supported by http2, default false")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"queryParseMode"),(0,r.kt)("td",{parentName:"tr",align:null},"simple","|","extended"),(0,r.kt)("td",{parentName:"tr",align:null},"The default is extended")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"queryParseOptions"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"qs.IParseOptions")),(0,r.kt)("td",{parentName:"tr",align:null},"Parse options when 'simple' mode is used")))),(0,r.kt)("p",null,"The above attributes are valid for applications deployed locally and using ",(0,r.kt)("inlineCode",{parentName:"p"},"bootstrap.js"),"."),(0,r.kt)("h3",{id:"modify-port"},"Modify port"),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Note that this method will only take effect for projects developed locally and deployed using bootstrap.js files.")),(0,r.kt)("p",null,"By default, we provide the ",(0,r.kt)("inlineCode",{parentName:"p"},"7001")," default port parameter in ",(0,r.kt)("inlineCode",{parentName:"p"},"config.default"),". by modifying it, we can modify the default port of egg http service."),(0,r.kt)("p",null,"For example, we changed it to ",(0,r.kt)("inlineCode",{parentName:"p"},"6001"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nexport default {\n  // ...\n  egg: {\n    port: 6001\n  },\n}\n")),(0,r.kt)("p",null,"By default, our port configuration is ",(0,r.kt)("inlineCode",{parentName:"p"},"null")," because the single-test environment requires supertest to start the port."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.unittest\nexport default {\n  // ...\n  egg: {\n    port: null\n  },\n}\n")),(0,r.kt)("p",null,"In addition, you can also temporarily modify the port by ",(0,r.kt)("inlineCode",{parentName:"p"},"midway-bin dev-ts-port = 6001"),", which overwrites the configured port."),(0,r.kt)("h3",{id:"global-prefix"},"Global prefix"),(0,r.kt)("p",null,"For more information about this feature, see ","[Global Prefixes]","(../controller# Global Routing Prefix)."),(0,r.kt)("h3",{id:"https-configuration"},"Https configuration"),(0,r.kt)("p",null,"In most cases, please use external agents as much as possible to complete the implementation of Https, such as Nginx."),(0,r.kt)("p",null,"In some special scenarios, you can directly turn on Https by configuring SSL certificates (TLS certificates)."),(0,r.kt)("p",null,"First, you must prepare certificate files in advance, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"ssl.key")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"ssl.pem"),". The key is the private key of the server and the pem is the corresponding certificate."),(0,r.kt)("p",null,"Then configure it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nimport { readFileSync } from 'fs';\nimport { join } from 'path';\n\nexport default {\n  // ...\n  egg: {\n    key: join(__dirname, '../ssl/ssl.key')\n    cert: join(__dirname, '../ssl/ssl.pem')\n  },\n}\n")),(0,r.kt)("h3",{id:"favicon-settings"},"favicon settings"),(0,r.kt)("p",null,"By default, the browser will initiate a request to ",(0,r.kt)("inlineCode",{parentName:"p"},"favicon.ico"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nimport { readFileSync } from 'fs';\nimport { join } from 'path';\n\nexport default {\n  // ...\n  siteFile: {\n    '/favicon.ico': readFileSync(join(__dirname, 'favicon.png'))\n  },\n}\n")),(0,r.kt)("p",null,"If the ",(0,r.kt)("inlineCode",{parentName:"p"},"@midwayjs/static-file")," component is turned on, static file hosting of the component will be preferred."),(0,r.kt)("h3",{id:"modify-context-log"},"Modify context log"),(0,r.kt)("p",null,"The context log of the egg framework can be modified individually."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export default {\n  egg: {\n    contextLoggerFormat: info => {\n      const ctx = info.ctx;\n      return '${info.timestamp} ${info.LEVEL} ${info.pid} [${ctx.userId} - ${Date.now() - ctx.startTime}ms ${ctx.method}] ${info.message}';\n    }\n    // ...\n  },\n};\n")),(0,r.kt)("h3",{id:"query-array-parsing"},"Query array parsing"),(0,r.kt)("p",null,"By default, ",(0,r.kt)("inlineCode",{parentName:"p"},"ctx.query")," parses to ignore arrays, while ",(0,r.kt)("inlineCode",{parentName:"p"},"ctx.queries")," strictly turns all fields into arrays."),(0,r.kt)("p",null,"If you adjust the ",(0,r.kt)("inlineCode",{parentName:"p"},"queryParseMode"),", you can make ",(0,r.kt)("inlineCode",{parentName:"p"},"ctx.query")," a structure between the two (the result of the querystring)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nexport default {\n  // ...\n  egg: {\n    // ...\n    queryParseMode: 'simple',\n    queryParseOptions: {\n      arrayLimit: 100,\n    },\n  },\n}\n")),(0,r.kt)("h2",{id:"common-problem"},"Common problem"),(0,r.kt)("h3",{id:"1-generate-ts-definition"},"1. generate ts definition"),(0,r.kt)("p",null,"Midway provides the ",(0,r.kt)("inlineCode",{parentName:"p"},"@midwayjs/egg-ts-Hepler")," toolkit for quickly generating the definitions that EggJS depends on when developing."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm install @midwayjs/egg-ts-helper --save-dev\n")),(0,r.kt)("p",null,"Add the corresponding ",(0,r.kt)("inlineCode",{parentName:"p"},"ets")," command to ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json"),". Generally speaking, we will add it before the dev command to ensure the correctness of the code."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'  "scripts": {\n    "dev": "cross-env ets && cross-env NODE_ENV=local midway-bin dev --ts ",\n  },\n')),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Before writing code for the first time, you need to execute this command once to have ts definition generation.")),(0,r.kt)("p",null,"EggJS-generated definitions are in the ",(0,r.kt)("inlineCode",{parentName:"p"},"typings")," directory."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\u279c  my_midway_app tree\n.\n\u251c\u2500\u2500 src                            ## midway project source code\n\u251c\u2500\u2500 typings                        ## EggJS defines the generation directory.\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 tsconfig.json\n")),(0,r.kt)("h3",{id:"2-special-situation-of-configuration-in-eggjs"},"2. Special Situation of Configuration in EggJS"),(0,r.kt)("p",null,"Under EggJS, the life cycle in ",(0,r.kt)("inlineCode",{parentName:"p"},"configuration.ts")," ",(0,r.kt)("strong",{parentName:"p"},"will only be loaded and executed")," under worker. If you have similar requirements on the Agent, use the ",(0,r.kt)("inlineCode",{parentName:"p"},"agent.ts")," of EggJS."),(0,r.kt)("h3",{id:"3-asynchronous-initialization-configuration-cannot-override-plug-in-configuration"},"3. Asynchronous initialization configuration cannot override plug-in configuration"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"onConfigLoad")," the lifecycle is executed after the egg plug-in (if any) is initialized, it cannot be used to override the configuration used by the egg plug-in."),(0,r.kt)("h3",{id:"4-default-csrf-error"},"4. default csrf error"),(0,r.kt)("p",null,"In the post request, especially the first time, the user will find a csrf error. the reason is that ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/eggjs/egg-security"},"egg-security")," is built into the security plug-in in the framework by default, and csrf verification is enabled by default."),(0,r.kt)("p",null,"We can turn it off in the config, but better to go to ",(0,r.kt)("a",{parentName:"p",href:"https://eggjs.org/en-us/core/security.html#%E5%AE%89%E5%85%A8%E5%A8%81%E8%83%81-csrf-%E7%9A%84%E9%98%B2%E8%8C%83"},(0,r.kt)("strong",{parentName:"a"},"Learn about it"))," and then make a selection."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export const security = {\n  csrf: false\n};\n")),(0,r.kt)("h3",{id:"5-there-is-no-definition-problem"},"5. There is no definition problem"),(0,r.kt)("p",null,"Some egg plug-ins do not provide ts definitions, resulting in undeclared methods, such as egg-mysql.\n",(0,r.kt)("img",{parentName:"p",src:"https://img.alicdn.com/imgextra/i1/O1CN01mv68zG1zN6nALff8n_!!6000000006701-2-tps-1478-876.png",alt:"image.png"}),"\nYou can use any to bypass."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"await (this.app as any).mysql.query(sql);\n")),(0,r.kt)("p",null,"Or you can add extended definitions by yourself."),(0,r.kt)("h3",{id:"6get-http-server"},"6\u3001Get Http Server"),(0,r.kt)("p",null,"The original HttpServer is sealed inside Eggjs and needs to be accessed through events."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration, App } from '@midwayjs/core';\nimport { Application } from '@midwayjs/web';\n\n@Configuration(/***/)\nexport class MainConfiguration {\n  \n  @App('egg')\n  app: Application;\n  \n  // ...\n  async onServerReady() {\n    this.app.once('server', (server) => {\n      // ...\n    })\n  }\n}\n")))}m.isMDXComponent=!0}}]);