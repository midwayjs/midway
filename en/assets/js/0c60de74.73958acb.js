"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[21656],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>f});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=a.createContext({}),s=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=s(e.components);return a.createElement(p.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,p=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),m=s(n),c=i,f=m["".concat(p,".").concat(c)]||m[c]||u[c]||o;return n?a.createElement(f,r(r({ref:t},d),{},{components:n})):a.createElement(f,r({ref:t},d))}));function f(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=c;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[m]="string"==typeof e?e:i,r[1]=l;for(var s=2;s<o;s++)r[s]=n[s];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>r});var a=n(67294),i=n(86010);const o={tabItem:"tabItem_Ymn6"};function r(e){let{children:t,hidden:n,className:r}=e;return a.createElement("div",{role:"tabpanel",className:(0,i.Z)(o.tabItem,r),hidden:n},t)}},65488:(e,t,n)=>{n.d(t,{Z:()=>c});var a=n(87462),i=n(67294),o=n(86010),r=n(12466),l=n(70989),p=n(72389);const s={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function d(e){let{className:t,block:n,selectedValue:l,selectValue:p,tabValues:d}=e;const m=[],{blockElementScrollPositionUntilNextRender:u}=(0,r.o5)(),c=e=>{const t=e.currentTarget,n=m.indexOf(t),a=d[n].value;a!==l&&(u(t),p(a))},f=e=>{let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const n=m.indexOf(e.currentTarget)+1;t=m[n]??m[0];break}case"ArrowLeft":{const n=m.indexOf(e.currentTarget)-1;t=m[n]??m[m.length-1];break}}t?.focus()};return i.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.Z)("tabs",{"tabs--block":n},t)},d.map((e=>{let{value:t,label:n,attributes:r}=e;return i.createElement("li",(0,a.Z)({role:"tab",tabIndex:l===t?0:-1,"aria-selected":l===t,key:t,ref:e=>m.push(e),onKeyDown:f,onClick:c},r,{className:(0,o.Z)("tabs__item",s.tabItem,r?.className,{"tabs__item--active":l===t})}),n??t)})))}function m(e){let{lazy:t,children:n,selectedValue:a}=e;const o=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=o.find((e=>e.props.value===a));return e?(0,i.cloneElement)(e,{className:"margin-top--md"}):null}return i.createElement("div",{className:"margin-top--md"},o.map(((e,t)=>(0,i.cloneElement)(e,{key:t,hidden:e.props.value!==a}))))}function u(e){const t=(0,l.Y)(e);return i.createElement("div",{className:(0,o.Z)("tabs-container",s.tabList)},i.createElement(d,(0,a.Z)({},e,t)),i.createElement(m,(0,a.Z)({},e,t)))}function c(e){const t=(0,p.Z)();return i.createElement(u,(0,a.Z)({key:String(t)},e))}},70989:(e,t,n)=>{n.d(t,{Y:()=>u});var a=n(67294),i=n(16550),o=n(91980),r=n(67392),l=n(50012);function p(e){return function(e){return a.Children.map(e,(e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:a,default:i}}=e;return{value:t,label:n,attributes:a,default:i}}))}function s(e){const{values:t,children:n}=e;return(0,a.useMemo)((()=>{const e=t??p(n);return function(e){const t=(0,r.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function d(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function m(e){let{queryString:t=!1,groupId:n}=e;const r=(0,i.k6)(),l=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,o._X)(l),(0,a.useCallback)((e=>{if(!l)return;const t=new URLSearchParams(r.location.search);t.set(l,e),r.replace({...r.location,search:t.toString()})}),[l,r])]}function u(e){const{defaultValue:t,queryString:n=!1,groupId:i}=e,o=s(e),[r,p]=(0,a.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!d({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:o}))),[u,c]=m({queryString:n,groupId:i}),[f,h]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[i,o]=(0,l.Nk)(n);return[i,(0,a.useCallback)((e=>{n&&o.set(e)}),[n,o])]}({groupId:i}),y=(()=>{const e=u??f;return d({value:e,tabValues:o})?e:null})();(0,a.useLayoutEffect)((()=>{y&&p(y)}),[y]);return{selectedValue:r,selectValue:(0,a.useCallback)((e=>{if(!d({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);p(e),c(e),h(e)}),[c,h,o]),tabValues:o}}},79368:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>p,default:()=>f,frontMatter:()=>l,metadata:()=>s,toc:()=>m});var a=n(87462),i=(n(67294),n(3905)),o=n(65488),r=n(85162);const l={},p="File upload",s={unversionedId:"extensions/busboy",id:"extensions/busboy",title:"File upload",description:"A general upload component for @midwayjs/faas, @midwayjs/web, @midwayjs/koa and @midwayjs/express frameworks, supporting two modes: file (temporary server file) and stream.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/extensions/busboy.md",sourceDirName:"extensions",slug:"/extensions/busboy",permalink:"/en/docs/extensions/busboy",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/extensions/busboy.md",tags:[],version:"current",frontMatter:{}},d={},m=[{value:"Install dependencies",id:"install-dependencies",level:2},{value:"Enable component",id:"enable-component",level:2},{value:"Configure middleware",id:"configure-middleware",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Upload mode - file",id:"upload-mode---file",level:3},{value:"Upload mode - stream",id:"upload-mode---stream",level:3},{value:"Upload file suffix check",id:"upload-file-suffix-check",level:3},{value:"Upload file MIME type check",id:"upload-file-mime-type-check",level:3},{value:"Busboy upload limit",id:"busboy-upload-limit",level:3},{value:"Temporary files and cleanup",id:"temporary-files-and-cleanup",level:3},{value:"Setting configurations for different routes",id:"setting-configurations-for-different-routes",level:3},{value:"Built-in errors",id:"built-in-errors",level:2},{value:"Security tips",id:"security-tips",level:2},{value:"Front-end file upload example",id:"front-end-file-upload-example",level:2},{value:"1. HTML form format",id:"1-html-form-format",level:3},{value:"2. fetch FormData method",id:"2-fetch-formdata-method",level:3},{value:"Postman test example",id:"postman-test-example",level:2}],u={toc:m},c="wrapper";function f(e){let{components:t,...n}=e;return(0,i.kt)(c,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"file-upload"},"File upload"),(0,i.kt)("p",null,"A general upload component for ",(0,i.kt)("inlineCode",{parentName:"p"},"@midwayjs/faas"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"@midwayjs/web"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"@midwayjs/koa")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"@midwayjs/express")," frameworks, supporting two modes: ",(0,i.kt)("inlineCode",{parentName:"p"},"file")," (temporary server file) and ",(0,i.kt)("inlineCode",{parentName:"p"},"stream"),"."),(0,i.kt)("p",null,"Related information:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Web support"),(0,i.kt)("th",{parentName:"tr",align:null}))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"@midwayjs/koa"),(0,i.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"@midwayjs/faas"),(0,i.kt)("td",{parentName:"tr",align:null},"\ud83d\udcac")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"@midwayjs/web"),(0,i.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"@midwayjs/express"),(0,i.kt)("td",{parentName:"tr",align:null},"\u2705")))),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"\ud83d\udcac Some function computing platforms do not support streaming request responses, please refer to the corresponding platform capabilities.")),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"This module replaces the upload component since 3.17.0."),(0,i.kt)("p",{parentName:"admonition"},"The differences from the upload component are:"),(0,i.kt)("ul",{parentName:"admonition"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},"The configuration key is adjusted from ",(0,i.kt)("inlineCode",{parentName:"li"},"upload")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"busboy")))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li",start:2},(0,i.kt)("li",{parentName:"ol"},"The middleware is no longer loaded by default, and can be manually configured to the global or route"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li",start:3},(0,i.kt)("li",{parentName:"ol"},"The fieldName field is no longer provided for streaming upload, and the input parameter definition type is adjusted to ",(0,i.kt)("inlineCode",{parentName:"li"},"UploadStreamFileInfo")))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li",start:4},(0,i.kt)("li",{parentName:"ol"},"The configuration of ",(0,i.kt)("inlineCode",{parentName:"li"},"fileSize")," has been adjusted"))))),(0,i.kt)("h2",{id:"install-dependencies"},"Install dependencies"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i @midwayjs/busboy@3 --save\n")),(0,i.kt)("p",null,"Or add the following dependencies to ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," and reinstall."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n"dependencies": {\n  "@midwayjs/busboy": "^3.0.0",\n    // ...\n  },\n  "devDependencies": {\n    // ...\n  }\n}\n')),(0,i.kt)("h2",{id:"enable-component"},"Enable component"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuratin.ts\n\nimport { Configuration } from '@midwayjs/core';\nimport * as busboy from '@midwayjs/busboy';\n\n@Configuration({\n  imports: [\n    // ...other components\n    busboy\n  ],\n  // ...\n})\nexport class MainConfiguration {}\n")),(0,i.kt)("h2",{id:"configure-middleware"},"Configure middleware"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"UploadMiddleware")," middleware is provided in the component, which can be configured globally or to a specific route. It is recommended to configure it to a specific route to improve performance."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Route Middleware")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Post } from '@midwayjs/core';\nimport { UploadMiddleware } from '@midwayjs/busboy';\n\n@Controller('/')\nexport class HomeController {\n\n  @Post('/upload', middleares: [UploadMiddleware])\n  async upload(/*...*/) {\n    // ...\n  }\n}\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Global Middleware")),(0,i.kt)(o.Z,{mdxType:"Tabs"},(0,i.kt)(r.Z,{value:"koa",label:"@midwayjs/koa",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuratin.ts\n\nimport { Configuration } from '@midwayjs/core';\nimport * as busboy from '@midwayjs/busboy';\nimport { Application } from '@midwayjs/koa';\n\n@Configuration({\n  // ...\n})\nexport class MainConfiguration {\n  @App('koa')\n  app: Application;\n  \n  async onReady() {\n    this.app.useMiddleware(busboy.UploadMiddleware);\n  }\n}\n"))),(0,i.kt)(r.Z,{value:"egg",label:"@midwayjs/web",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuratin.ts\n\nimport { Configuration } from '@midwayjs/core';\nimport * as busboy from '@midwayjs/busboy';\nimport { Application } from '@midwayjs/web';\n\n@Configuration({\n  // ...\n})\nexport class MainConfiguration {\n  @App('egg')\n  app: Application;\n  \n  async onReady() {\n    this.app.useMiddleware(busboy.UploadMiddleware);\n  }\n}\n"))),(0,i.kt)(r.Z,{value:"express",label:"@midwayjs/express",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuratin.ts\n\nimport { Configuration } from '@midwayjs/core';\nimport * as busboy from '@midwayjs/busboy';\nimport { Application } from '@midwayjs/express';\n\n@Configuration({\n  // ...\n})\nexport class MainConfiguration {\n  @App('express')\n  app: Application;\n  \n  async onReady() {\n    this.app.useMiddleware(busboy.UploadMiddleware);\n  }\n}\n"))),(0,i.kt)(r.Z,{value:"faas",label:"@midwayjs/faas",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuratin.ts\n\nimport { Configuration } from '@midwayjs/core';\nimport * as busboy from '@midwayjs/busboy';\nimport { Application } from '@midwayjs/faas';\n\n@Configuration({\n  // ...\n})\nexport class MainConfiguration {\n  @App('faas')\n  app: Application;\n  \n  async onReady() {\n    this.app.useMiddleware(busboy.UploadMiddleware);\n  }\n}\n")))),(0,i.kt)("h2",{id:"configuration"},"Configuration"),(0,i.kt)("h3",{id:"upload-mode---file"},"Upload mode - file"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"file")," is the default value and the recommended value of the framework."),(0,i.kt)("p",null,"Configure the upload mode to be the ",(0,i.kt)("inlineCode",{parentName:"p"},"file")," string."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  busboy: {\n    mode: 'file',\n  },\n}\n\n")),(0,i.kt)("p",null,"Get the uploaded file in the code."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Post, Files, Fields } from '@midwayjs/core';\nimport { UploadFileInfo } from '@midwayjs/busboy';\n\n@Controller('/')\nexport class HomeController {\n\n  @Post('/upload')\n  async upload(@Files() files Array<UploadFileInfo>, @Fields() fields: Record<string, string) {\n    /*\n    files = [\n      {\n        filename: 'test.pdf',        // file name\n        data: '/var/tmp/xxx.pdf',    // Server temporary file address\n        mimeType: 'application/pdf', // mime\n      },\n      // ...Support uploading multiple files at the same time under file\n    ]\n    */\n    return {\n      files,\n      fields\n    }\n  }\n}\n")),(0,i.kt)("p",null,"When using file mode, the ",(0,i.kt)("inlineCode",{parentName:"p"},"data")," obtained from ",(0,i.kt)("inlineCode",{parentName:"p"},"this.ctx.files")," is the ",(0,i.kt)("inlineCode",{parentName:"p"},"temporary file address")," of the uploaded file on the server. The content of this file can be processed later by ",(0,i.kt)("inlineCode",{parentName:"p"},"fs.createReadStream")," and other methods."),(0,i.kt)("p",null,"When using file mode, it supports uploading multiple files at the same time, and multiple files will be stored in ",(0,i.kt)("inlineCode",{parentName:"p"},"this.ctx.files")," in the form of an array."),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"When using the ",(0,i.kt)("inlineCode",{parentName:"p"},"file")," mode, the upload component will match the ",(0,i.kt)("inlineCode",{parentName:"p"},"method")," of the request and some of the iconic contents in the ",(0,i.kt)("inlineCode",{parentName:"p"},"headers")," when receiving the request. If it is a file upload request, it will parse the request and ",(0,i.kt)("inlineCode",{parentName:"p"},"write")," the file in it to the temporary cache directory of the server. You can set the path that allows parsing files through the ",(0,i.kt)("inlineCode",{parentName:"p"},"match")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"ignore")," configuration of this component."),(0,i.kt)("p",{parentName:"admonition"},"After configuring ",(0,i.kt)("inlineCode",{parentName:"p"},"match")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"ignore"),", you can ensure that your ordinary post and other request interfaces will not be illegally used by users for upload, and you can ",(0,i.kt)("inlineCode",{parentName:"p"},"avoid")," the risk of the server cache being full."),(0,i.kt)("p",{parentName:"admonition"},"You can view the ",(0,i.kt)("inlineCode",{parentName:"p"},"Configure the upload path allowed (match) or ignored (ignore)")," section below to configure it.")),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"If the swagger component is enabled at the same time, be sure to add the type of the upload parameter (the type corresponding to the decorator and the type in @ApiBody), otherwise an error will be reported. For more information, please refer to the file upload section of swagger.")),(0,i.kt)("h3",{id:"upload-mode---stream"},"Upload mode - stream"),(0,i.kt)("p",null,"Configure the upload mode to be a ",(0,i.kt)("inlineCode",{parentName:"p"},"stream")," string."),(0,i.kt)("p",null,"When using stream mode, the ",(0,i.kt)("inlineCode",{parentName:"p"},"data")," obtained from ",(0,i.kt)("inlineCode",{parentName:"p"},"this.ctx.files")," is a ",(0,i.kt)("inlineCode",{parentName:"p"},"ReadStream"),", and the data can be transferred to other ",(0,i.kt)("inlineCode",{parentName:"p"},"WriteStream")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"TransformStream")," through ",(0,i.kt)("inlineCode",{parentName:"p"},"pipe")," and other methods."),(0,i.kt)("p",null,"When using stream mode, only one file is uploaded at a time, that is, there is only one file data object in the ",(0,i.kt)("inlineCode",{parentName:"p"},"this.ctx.files")," array."),(0,i.kt)("p",null,"In addition, stream mode ",(0,i.kt)("inlineCode",{parentName:"p"},"does not")," generate temporary files on the server, so there is no need to manually clean up the temporary file cache after obtaining the uploaded content."),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"The implementation method of Faas scenarios depends on the platform. If the platform does not support streaming request/response but the business has enabled ",(0,i.kt)("inlineCode",{parentName:"p"},"mode: 'stream'"),", it will be downgraded by reading it into memory first and then simulating streaming transmission.")),(0,i.kt)("p",null,"Get the uploaded file in the code. Only a single file is supported in streaming mode."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Post, Files, Fields } from '@midwayjs/core';\nimport { UploadStreamFileInfo } from '@midwayjs/busboy';\n\n@Controller('/')\nexport class HomeController {\n\n  @Post('/upload')\n  async upload(@Files() files: Array<UploadStreamFileInfo>, @Fields() fields: Record<string, string) {\n    /*\n    files = [\n      {\n        filename: 'test.pdf',        // file name\n        data: ReadStream,                    // file stream\n        mimeType: 'application/pdf', // mime\n      },\n    ]\n\n    */\n    return {\n      files,\n      fields\n    }\n  }\n}\n")),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"If the swagger component is enabled at the same time, be sure to add the type of the upload parameter (the type corresponding to the decorator and the type in @ApiBody), otherwise an error will be reported. For more information, please refer to the file upload section of swagger.")),(0,i.kt)("h3",{id:"upload-file-suffix-check"},"Upload file suffix check"),(0,i.kt)("p",null,"Use the ",(0,i.kt)("inlineCode",{parentName:"p"},"whitelist")," property to configure the file suffixes allowed for upload. If ",(0,i.kt)("inlineCode",{parentName:"p"},"null")," is configured, the suffix will not be checked."),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"If ",(0,i.kt)("inlineCode",{parentName:"p"},"null")," is configured, the uploaded file suffix will not be checked. If the file upload mode (mode=file) is adopted, it may be exploited by attackers to upload WebShells with suffixes such as ",(0,i.kt)("inlineCode",{parentName:"p"},".php")," and ",(0,i.kt)("inlineCode",{parentName:"p"},".asp")," to implement attack behaviors."),(0,i.kt)("p",{parentName:"admonition"},"Of course, since the component will ",(0,i.kt)("inlineCode",{parentName:"p"},"re-randomly generate")," the file name for the uploaded temporary file, as long as the developer ",(0,i.kt)("inlineCode",{parentName:"p"},"does not return")," the uploaded temporary file address to the user, even if the user uploads some unexpected files, there is no need to worry too much about being exploited.")),(0,i.kt)("p",null,"If the uploaded file suffix does not match, it will respond with ",(0,i.kt)("inlineCode",{parentName:"p"},"400")," error. The default values are as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"'.jpg',\n'.jpeg',\n'.png',\n'.gif',\n'.bmp',\n'.wbmp',\n'.webp',\n'.tif',\n'.psd',\n'.svg',\n'.js',\n'.jsx',\n'.json',\n'.css',\n'.less',\n'.html',\n'.htm',\n'.xml',\n'.pdf',\n'.zip',\n'.gz',\n'.tgz',\n'.gzip',\n'.mp3',\n'.mp4',\n'.avi',\n")),(0,i.kt)("p",null,"The default suffix whitelist can be obtained through the ",(0,i.kt)("inlineCode",{parentName:"p"},"uploadWhiteList")," exported in the component."),(0,i.kt)("p",null,"In addition, in order to prevent some ",(0,i.kt)("inlineCode",{parentName:"p"},"malicious users")," from using certain technical means to ",(0,i.kt)("inlineCode",{parentName:"p"},"forge")," some extensions that can be truncated, the midway upload component will filter the binary data of the obtained extensions, and only support characters in the range of ",(0,i.kt)("inlineCode",{parentName:"p"},"0x2e")," (that is, English dot ",(0,i.kt)("inlineCode",{parentName:"p"},"."),"), ",(0,i.kt)("inlineCode",{parentName:"p"},"0x30-0x39")," (that is, numbers ",(0,i.kt)("inlineCode",{parentName:"p"},"0-9"),"), and ",(0,i.kt)("inlineCode",{parentName:"p"},"0x61-0x7a")," (that is, lowercase letters ",(0,i.kt)("inlineCode",{parentName:"p"},"a-z"),") as extensions. Other characters will be automatically ignored."),(0,i.kt)("p",null,"You can pass a function to dynamically return the whitelist based on different conditions."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { uploadWhiteList } from '@midwayjs/busboy';\nimport { tmpdir } from 'os';\nimport { join } from 'path';\n\nexport default {\n  // ...\n  busboy: {\n    whitelist: (ctx) => {\n      if (ctx.path === '/') {\n        return [\n          '.jpg',\n          '.jpeg',\n        ];\n      } else {\n        return [\n          '.jpg',\n        ]\n      };\n    },\n    // ...\n  },\n}\n")),(0,i.kt)("h3",{id:"upload-file-mime-type-check"},"Upload file MIME type check"),(0,i.kt)("p",null,"Some malicious users will try to modify the extension of WebShell such as ",(0,i.kt)("inlineCode",{parentName:"p"},".php")," to ",(0,i.kt)("inlineCode",{parentName:"p"},".jpg")," to bypass the whitelist filtering rules based on extensions. In some server environments, this jpg file will still be executed as a PHP script, causing security risks."),(0,i.kt)("p",null,"The component provides the ",(0,i.kt)("inlineCode",{parentName:"p"},"mimeTypeWhiteList")," configuration parameter ",(0,i.kt)("strong",{parentName:"p"},"[Please note that this parameter has no default value, that is, it is not checked by default]"),". You can use this configuration to set the allowed file MIME format. The rule is a ",(0,i.kt)("inlineCode",{parentName:"p"},"secondary array")," composed of the array ",(0,i.kt)("inlineCode",{parentName:"p"},"[extension, mime, [...moreMime]]"),", for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { uploadWhiteList } from '@midwayjs/busboy';\nexport default {\n  // ...\n  busboy: {\n    // ...\n    // Extension whitelist\n    whitelist: uploadWhiteList,\n    // Only the following file types are allowed to be uploaded\n    mimeTypeWhiteList: {\n      '.jpg': 'image/jpeg',\n      // You can also set multiple MIME types. For example, the following allows files with the .jpeg suffix to be either jpg or png.\n      '.jpeg': ['image/jpeg', 'image/png'],\n      // Other types\n      '.gif': 'image/gif',\n      '.bmp': 'image/bmp',\n      '.wbmp': 'image/vnd.wap.wbmp',\n      '.webp': 'image/webp',\n    }\n  },\n}\n")),(0,i.kt)("p",null,"You can also use the ",(0,i.kt)("inlineCode",{parentName:"p"},"DefaultUploadFileMimeType")," variable provided by the component as the default MIME validation rule, which provides MIME data for commonly used file extensions such as ",(0,i.kt)("inlineCode",{parentName:"p"},".jpg"),", ",(0,i.kt)("inlineCode",{parentName:"p"},".png"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},".psd"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { uploadWhiteList, DefaultUploadFileMimeType } from '@midwayjs/busboy';\nexport default {\n  // ...\n  busboy: {\n    // ...\n    // Extension whitelist\n    whitelist: uploadWhiteList,\n    // Only the following file types are allowed to be uploaded\n    mimeTypeWhiteList: DefaultUploadFileMimeType,\n  },\n}\n")),(0,i.kt)("p",null,"You can query the file format and the corresponding MIME mapping through the website ",(0,i.kt)("inlineCode",{parentName:"p"},"https://mimetype.io/"),". For the MIME identification of files, we use the npm package ",(0,i.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/file-type"},"file-type@16"),". Please pay attention to the file types it supports."),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},"MIME type verification rules only apply to file upload mode ",(0,i.kt)("inlineCode",{parentName:"p"},"mode=file"),". After setting this verification rule, the upload performance will be slightly affected because the file content needs to be read for matching."),(0,i.kt)("p",{parentName:"admonition"},"However, we still recommend that you set the ",(0,i.kt)("inlineCode",{parentName:"p"},"mimeTypeWhiteList")," parameter when conditions permit, which will improve the security of your application.")),(0,i.kt)("p",null,"You can pass a function that can dynamically return MIME rules based on different conditions."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { tmpdir } from 'os';\nimport { join } from 'path';\n\nexport default {\n  // ...\n  busboy: {\n    mimeTypeWhiteList: (ctx) => {\n      if (ctx.path === '/') {\n        return {\n          '.jpg': 'image/jpeg',\n        };\n      } else {\n        return {\n          '.jpeg': ['image/jpeg', 'image/png'],\n        }\n      };\n    }\n  },\n}\n\n")),(0,i.kt)("h3",{id:"busboy-upload-limit"},"Busboy upload limit"),(0,i.kt)("p",null,"By default, there is no limit, which can be modified through configuration, digital type, unit is byte."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  busboy: {\n    // ...\n    limits: {\n      fileSize: 1024\n    }\n  },\n}\n")),(0,i.kt)("p",null,"In addition, you can set some other ",(0,i.kt)("a",{parentName:"p",href:"(https://github.com/mscdex/busboy/tree/master?tab=readme-ov-file#exports)."},"limits"),"."),(0,i.kt)("h3",{id:"temporary-files-and-cleanup"},"Temporary files and cleanup"),(0,i.kt)("p",null,"If you use the ",(0,i.kt)("inlineCode",{parentName:"p"},"file")," mode to get the uploaded files, the uploaded files will be stored in the folder pointed to by the ",(0,i.kt)("inlineCode",{parentName:"p"},"tmpdir")," option in the ",(0,i.kt)("inlineCode",{parentName:"p"},"upload")," component configuration you set in the ",(0,i.kt)("inlineCode",{parentName:"p"},"config")," file."),(0,i.kt)("p",null,"You can control the automatic temporary file cleanup time by using ",(0,i.kt)("inlineCode",{parentName:"p"},"cleanTimeout")," in the configuration. The default value is ",(0,i.kt)("inlineCode",{parentName:"p"},"5 * 60 * 1000"),", that is, the uploaded files will be automatically cleaned up after ",(0,i.kt)("inlineCode",{parentName:"p"},"5 minutes"),". Setting it to ",(0,i.kt)("inlineCode",{parentName:"p"},"0")," will disable the automatic cleanup function."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { uploadWhiteList } from '@midwayjs/busboy';\nimport { tmpdir } from 'os';\nimport { join } from 'path';\n\nexport default {\n  // ...\n  busboy: {\n    mode: 'file',\n    tmpdir: join(tmpdir(), 'midway-busboy-files'),\n    cleanTimeout: 5 * 60 * 1000,\n  },\n}\n\n")),(0,i.kt)("p",null,"You can also call ",(0,i.kt)("inlineCode",{parentName:"p"},"await ctx.cleanupRequestFiles()")," in the code to actively clean up temporary files uploaded by the current request."),(0,i.kt)("h3",{id:"setting-configurations-for-different-routes"},"Setting configurations for different routes"),(0,i.kt)("p",null,"Different middleware instances can be used to configure different routes differently. In this scenario, the global configuration will be merged and only a small part of the configuration can be covered."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, Post, Files, Fields } from '@midwayjs/core';\nimport { UploadFileInfo, UploadMiddleware } from '@midwayjs/busboy';\n\n@Controller('/')\nexport class HomeController {\n  @Post('/upload1', { middlewares: [ createMiddleware(UploadMiddleware, {mode: 'file'}) ]})\n  async upload1(@Files() files Array<UploadFileInfo>) {\n    // ...\n  }\n  \n  @Post('/upload2', { middlewares: [ createMiddleware(UploadMiddleware, {mode: 'stream'}) ]})\n  async upload2(@Files() files Array<UploadFileInfo>) {\n    // ...\n  }\n}\n")),(0,i.kt)("p",null,"Currently the configurations that can be passed include ",(0,i.kt)("inlineCode",{parentName:"p"},"mode")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"busboy"),"'s own ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/mscdex/busboy/tree/master?tab=readme-ov-file#exports"},"configuration"),"."),(0,i.kt)("h2",{id:"built-in-errors"},"Built-in errors"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"MultipartInvalidFilenameError")," Invalid file name"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"MultipartInvalidFileTypeError")," Invalid file type"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"MultipartFileSizeLimitError")," File size exceeds limit"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"MultipartFileLimitError")," Number of files exceeds limit"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"MultipartPartsLimitError")," Number of uploaded parts exceeds limit"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"MultipartFieldsLimitError")," Number of fields exceeds limit"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"MultipartError")," Other busbuy errors")),(0,i.kt)("h2",{id:"security-tips"},"Security tips"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Please pay attention to whether to enable ",(0,i.kt)("inlineCode",{parentName:"p"},"extension whitelist")," (whiteList). If the extension whitelist is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"null"),", it may be used by attackers to upload ",(0,i.kt)("inlineCode",{parentName:"p"},".php"),", ",(0,i.kt)("inlineCode",{parentName:"p"},".asp")," and other WebShells.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Please pay attention to whether to set ",(0,i.kt)("inlineCode",{parentName:"p"},"match")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"ignore")," rules, otherwise ordinary ",(0,i.kt)("inlineCode",{parentName:"p"},"POST/PUT")," and other interfaces may be used by attackers, causing server load to increase and space to occupy a lot of problems.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Please pay attention to whether ",(0,i.kt)("inlineCode",{parentName:"p"},"file type rules")," (fileTypeWhiteList) are set, otherwise the attacker may forge the file type for uploading."))),(0,i.kt)("h2",{id:"front-end-file-upload-example"},"Front-end file upload example"),(0,i.kt)("h3",{id:"1-html-form-format"},"1. HTML form format"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<form action="/api/upload" method="post" enctype="multipart/form-data">\n  Name: <input type="text" name="name" /><br />\n  File: <input type="file" name="testFile" /><br />\n  <input type="submit" value="Submit" />\n</form>\n')),(0,i.kt)("h3",{id:"2-fetch-formdata-method"},"2. fetch FormData method"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const fileInput = document.querySelector('#your-file-input') ;\nconst formData = new FormData();\nformData.append('file', fileInput.files[0]);\n\nfetch('/api/upload', {\n  method: 'POST',\n  body: formData,\n});\n")),(0,i.kt)("h2",{id:"postman-test-example"},"Postman test example"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://img.alicdn.com/imgextra/i4/O1CN01iv9ESW1uIShNiRjBF_!!6000000006014-2-tps-2086-1746.png",alt:null})))}f.isMDXComponent=!0}}]);