"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[82262],{3905:(e,t,n)=>{n.d(t,{Zo:()=>g,kt:()=>m});var o=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=o.createContext({}),s=function(e){var t=o.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},g=function(e){var t=s(e.components);return o.createElement(p.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},c=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,p=e.parentName,g=i(e,["components","mdxType","originalType","parentName"]),u=s(n),c=r,m=u["".concat(p,".").concat(c)]||u[c]||d[c]||a;return n?o.createElement(m,l(l({ref:t},g),{},{components:n})):o.createElement(m,l({ref:t},g))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,l=new Array(a);l[0]=c;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i[u]="string"==typeof e?e:r,l[1]=i;for(var s=2;s<a;s++)l[s]=n[s];return o.createElement.apply(null,l)}return o.createElement.apply(null,n)}c.displayName="MDXCreateElement"},27690:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>d,frontMatter:()=>a,metadata:()=>i,toc:()=>s});var o=n(87462),r=(n(67294),n(3905));const a={},l="Logger",i={unversionedId:"logger",id:"logger",title:"Logger",description:"This document is for @midwayjs/logger v2.0 version.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/logger.md",sourceDirName:".",slug:"/logger",permalink:"/en/docs/logger",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/logger.md",tags:[],version:"current",frontMatter:{},sidebar:"common",previous:{title:"Awesome Midway",permalink:"/en/docs/awesome_midway"},next:{title:"Midway CLI",permalink:"/en/docs/tool/cli"}},p={},s=[{value:"Loger path and file",id:"loger-path-and-file",level:2},{value:"Default loger object",id:"default-loger-object",level:2},{value:"Use log",id:"use-log",level:2},{value:"Context log",id:"context-log",level:3},{value:"App Logger",id:"app-logger",level:3},{value:"CoreLogger",id:"corelogger",level:3},{value:"Output method and format",id:"output-method-and-format",level:2},{value:"Default output behavior",id:"default-output-behavior",level:3},{value:"Error output",id:"error-output",level:3},{value:"Format content",id:"format-content",level:3},{value:"Output custom objects or complex types",id:"output-custom-objects-or-complex-types",level:3},{value:"Pure output content",id:"pure-output-content",level:3},{value:"Log type definition",id:"log-type-definition",level:2},{value:"Basic log configuration",id:"basic-log-configuration",level:2},{value:"Configure log level",id:"configure-log-level",level:2},{value:"The default level of the framework",id:"the-default-level-of-the-framework",level:3},{value:"Adjust log level",id:"adjust-log-level",level:3},{value:"Configure the log root directory",id:"configure-the-log-root-directory",level:2},{value:"Configure log cutting (rotation)",id:"configure-log-cutting-rotation",level:2},{value:"Configure log cleanup",id:"configure-log-cleanup",level:2},{value:"Advanced configuration",id:"advanced-configuration",level:2},{value:"Add custom log",id:"add-custom-log",level:3},{value:"Configure log output format",id:"configure-log-output-format",level:3},{value:"Get a custom context log",id:"get-a-custom-context-log",level:3},{value:"Configure the context log output format",id:"configure-the-context-log-output-format",level:3},{value:"Log default Transport",id:"log-default-transport",level:3},{value:"Custom Transport",id:"custom-transport",level:3},{value:"Lazy initialization",id:"lazy-initialization",level:3},{value:"Frequently Asked Questions",id:"frequently-asked-questions",level:2},{value:"1. The server environment log is not output",id:"1-the-server-environment-log-is-not-output",level:3},{value:"2. The server does not have a console log",id:"2-the-server-does-not-have-a-console-log",level:3}],g={toc:s},u="wrapper";function d(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,o.Z)({},g,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"logger"},"Logger"),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"This document is for ",(0,r.kt)("inlineCode",{parentName:"p"},"@midwayjs/logger")," v2.0 version.")),(0,r.kt)("p",null,"Midway provides a unified log access method for different scenarios. The ",(0,r.kt)("inlineCode",{parentName:"p"},"@midwayjs/logger")," package export method allows you to easily access log systems in different scenarios."),(0,r.kt)("p",null,"Midway's log system is based on the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/winstonjs/winston"},"winston")," of the community and is now a very popular log library in the community."),(0,r.kt)("p",null,"The functions realized are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Log classification"),(0,r.kt)("li",{parentName:"ul"},"Automatic cutting by size and time"),(0,r.kt)("li",{parentName:"ul"},"Custom output format"),(0,r.kt)("li",{parentName:"ul"},"Unified error log")),(0,r.kt)("h2",{id:"loger-path-and-file"},"Loger path and file"),(0,r.kt)("p",null,"Midway creates some default files in the log root directory."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"midway-core.log")," logs of printed information of the framework and components, corresponding to the ",(0,r.kt)("inlineCode",{parentName:"li"},"coreLogger"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"midway-app.log")," applies the log of printing information, corresponding to the ",(0,r.kt)("inlineCode",{parentName:"li"},"appLogger")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"common-error.log")," The log of all errors (all logs created by Midway will repeatedly print errors to this file)")),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"Log Path")," and ",(0,r.kt)("strong",{parentName:"p"},"Log Level")," of local development and server deployment are different. For more information, see ","[Configure Log Root]","(# Configure the log root directory) and ","[Default Level]","(# The default level of the framework)."),(0,r.kt)("h2",{id:"default-loger-object"},"Default loger object"),(0,r.kt)("p",null,"Midway provides three different logs in the framework by default, corresponding to three different behaviors."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Log"),(0,r.kt)("th",{parentName:"tr",align:null},"Interpretation"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null},"Common use"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"coreLogger"),(0,r.kt)("td",{parentName:"tr",align:null},"Framework, component-level logs"),(0,r.kt)("td",{parentName:"tr",align:null},"By default, the console log and text log ",(0,r.kt)("inlineCode",{parentName:"td"},"midway-core.log")," are output, and the error log is sent to ",(0,r.kt)("inlineCode",{parentName:"td"},"common-error.log")," by default."),(0,r.kt)("td",{parentName:"tr",align:null},"Frames and component errors are generally printed into them.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"appLogger"),(0,r.kt)("td",{parentName:"tr",align:null},"Logs at the business level"),(0,r.kt)("td",{parentName:"tr",align:null},"The ",(0,r.kt)("inlineCode",{parentName:"td"},"midway-app.log")," of the console log and text log is output by default, and the error log is sent to ",(0,r.kt)("inlineCode",{parentName:"td"},"common-error.log")," by default."),(0,r.kt)("td",{parentName:"tr",align:null},"The log used by the business. Generally, the business log will be printed in it.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Context Logger (Configuration of Multiplexing appLogger)"),(0,r.kt)("td",{parentName:"tr",align:null},"Log of request link"),(0,r.kt)("td",{parentName:"tr",align:null},"By default, ",(0,r.kt)("inlineCode",{parentName:"td"},"appLogger")," is used for output. In addition to sending error logs to ",(0,r.kt)("inlineCode",{parentName:"td"},"common-error.log"),", context information is added."),(0,r.kt)("td",{parentName:"tr",align:null},"Modify the label (Label) of log output. Different frameworks have different request labels. For example, under HTTP, routing information will be output.")))),(0,r.kt)("h2",{id:"use-log"},"Use log"),(0,r.kt)("p",null,"Midway's common log usage method."),(0,r.kt)("h3",{id:"context-log"},"Context log"),(0,r.kt)("p",null,"The context log is the log associated with the framework context object (Context)."),(0,r.kt)("p",null,"You can ",(0,r.kt)("a",{parentName:"p",href:"./req_res_app"},"obtain the ctx object")," and then use the ",(0,r.kt)("inlineCode",{parentName:"p"},"ctx.logger")," object to print and output logs."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"ctx.logger.info(\"hello world\");\nctx.logger.debug('debug info');\nctx.logger.warn('WARNNING!!!!');\n\n// Error log recording will directly record the complete stack information of the error log and output it to the errorLog\n// In order to ensure that exceptions can be traced, all exceptions thrown must be of Error type, because only Error type will bring stack information to locate the problem.\nctx.logger.error(new Error('custom error'));\n")),(0,r.kt)("p",null,"After execution, we can see the log output in two places:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The console sees the output."),(0,r.kt)("li",{parentName:"ul"},"In the midway-app.log file of the log directory")),(0,r.kt)("p",null,"Output result:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"2021-07-22 14:50:59,388 INFO 7739 [-/::ffff:127.0.0.1/-/0ms GET /api/get_user] hello world\n")),(0,r.kt)("p",null,"In the injection form, you can also use ",(0,r.kt)("inlineCode",{parentName:"p"},"@Inject() logger")," to inject ",(0,r.kt)("inlineCode",{parentName:"p"},"ctx.logger"),", which is equivalent to calling ",(0,r.kt)("inlineCode",{parentName:"p"},"ctx.logger")," directly."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Get, Inject, Controller, Provide } from '@midwayjs/core';\nimport { ILogger } from '@midwayjs/logger';\n\n@Controller()\nexport class HelloController {\n\n  @Inject()\n  logger: ILogger;\n\n  @Inject()\n  ctx;\n\n  @Get(\"/\")\n  async hello() {\n    // ...\n\n    // this.logger === ctx.logger\n  }\n}\n")),(0,r.kt)("h3",{id:"app-logger"},"App Logger"),(0,r.kt)("p",null,"If we want to do some application-level logging, such as recording some data information during the startup phase, we can do it through App Logger."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Configuration, Logger } from '@midwayjs/core';\nimport { ILogger } from '@midwayjs/logger';\n\n@Configuration()\nexport class MainConfiguration implements ILifeCycle {\n\n  @Logger()\n  logger: ILogger;\n\n  async onReady(container: IMidwayContainer): Promise<void> {\n    this.logger.debug('debug info');\n    This.logger.info ('startup takes% d ms', Date.now() - start);\n    this.logger.warn('warning!');\n\n    this.logger.error(someErrorObj);\n  }\n\n}\n")),(0,r.kt)("p",null,"Note that the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Logger()")," decorator is used here."),(0,r.kt)("h3",{id:"corelogger"},"CoreLogger"),(0,r.kt)("p",null,"In research and development at the component or framework level, we will use coreLogger to log."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"\n@Configuration()\nexport class MainConfiguration implements ILifeCycle {\n\n  @Logger('coreLogger')\n  logger: ILogger;\n\n  async onReady(container: IMidwayContainer): Promise<void> {\n    this.logger.debug('debug info');\n    This.logger.info ('startup takes% D MS', Date.now() -Start);\n    this.logger.warn('warning!');\n\n    this.logger.error(someErrorObj);\n  }\n\n}\n")),(0,r.kt)("h2",{id:"output-method-and-format"},"Output method and format"),(0,r.kt)("p",null,"The log object of Midway inherits the log object of the winston. In general, only four methods are provided: ",(0,r.kt)("inlineCode",{parentName:"p"},"error()"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"war ()"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"info()"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"debug"),"."),(0,r.kt)("p",null,"An example is as follows."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"logger.debug('debug info');\nlogger.info('startup takes% d ms', Date.now() - start);\nlogger.warn('warning!');\nlogger.error(new Error('my error'));\n")),(0,r.kt)("h3",{id:"default-output-behavior"},"Default output behavior"),(0,r.kt)("p",null,"In most common types, the logstore works well."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"logger.info('hello world'); // Output string\nlogger.info(123); //Output Number\nlogger.info(['B', 'c']); // Output array\nlogger.info(new Set([2, 3, 4])); // Output Set\nlogger.info(new Map([['key1', 'value1'], ['key2', 'value2']])); // Output Map\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Midway has specially customized the ",(0,r.kt)("inlineCode",{parentName:"p"},"Array"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Set"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"Map")," types that winston cannot output to enable them to output normally.")),(0,r.kt)("p",null,"However, it should be noted that under normal circumstances, the log object can only pass in one parameter, and its second parameter has other functions."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"logger.info('plain error message', 321); // 321 will be ignored\n")),(0,r.kt)("h3",{id:"error-output"},"Error output"),(0,r.kt)("p",null,"For the wrong object, Midway has also customized the winston so that it can be easily combined with ordinary text for output."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// Output error object\nlogger.error(new Error('error instance'));\n\n// Output custom error object\nconst error = new Error('named error instance');\nerror.name = 'NamedError';\nlogger.error(error);\n\n// Text before, plus error instance\nlogger.info('text before error', new Error('error instance after text'));\n")),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Note that the error object can only be placed at the end, and there is only one, and all parameters after it will be ignored.")),(0,r.kt)("h3",{id:"format-content"},"Format content"),(0,r.kt)("p",null,"The format method based on ",(0,r.kt)("inlineCode",{parentName:"p"},"util.format"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"logger.info('%s %d', 'aaa', 222);\n")),(0,r.kt)("p",null,"Commonly used are"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"%s")," string is occupied."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"%d")," digit occupancy"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"%j")," json placeholder")),(0,r.kt)("p",null,"For more information, see the ",(0,r.kt)("a",{parentName:"p",href:"https://nodejs.org/dist/latest-v14.x/docs/api/util.html#util_util_format_format_args"},"util.format")," method of Node. js."),(0,r.kt)("h3",{id:"output-custom-objects-or-complex-types"},"Output custom objects or complex types"),(0,r.kt)("p",null,"Based on performance considerations, Midway(winston) only outputs basic types most of the time, so when the output parameter is an advanced object, the user ",(0,r.kt)("strong",{parentName:"p"},"needs to manually convert it to a string")," that needs to be printed."),(0,r.kt)("p",null,"The following example will not get the desired result."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"const obj = {a: 1};\nlogger.info(obj); // By default, output [object Object]\n")),(0,r.kt)("p",null,"You need to manually output what you want to print."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"const obj = {a: 1};\nlogger.info(JSON.stringify(obj)); // formatted text can be output\nlogger.info(obj.a); // Direct output attribute value\nlogger.info('%j', a); // Direct placeholder output entire json\n")),(0,r.kt)("h3",{id:"pure-output-content"},"Pure output content"),(0,r.kt)("p",null,"In special scenarios, we need to simply output content, and do not want to output timestamps, labels and other format-related information. For this requirement, we can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"write")," method."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"write")," method is a very low-level method, and no matter what level of logs are written to the file."),(0,r.kt)("p",null,"Although the ",(0,r.kt)("inlineCode",{parentName:"p"},"write")," method is available on every logger, we only provide it in the ",(0,r.kt)("inlineCode",{parentName:"p"},"IMidwayLogger")," definition, and we hope you can clearly know that you want to call it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"(logger as IMidwayLogger).write('hello world'); // There will only be hello world in the file\n")),(0,r.kt)("h2",{id:"log-type-definition"},"Log type definition"),(0,r.kt)("p",null,"By default, users should use the simplest ",(0,r.kt)("inlineCode",{parentName:"p"},"ILogger")," definition."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide, Logger } from '@midwayjs/core';\nimport { ILogger } from '@midwayjs/logger';\n\n@Provide()\nexport class UserService {\n\n  @Inject()\n  logger: ILogger; // Get context log\n\n  async getUser() {\n    this.logger.info('hello user');\n  }\n\n}\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"ILogger")," definition provides only the simplest ",(0,r.kt)("inlineCode",{parentName:"p"},"debug"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"info"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"WARN"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"error")," methods."),(0,r.kt)("p",null,"In some scenarios, we need more complex definitions, such as modifying log attributes or dynamically adjusting. At this time, we need to use more complex ",(0,r.kt)("inlineCode",{parentName:"p"},"IMidwayLogger")," definitions."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide, Logger } from '@midwayjs/core';\nimport { IMidwayLogger } from '@midwayjs/logger';\n\n@Provide()\nexport class UserService {\n\n  @Inject()\n  logger: IMidwayLogger; // Get context log\n\n  async getUser() {\n    This. Logger. disableConsole(); // Prohibit console output\n    this.logger.info('hello user'); // This sentence is not visible in the console\n    This. Logger. enableConsole(); // Turn on console output\n    this.logger.info('hello user'); // This sentence can be seen in the console\n  }\n\n}\n")),(0,r.kt)("p",null,"The definition of the ",(0,r.kt)("inlineCode",{parentName:"p"},"IMidwayLogger")," can refer to the description in the interface or view the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/midwayjs/logger/blob/main/src/interface.ts"},"code"),"."),(0,r.kt)("h2",{id:"basic-log-configuration"},"Basic log configuration"),(0,r.kt)("p",null,"We can configure various behaviors of the log in the configuration file."),(0,r.kt)("p",null,"The log configuration in Midway includes ",(0,r.kt)("strong",{parentName:"p"},"Global Configuration")," and ",(0,r.kt)("strong",{parentName:"p"},"Single Log Configuration"),". The two configurations are merged and overwritten."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { MidwayConfig } from '@midwayjs/core';\n\nexport default {\n  midwayLogger: {\n    default: {\n      // ...\n    },\n    clients: {\n      coreLogger: {\n        // ...\n      },\n      appLogger: {\n        // ...\n      }\n    }\n  },\n} as MidwayConfig;\n")),(0,r.kt)("p",null,"As mentioned above, each object in the ",(0,r.kt)("inlineCode",{parentName:"p"},"clients")," configuration segment is an independent log configuration item, and its configuration will be merged with the ",(0,r.kt)("inlineCode",{parentName:"p"},"default")," segment to create a logger instance."),(0,r.kt)("h2",{id:"configure-log-level"},"Configure log level"),(0,r.kt)("p",null,"The winston log levels are divided into the following categories, and the log levels decrease in turn (the larger the number, the lower the level):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"const levels = {\n  none: 0\n  error: 1\n  trace: 2\n  warn: 3\n  info: 4\n  verbose: 5\n  debug: 6\n  silly: 7\n  all: 8\n}\n")),(0,r.kt)("p",null,"In order to simplify the Midway, we usually use only four levels: ",(0,r.kt)("inlineCode",{parentName:"p"},"error"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"war"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"info"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"debug"),"."),(0,r.kt)("p",null,"The log level represents the lowest level that can currently output logs. For example, if your log level is set to ",(0,r.kt)("inlineCode",{parentName:"p"},"WARN"),", only logs of the ",(0,r.kt)("inlineCode",{parentName:"p"},"WARN")," and higher ",(0,r.kt)("inlineCode",{parentName:"p"},"error")," level can be output."),(0,r.kt)("p",null,"In Midway, different log levels can be configured for different output behaviors."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Level")," Log Level of Text Written"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"consoleLevel")," the log level output from the console")),(0,r.kt)("h3",{id:"the-default-level-of-the-framework"},"The default level of the framework"),(0,r.kt)("p",null,"In Midway, it has its own default log level."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"In the development environment (local,test,unittest), the text and console log levels are unified to ",(0,r.kt)("inlineCode",{parentName:"li"},"info"),"."),(0,r.kt)("li",{parentName:"ul"},"In the server environment (except the development environment), in order to reduce the number of logs, the log level of ",(0,r.kt)("inlineCode",{parentName:"li"},"coreLogger")," is ",(0,r.kt)("inlineCode",{parentName:"li"},"warn"),", while other logs are ",(0,r.kt)("inlineCode",{parentName:"li"},"info"),".")),(0,r.kt)("h3",{id:"adjust-log-level"},"Adjust log level"),(0,r.kt)("p",null,"In general, we do not recommend adjusting the global default log level, but adjust the log level of a specific logger, for example:"),(0,r.kt)("p",null,"Adjust ",(0,r.kt)("inlineCode",{parentName:"p"},"coreLogger")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"appLogger"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { MidwayConfig } from '@midwayjs/core';\n\nexport default {\n  midwayLogger: {\n    clients: {\n      coreLogger: {\n        level: 'warn',\n        consoleLevel: 'warn'\n        // ...\n      },\n      appLogger: {\n        level: 'warn',\n        consoleLevel: 'warn'\n        // ...\n      }\n    }\n  },\n} as MidwayConfig;\n")),(0,r.kt)("p",null,"In special scenarios, you can also temporarily adjust the global log level."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { MidwayConfig } from '@midwayjs/core';\n\nexport default {\n  midwayLogger: {\n    default: {\n      level: 'info',\n      consoleLevel: 'warn'\n    },\n    // ...\n  },\n} as MidwayConfig;\n")),(0,r.kt)("h2",{id:"configure-the-log-root-directory"},"Configure the log root directory"),(0,r.kt)("p",null,"By default, Midway outputs logs to the ",(0,r.kt)("strong",{parentName:"p"},"root directory")," during local development and server deployment."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The root directory of the local log is ",(0,r.kt)("inlineCode",{parentName:"li"},"${app.appDir}/logs/project name"),"."),(0,r.kt)("li",{parentName:"ul"},"The log root directory of the server is under the user directory ",(0,r.kt)("inlineCode",{parentName:"li"},"${process.env.HOME}/logs/project_name")," (Linux/Mac) and ",(0,r.kt)("inlineCode",{parentName:"li"},"${process.env.USERPROFILE}/logs/project_name")," (Windows), for example ",(0,r.kt)("inlineCode",{parentName:"li"},"/home/admin/logs/example-app"),".")),(0,r.kt)("p",null,"We can configure the root directory where the log is located."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { MidwayConfig } from '@midwayjs/core';\n\nexport default {\n  midwayLogger: {\n    default: {\n      dir: '/home/admin/logs',\n    },\n    // ...\n  },\n} as MidwayConfig;\n")),(0,r.kt)("h2",{id:"configure-log-cutting-rotation"},"Configure log cutting (rotation)"),(0,r.kt)("p",null,"By default, the same log object ",(0,r.kt)("strong",{parentName:"p"},"generates two files"),"."),(0,r.kt)("p",null,"Take ",(0,r.kt)("inlineCode",{parentName:"p"},"midway-core.log")," as an example. When the application is started, a ",(0,r.kt)("inlineCode",{parentName:"p"},"midway-core with the timestamp of the day is generated. YYYY-MM files in-DD")," format and a soft chain file of ",(0,r.kt)("inlineCode",{parentName:"p"},"midway-core.log")," without timestamp."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Soft chain will not be generated under windows")),(0,r.kt)("p",null,"To facilitate log collection and viewing, the soft chain file always points to the latest log file."),(0,r.kt)("p",null,"At ",(0,r.kt)("inlineCode",{parentName:"p"},"00:00")," in the morning, a new file of the form ",(0,r.kt)("inlineCode",{parentName:"p"},"midway-core.log.YYYY-MM-DD")," is generated at the end of the day's log."),(0,r.kt)("p",null,"At the same time, when a single log file exceeds 200M, it will be automatically cut to generate a new log file."),(0,r.kt)("p",null,"You can adjust the cutting behavior by configuration."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export default {\n  midwayLogger: {\n    default: {\n      maxSize: '100m',\n    },\n    // ...\n  },\n} as MidwayConfig;\n")),(0,r.kt)("h2",{id:"configure-log-cleanup"},"Configure log cleanup"),(0,r.kt)("p",null,"By default, the log will exist for 31 days."),(0,r.kt)("p",null,"This behavior can be adjusted by configuration, such as saving for 3 days instead."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"} as MidwayConfig;export default {\n  midwayLogger: {\n    default: {\n      maxFiles: '3d',\n    },\n    // ...\n  },\n} as MidwayConfig;\n")),(0,r.kt)("h2",{id:"advanced-configuration"},"Advanced configuration"),(0,r.kt)("p",null,"If you are not satisfied with the default log object, you can create and modify it yourself."),(0,r.kt)("h3",{id:"add-custom-log"},"Add custom log"),(0,r.kt)("p",null,"It can be configured as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export default {\n  midwayLogger: {\n    clients: {\n      abcLogger: {\n        fileLogName: 'abc.log'\n        // ...\n      }\n    }\n    // ...\n  },\n} as MidwayConfig;\n")),(0,r.kt)("p",null,"You can call ",(0,r.kt)("inlineCode",{parentName:"p"},"@Logger('abcLogger')")," to obtain custom logs."),(0,r.kt)("p",null,"For more log options, please refer to the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/midwayjs/logger/blob/main/src/interface.ts"},"LoggerOptions description")," in the interface."),(0,r.kt)("h3",{id:"configure-log-output-format"},"Configure log output format"),(0,r.kt)("p",null,"The display format refers to the string structure of a single line of text when the log is output. Midway has customized Winston logs and provided some default objects."),(0,r.kt)("p",null,"For each logger object, you can configure an output format. The display format is a method that returns a string structure with the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/winstonjs/logform#info-objects"},"info object")," parameter of the Winston."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export default {\n  midwayLogger: {\n    clients: {\n      appLogger: {\n        format: info => {\n          return `${info.timestamp} ${info.LEVEL} ${info.pid} ${info.labelText}${info.message}`;\n        }\n        // ...\n      },\n      customOtherLogger: {\n        format: info => {\n          return 'xxxx';\n        }\n      }\n    }\n    // ...\n  },\n} as MidwayConfig;\n")),(0,r.kt)("p",null,"The default properties of the info object are as follows:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Attribute Name")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Description")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Example")))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"timestamp"),(0,r.kt)("td",{parentName:"tr",align:null},"The timestamp. Default value: ",(0,r.kt)("inlineCode",{parentName:"td"},"'YYYY-MM-DD HH:mm:ss,SSS"),"."),(0,r.kt)("td",{parentName:"tr",align:null},"2020-12-30 07:50:10,453")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"level"),(0,r.kt)("td",{parentName:"tr",align:null},"Lowercase log level"),(0,r.kt)("td",{parentName:"tr",align:null},"info")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"LEVEL"),(0,r.kt)("td",{parentName:"tr",align:null},"Uppercase log level"),(0,r.kt)("td",{parentName:"tr",align:null},"INFO")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"pid"),(0,r.kt)("td",{parentName:"tr",align:null},"current process pid"),(0,r.kt)("td",{parentName:"tr",align:null},"3847")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"labelText"),(0,r.kt)("td",{parentName:"tr",align:null},"Aggregate text for labels"),(0,r.kt)("td",{parentName:"tr",align:null},"[abcde]")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"message"),(0,r.kt)("td",{parentName:"tr",align:null},"Combination of normal messages + error messages + error stacks"),(0,r.kt)("td",{parentName:"tr",align:null},"1. plain text, such as ",(0,r.kt)("inlineCode",{parentName:"td"},"123456"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"hello world")," ",(0,r.kt)("br",null),"2, error text (error name + stack) error: another test error at object. anonymous (/home/runner/work/midway/packages/logger/test/index.test.ts:224:18) ",(0,r.kt)("br",null),"3, plain text + error text hello world error: another test error at object. anonymous (/home/runner/work/midway/midway/packages/logger/test/index.test.ts:224:18)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"stack"),(0,r.kt)("td",{parentName:"tr",align:null},"Error stack"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"originError"),(0,r.kt)("td",{parentName:"tr",align:null},"Original error object"),(0,r.kt)("td",{parentName:"tr",align:null},"The error instance itself")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"originArgs"),(0,r.kt)("td",{parentName:"tr",align:null},"Original user input parameters"),(0,r.kt)("td",{parentName:"tr",align:null},"['a', 'B', 'c']")))),(0,r.kt)("h3",{id:"get-a-custom-context-log"},"Get a custom context log"),(0,r.kt)("p",null,"Context logs are typed based on ",(0,r.kt)("strong",{parentName:"p"},"raw log objects"),". All formats of the original logs are reused. The relationship between them is as follows."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// Pseudocode\nconst contextLogger = customLogger.createContextLogger(ctx);\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"@Inject")," can only inject the default context logs. You can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"ctx.getLogger")," method to obtain the ",(0,r.kt)("strong",{parentName:"p"},"context logs")," corresponding to other ",(0,r.kt)("strong",{parentName:"p"},"custom logs"),". the context log is associated with ctx, and the same key in the same context will obtain the same log object. when ctx is destroyed, the log object will also be recycled."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide } from '@midwayjs/core';\nimport { IMidwayLogger } from '@midwayjs/logger';\nimport { Context } from '@midwayjs/koa';\n\n@Provide()\nexport class UserService {\n\n  @Inject()\n  ctx: Context;\n\n  async getUser() {\n    // The context log object corresponding to the customLogger is obtained here.\n    const customLogger = this.ctx.getLogger('customLogger');\n    customLogger.info('hello world');\n  }\n\n}\n")),(0,r.kt)("h3",{id:"configure-the-context-log-output-format"},"Configure the context log output format"),(0,r.kt)("p",null,"Context logs are typed based on the ",(0,r.kt)("strong",{parentName:"p"},"original log object"),". All formats of the original log are reused. However, you can configure the corresponding context log format of the log object separately."),(0,r.kt)("p",null,"There are more ctx objects in the info object of the context log. Let's take the context log of the ",(0,r.kt)("inlineCode",{parentName:"p"},"customLogger")," as an example."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export default {\n  midwayLogger: {\n    clients: {\n      customLogger: {\n        contextFormat: info => {\n          const ctx = info.ctx;\n          return `${info.timestamp} ${info.LEVEL} ${info.pid} [${Date.now() - ctx.startTime}ms ${ctx.method}] ${info.message}`;\n        }\n        // ...\n      }\n    }\n    // ...\n  },\n} as MidwayConfig;\n")),(0,r.kt)("p",null,"Then when you use the context log output, it will default to your format."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"ctx.getLogger('customLogger').info('hello world');\n// 2021-01-28 11:10:19,334 INFO 9223 [2ms POST] hello world\n")),(0,r.kt)("p",null,"Note that because ",(0,r.kt)("inlineCode",{parentName:"p"},"App Logger")," is the default log object for all frameworks, it is relatively special. Some existing frameworks have their context formats configured by default, resulting in invalid configuration in ",(0,r.kt)("inlineCode",{parentName:"p"},"midwayLogger")," fields."),(0,r.kt)("p",null,"For this, you need to modify the context log format configuration of a framework separately, please jump to a different framework to view."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"[Modify the koa context log format]","(./extensions/koa# Modify Context Log)"),(0,r.kt)("li",{parentName:"ul"},"[Modify the context log format of the egg]","(./extensions/egg# Modify Context Log)"),(0,r.kt)("li",{parentName:"ul"},"[Modify express context log format]","(./extensions/express# Modify Context Log)")),(0,r.kt)("h3",{id:"log-default-transport"},"Log default Transport"),(0,r.kt)("p",null,"Each log contains several default Transport."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Default behavior"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Console Transport"),(0,r.kt)("td",{parentName:"tr",align:null},"Open"),(0,r.kt)("td",{parentName:"tr",align:null},"For output to console")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"File Transport"),(0,r.kt)("td",{parentName:"tr",align:null},"Open"),(0,r.kt)("td",{parentName:"tr",align:null},"For output to a text file")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Error Transport"),(0,r.kt)("td",{parentName:"tr",align:null},"Open"),(0,r.kt)("td",{parentName:"tr",align:null},"Used to output errors to specific error logs")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"JSON Transport"),(0,r.kt)("td",{parentName:"tr",align:null},"Close"),(0,r.kt)("td",{parentName:"tr",align:null},"Text used to output JSON format")))),(0,r.kt)("p",null,"It can be modified through configuration."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Example: Only enable console output")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export default {\n  midwayLogger: {\n    clients: {\n      abcLogger: {\n        enableFile: false\n        enableError: false\n        // ...\n      }\n    }\n    // ...\n  },\n} as MidwayConfig;\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Example: Disable Console Output")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export default {\n  midwayLogger: {\n    clients: {\n      abcLogger: {\n        enableConsole: false\n        // ...\n      }\n    }\n    // ...\n  },\n} as MidwayConfig;\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Example: Enable text and JSON synchronization and disable error output")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export default {\n  midwayLogger: {\n    clients: {\n      abcLogger: {\n        enableConsole: false\n        enableFile: true\n        enableError: false\n        enableJSON: true\n        // ...\n      }\n    }\n    // ...\n  },\n} as MidwayConfig;\n")),(0,r.kt)("h3",{id:"custom-transport"},"Custom Transport"),(0,r.kt)("p",null,"The framework provides extended Transport functions, for example, you can write a Transport to transfer logs and upload them to other log libraries."),(0,r.kt)("p",null,"For example, in the following example, we will transfer the log to another local file."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { EmptyTransport } from '@midwayjs/logger';\n\nclass CustomTransport extends EmptyTransport {\n  log(info, callback) {\n    const levelLowerCase = info.level;\n    if (levelLowerCase === 'error' || levelLowerCase === 'warn') {\n      writeFileSync(join(logsDir, 'test.log'), info.message);\n    }\n    callback();\n  }\n}\n")),(0,r.kt)("p",null,"We can initialize, add it to logger, or set level for Transport separately."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"const customTransport = new CustomTransport({\n  level: 'warn',\n});\n\nlogger.add(customTransport);\n")),(0,r.kt)("p",null,"In this way, the original logger will automatically execute the Transport when printing logs."),(0,r.kt)("p",null,"All Transport are attached to the original logger instance (not context logger). If ctx data is required, it can be obtained from info. Note that it is empty."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"class CustomTransport extends EmptyTransport {\n  log(info, callback) {\n    if (info.ctx) {\n      // ...\n    } else {\n      // ...\n    }\n    callback();\n  }\n}\n")),(0,r.kt)("p",null,"We can also use dependency injection to define Transport."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { EmptyTransport, IMidwayLogger } from '@midwayjs/logger';\nimport { Provide, Scope, ScopeEnum } from '@midwayjs/core';\nimport { MidwayLoggerService } from '@midwayjs/core';\n\n@Provide()\n@Scope(ScopeEnum)\nexport class CustomTransport extends EmptyTransport {\n  log(info, callback) {\n    // ...\n    callback();\n  }\n}\n\n// src/configuration.ts\n@Configuration(/*...*/)\nexport class MainConfiguration {\n\n  @Inject()\n  loggerService: MidwayLoggerService;\n\n  @Inject()\n  customTransport: CustomTransport;\n\n  async onReady() {\n    const appLogger = this.loggerService.getLogger('customLogger') as IMidwayLogger;\n    appLogger.add(this.customTransport);\n  }\n}\n")),(0,r.kt)("h3",{id:"lazy-initialization"},"Lazy initialization"),(0,r.kt)("p",null,"The log can be initialized lazily using the ",(0,r.kt)("inlineCode",{parentName:"p"},"lazyLoad")," configuration."),(0,r.kt)("p",null,"for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export default {\n   midwayLogger: {\n     clients: {\n       customLoggerA: {\n         level: 'DEBUG',\n       },\n       customLoggerB: {\n         lazyLoad: true,\n       },\n     }\n     //...\n   },\n} as MidwayConfig;\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"customLoggerA")," will be initialized immediately when the framework starts, and ",(0,r.kt)("inlineCode",{parentName:"p"},"customLoggerB")," will be initialized when the business actually uses ",(0,r.kt)("inlineCode",{parentName:"p"},"getLogger")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"@Logger")," injection for the first time."),(0,r.kt)("p",null,"This feature is very suitable for dynamically creating logs, but configurations want to be merged together."),(0,r.kt)("h2",{id:"frequently-asked-questions"},"Frequently Asked Questions"),(0,r.kt)("h3",{id:"1-the-server-environment-log-is-not-output"},"1. The server environment log is not output"),(0,r.kt)("p",null,"For the server environment, the default log level is warn, that is, ",(0,r.kt)("inlineCode",{parentName:"p"},"logger.warn"),' will print out. please check the "log level" section.'),(0,r.kt)("p",null,"We do not recommend printing too many logs in the server environment, only printing the necessary content, too much log output affects performance, but also affects the rapid positioning problem."),(0,r.kt)("h3",{id:"2-the-server-does-not-have-a-console-log"},"2. The server does not have a console log"),(0,r.kt)("p",null,"Generally speaking, the server console log (console) is closed and will only be output to the file. If there are special requirements, it can be adjusted separately."))}d.isMDXComponent=!0}}]);