"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[85436],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=p(n),u=a,h=c["".concat(s,".").concat(u)]||c[u]||m[u]||i;return n?r.createElement(h,o(o({ref:t},d),{},{components:n})):r.createElement(h,o({ref:t},d))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:a,o[1]=l;for(var p=2;p<i;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},97503:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var r=n(87462),a=(n(67294),n(3905));const i={},o="gRPC",l={unversionedId:"extensions/grpc",id:"extensions/grpc",title:"gRPC",description:"GRPC is a high-performance, universal open source RPC framework, which is mainly developed by Google for mobile applications and designed based on HTTP/2 protocol standards. It is developed based on ProtoBuf(Protocol Buffers) serialization protocol and supports many development languages.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/extensions/grpc.md",sourceDirName:"extensions",slug:"/extensions/grpc",permalink:"/en/docs/extensions/grpc",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/extensions/grpc.md",tags:[],version:"current",frontMatter:{},sidebar:"component",previous:{title:"label components",permalink:"/en/docs/extensions/tags"},next:{title:"Consul",permalink:"/en/docs/extensions/consul"}},s={},p=[{value:"Installation dependency",id:"installation-dependency",level:2},{value:"Open the component",id:"open-the-component",level:2},{value:"Directory structure",id:"directory-structure",level:2},{value:"Define service interface",id:"define-service-interface",level:2},{value:"Write proto file",id:"write-proto-file",level:3},{value:"Generate code definitions",id:"generate-code-definitions",level:3},{value:"Provide gRPC service (Provider)",id:"provide-grpc-service-provider",level:2},{value:"Writing Service Provider (Provider)",id:"writing-service-provider-provider",level:3},{value:"Configuration service",id:"configuration-service",level:3},{value:"Provide security certificate",id:"provide-security-certificate",level:3},{value:"Write unit tests",id:"write-unit-tests",level:3},{value:"Call gRPC service (Consumer)",id:"call-grpc-service-consumer",level:2},{value:"Call configuration",id:"call-configuration",level:3},{value:"Code call",id:"code-call",level:3},{value:"Streaming service",id:"streaming-service",level:2},{value:"Streaming proto file",id:"streaming-proto-file",level:3},{value:"Server push",id:"server-push",level:3},{value:"Client push",id:"client-push",level:3},{value:"Bidirectional flow",id:"bidirectional-flow",level:3},{value:"Metadata (Metadata)",id:"metadata-metadata",level:2},{value:"Timeout processing",id:"timeout-processing",level:2}],d={toc:p},c="wrapper";function m(e){let{components:t,...n}=e;return(0,a.kt)(c,(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"grpc"},"gRPC"),(0,a.kt)("p",null,"GRPC is a high-performance, universal open source RPC framework, which is mainly developed by Google for mobile applications and designed based on HTTP/2 protocol standards. It is developed based on ProtoBuf(Protocol Buffers) serialization protocol and supports many development languages."),(0,a.kt)("p",null,"This article demonstrates how to provide gRPC services under Midway system and how to call gRPC services."),(0,a.kt)("p",null,"Midway uses the latest gRPC-recommended ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/grpc/grpc-node/tree/master/packages/grpc-js"},"@grpc/grpc-js")," for development, and provides toolkits for quick service release and service call."),(0,a.kt)("p",null,"The module we use is ",(0,a.kt)("inlineCode",{parentName:"p"},"@midwayjs/grpc"),", which can publish services independently and call gRPC services through other frameworks."),(0,a.kt)("p",null,"Related information:"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Provide services")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Description"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Can be used for standard projects"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Can be used for Serverless"),(0,a.kt)("td",{parentName:"tr",align:null},"\u274c")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Can be used for integration"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Call Service")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Description"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Can be used for standard projects"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Can be used for Serverless"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Can be used for integration"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Other")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Description"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Can be used independently as the main framework"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Middleware can be added independently"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")))),(0,a.kt)("h2",{id:"installation-dependency"},"Installation dependency"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i @midwayjs/grpc@3 --save\n$ npm i @midwayjs/grpc-helper --save-dev\n")),(0,a.kt)("p",null,"Or reinstall the following dependencies in ",(0,a.kt)("inlineCode",{parentName:"p"},"package.json"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "dependencies": {\n    "@midwayjs/grpc": "^3.0.0",\n    // ...\n  },\n  "devDependencies": {\n    "@midwayjs/grpc-helper": "^1.0.0 ",\n    // ...\n  }\n}\n')),(0,a.kt)("h2",{id:"open-the-component"},"Open the component"),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Whether it is providing a service or invoking a service, you need to open the component.")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"@midwayjs/grpc")," can be used as an independent main framework."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/core';\nimport * as grpc from '@midwayjs/grpc';\n\n@Configuration({\n  imports: [grpc]\n  // ...\n})\nexport class MainConfiguration {\n  async onReady() {\n        // ...\n  }\n}\n\n")),(0,a.kt)("p",null,"It can also be attached to other main frameworks, such as ",(0,a.kt)("inlineCode",{parentName:"p"},"@midwayjs/Koa"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/core';\nimport * as koa from '@midwayjs/koa';\nimport * as grpc from '@midwayjs/grpc';\n\n@Configuration({\n  imports: [koa, grpc]\n  // ...\n})\nexport class MainConfiguration {\n  async onReady() {\n        // ...\n  }\n}\n\n")),(0,a.kt)("h2",{id:"directory-structure"},"Directory structure"),(0,a.kt)("p",null,"The general directory structure is as follows. ",(0,a.kt)("inlineCode",{parentName:"p"},"src/provider")," is the directory that provides gRPC services."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},".\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 proto                         ## proto definition file\n\u2502   \u2514\u2500\u2500 helloworld.proto\n\u251c\u2500\u2500 src\n\u2502   \u251c\u2500\u2500 configuration.ts          ## entry configuration file\n\u2502   \u251c\u2500\u2500 interface.ts\n\u2502   \u2514\u2500\u2500 provider                  ## files provider services provided by gRPC\n\u2502       \u2514\u2500\u2500 greeter.ts\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 bootstrap.js                  ## service startup portal\n\u2514\u2500\u2500 tsconfig.json\n")),(0,a.kt)("h2",{id:"define-service-interface"},"Define service interface"),(0,a.kt)("p",null,"In microservices, defining a service requires a specific interface definition language (IDL) to complete, and Protocol Buffers is used as serialization protocol by default in gRPC."),(0,a.kt)("p",null,"The serialization protocol is independent of the language and platform, and provides implementations in multiple languages, such as Java,C ++,Go, etc. Each implementation contains compilers and library files in the corresponding language. Therefore, gRPC is a service framework that provides and calls across languages."),(0,a.kt)("p",null,"The general architecture of a gRPC service can be represented by a diagram on the official website."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://img.alicdn.com/imgextra/i3/O1CN01kpIyg51k8i5DtcGpZ_!!6000000004639-2-tps-621-445.png",alt:null})),(0,a.kt)("p",null,"The default suffix is ",(0,a.kt)("inlineCode",{parentName:"p"},".proto")," for files that Protocol the Buffers protocol. IDL file with the. proto suffix, and generates language-specific data structures, server-side interfaces, and client-side Stub code through its compiler."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"Because proto files can be used across languages, in order to facilitate sharing, we usually place proto files outside the src directory to facilitate other tools to copy and distribute.")),(0,a.kt)("p",null,"The following is a basic ",(0,a.kt)("inlineCode",{parentName:"p"},"proto/helloworld.proto")," file."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},'syntax = "proto3";\n\npackage helloworld;\n\nservice Greeter {\n  // Sends a greeting\n  rpc SayHello (HelloRequest) returns (HelloReply) {}\n}\n\nmessage HelloRequest {\n  string name = 1;\n}\n\nmessage HelloReply {\n  string message = 1;\n}\n\n')),(0,a.kt)("p",null,'Proto3 represents the third version of the protobuf protocol, which is currently recommended by gRPC, "simple syntax and more complete functions".'),(0,a.kt)("p",null,"We can define the service body in ",(0,a.kt)("inlineCode",{parentName:"p"},"service")," format, which can include methods. At the same time, we can describe the specific request parameters and response parameters of the service in more detail through ",(0,a.kt)("inlineCode",{parentName:"p"},"message"),"."),(0,a.kt)("p",null,"For more information, see ",(0,a.kt)("a",{parentName:"p",href:"https://developers.google.com/protocol-buffers/docs/overview#simple"},"Google's official website documentation"),"."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"As you will see, this is very similar to Class in Java, and each structure is equivalent to a class in Java.")),(0,a.kt)("h3",{id:"write-proto-file"},"Write proto file"),(0,a.kt)("p",null,"Now let's look at the previous service again, is it easy to understand."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},'syntax = "proto3";\n\npackage helloworld;\n\n// Definition of service\nservice Greeter {\n  // Sends a greeting\n  rpc SayHello (HelloRequest) returns (HelloReply) {}\n}\n\n// Service request parameters\nmessage HelloRequest {\n  string name = 1;\n}\n\n// Response parameters of the service\nmessage HelloReply {\n  string message = 1;\n}\n\n')),(0,a.kt)("p",null,"We define a service called ",(0,a.kt)("inlineCode",{parentName:"p"},"Greeter"),", which contains a requestor of a ",(0,a.kt)("inlineCode",{parentName:"p"},"HelloRequest")," structure and a respondent of a ",(0,a.kt)("inlineCode",{parentName:"p"},"HelloReply")," structure."),(0,a.kt)("p",null,"Next, we will demonstrate this service to you."),(0,a.kt)("h3",{id:"generate-code-definitions"},"Generate code definitions"),(0,a.kt)("p",null,"The traditional gRPC framework requires users to manually write proto files, generate js services, and finally rewrite and implement them according to the services generated by js. Under Midway system, we provide a grpc-helper toolkit to speed up this process."),(0,a.kt)("p",null,"If there is no installation, you can install it first."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i @midwayjs/grpc-helper --save-dev\n")),(0,a.kt)("p",null,"The function of the grpc-helper tool is to generate the corresponding readable ts interface file from the proto file provided by the user."),(0,a.kt)("p",null,"We can add a script to facilitate this process."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "scripts": {\n     "generate": "tsproto --path proto --output src/domain"\n  }\n}\n')),(0,a.kt)("p",null,"Then ",(0,a.kt)("inlineCode",{parentName:"p"},"npm run generate")," is executed."),(0,a.kt)("p",null,"After the preceding command is executed, the service interface definition corresponding to the Proto file is generated in the ",(0,a.kt)("inlineCode",{parentName:"p"},"src/domain")," Directory of the code."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"Whether it is providing gRPC service or calling gRPC service, it must be defined.")),(0,a.kt)("p",null,"The generated code is as follows, including a namespace (namespace) and two TypeScript Interface under the namespace, ",(0,a.kt)("inlineCode",{parentName:"p"},"Greeter")," for writing server-side implementations and ",(0,a.kt)("inlineCode",{parentName:"p"},"GreeterClient")," for writing client-side implementations."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"/**\n* This file is auto-generated by grpc-helper\n*/\n\nimport * as grpc from '@midwayjs/grpc';\n\n// Generated namespace\nexport namespace helloworld {\n\n  // Definition used by the server\n  export interface Greeter {\n    // Sends a greeting\n    sayHello(data: HelloRequest): Promise<HelloReply>;\n  }\n\n  // Definition used by the client\n  export interface GreeterClient {\n    // Sends a greeting\n    sayHello(options?: grpc.IClientOptions): grpc.IClientUnaryService<HelloRequest, HelloReply>;\n  }\n\n  // Request body structure\n  export interface HelloRequest {\n    name?: string;\n  }\n\n  // Response body structure\n  export interface HelloReply {\n    message?: string;\n  }\n}\n\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"Whenever The proto file is modified, the corresponding service definition needs to be regenerated, and then the corresponding method is implemented.")),(0,a.kt)("h2",{id:"provide-grpc-service-provider"},"Provide gRPC service (Provider)"),(0,a.kt)("h3",{id:"writing-service-provider-provider"},"Writing Service Provider (Provider)"),(0,a.kt)("p",null,"In the ",(0,a.kt)("inlineCode",{parentName:"p"},"src/provider")," directory, we create ",(0,a.kt)("inlineCode",{parentName:"p"},"greeter.ts")," as follows"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {\n  MSProviderType,\n  Provider,\n  GrpcMethod\n} from '@midwayjs/core';\nimport { helloworld } from '../domain/helloworld';\n\n/**\n * Implementation of helloworld.Greeter Interface Services\n */\n@Provider(MSProviderType.GRPC, { package: 'helloworld' })\nexport class Greeter implements helloworld.Greeter {\n\n  @GrpcMethod()\n  async sayHello(request: helloworld.HelloRequest) {\n    return { message: 'Hello '+ request.name };\n  }\n}\n\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"Note that the @Provider decorator is different from the @Provide decorator, the former is used to provide services, and the latter is used to rely on the class identified by the injection container scan.")),(0,a.kt)("p",null,"We use the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Provider")," to expose an RPC service. The first parameter of the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Provider")," is the RPC service type. This parameter is an enumeration. Here, select the GRPC type."),(0,a.kt)("p",null,"The second parameter of the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Provider")," is the metadata of the RPC service, which refers to the metadata of the gRPC service. Here, you need to write the package field of the gRPC, that is, the package field in the proto file (the field here is used to correspond to the field after the proto file is loaded)."),(0,a.kt)("p",null,"For ordinary gRPC service interfaces (UnaryCall), we only need to use the ",(0,a.kt)("inlineCode",{parentName:"p"},"@GrpcMethod()")," decorator. The modification method is the service definition itself, the input parameter is the input parameter defined in proto, and the return value is the defined response body."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"Note that the generated Interface is to better write service code and standardize the structure. Please be sure to write according to the definition.")),(0,a.kt)("h3",{id:"configuration-service"},"Configuration service"),(0,a.kt)("p",null,"The content is as follows."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nimport { MidwayAppInfo, MidwayConfig } from '@midwayjs/core';\n\nexport default (appInfo: MidwayAppInfo): MidwayConfig => {\n  return {\n    // ...\n    grpcServer: {\n      services: [\n        {\n          protoPath: join(appInfo.appDir, 'proto/hero.proto')\n          package: 'hero',\n        },\n        {\n          protoPath: join(appInfo.appDir, 'proto/helloworld.proto')\n          package: 'helloworld',\n        }\n      ],\n    }\n  };\n}\n")),(0,a.kt)("p",null,"services fields are arrays, which means that Midway projects can publish multiple gRPC services at the same time. The structure of each service is:"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Property"),(0,a.kt)("th",{parentName:"tr",align:null},"Type"),(0,a.kt)("th",{parentName:"tr",align:null},"Description"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"protoPath"),(0,a.kt)("td",{parentName:"tr",align:null},"String"),(0,a.kt)("td",{parentName:"tr",align:null},"Required, absolute path of proto file")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"package"),(0,a.kt)("td",{parentName:"tr",align:null},"String"),(0,a.kt)("td",{parentName:"tr",align:null},"Required, the package corresponding to the service")))),(0,a.kt)("p",null,"In addition to the Service configuration, there are some other configurations."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Property"),(0,a.kt)("th",{parentName:"tr",align:null},"Type"),(0,a.kt)("th",{parentName:"tr",align:null},"Description"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"url"),(0,a.kt)("td",{parentName:"tr",align:null},"String"),(0,a.kt)("td",{parentName:"tr",align:null},"Optional, gRPC service address, default 6565 port\uff0clike 'localhost:6565'")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"loaderOptions"),(0,a.kt)("td",{parentName:"tr",align:null},"Object"),(0,a.kt)("td",{parentName:"tr",align:null},"Optional, the options of the proto file loader")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"credentials"),(0,a.kt)("td",{parentName:"tr",align:null},"ServerCredentials"),(0,a.kt)("td",{parentName:"tr",align:null},"Optional. credentials parameter options when grpc Server binding")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"serverOptions"),(0,a.kt)("td",{parentName:"tr",align:null},"ChannelOptions"),(0,a.kt)("td",{parentName:"tr",align:null},"Optional. ",(0,a.kt)("a",{parentName:"td",href:"https://github.com/grpc/grpc-node/tree/master/packages/grpc-js#supported-channel-options"},"Custom options")," for grpc Server")))),(0,a.kt)("h3",{id:"provide-security-certificate"},"Provide security certificate"),(0,a.kt)("p",null,"Security certificates can be passed through ",(0,a.kt)("inlineCode",{parentName:"p"},"credentials")," parameters."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nimport { MidwayAppInfo, MidwayConfig } from '@midwayjs/core';\nimport { ServerCredentials } from '@midwayjs/grpc';\nimport { readFileSync } from 'fs';\nimport { join } from 'path';\n\nconst cert = readFileSync(join(__dirname, './cert/server.crt'));\nconst pem = readFileSync(join(__dirname, './cert/server.pem'));\nconst key = readFileSync(join(__dirname, './cert/server.key'));\n\nexport default (appInfo: MidwayAppInfo): MidwayConfig => {\n  return {\n    // ...\n    grpcServer: {\n      // ...\n      credentials: ServerCredentials.createSsl(cert, [{ private_key: key, cert_chain: pem }]);\n    }\n  };\n}\n")),(0,a.kt)("h3",{id:"write-unit-tests"},"Write unit tests"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"@midwayjs/grpc")," library provides a ",(0,a.kt)("inlineCode",{parentName:"p"},"createGRPCConsumer")," method for calling clients in real time. Generally, we use this method for testing."),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},"This method will be connected in real time every time it is called. It is not recommended to use this method in a production environment.")),(0,a.kt)("p",null,"Written in the test as follows."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { createApp, close } from '@midwayjs/mock';\nimport { Framework, createGRPCConsumer } from '@midwayjs/grpc';\nimport { join } from 'path';\nimport { helloworld } from '../src/domain/helloworld';\n\ndescribe('test/index.test.ts', () => {\n\n  it('should create multiple grpc service in one server', async () => {\n    const baseDir = join(__dirname, '../');\n\n    // Create Service\n    const app = await createApp<Framework>();\n\n    // Call service\n    const service = await createGRPCConsumer<helloworld. GreeterClient>({\n      package: 'helloworld',\n      protoPath: join(baseDir, 'proto', 'helloworld.proto'),\n      url: 'localhost:6565'\n    });\n\n    const result = await service.sayHello().sendMessage({\n      name: 'harry'\n    });\n\n    expect(result.message).toEqual('Hello harry');\n    await close(app);\n  });\n\n});\n\n")),(0,a.kt)("h2",{id:"call-grpc-service-consumer"},"Call gRPC service (Consumer)"),(0,a.kt)("p",null,"We write a gRPC service to invoke the exposed service above."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"In fact, you can call it in the Controller of the Web, or Service and other places, here is just an example.")),(0,a.kt)("h3",{id:"call-configuration"},"Call configuration"),(0,a.kt)("p",null,"You need to add the target service you need to call and its proto file information to ",(0,a.kt)("inlineCode",{parentName:"p"},"src/config/config.default.ts"),"."),(0,a.kt)("p",null,"For example, here we fill in the service itself exposed above, as well as the service's Proto, package name and other information (function form)."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nimport { MidwayAppInfo, MidwayConfig } from '@midwayjs/core';\n\nexport default (appInfo: MidwayAppInfo): MidwayConfig => {\n  return {\n    // ...\n    grpc: {\n      services: [\n        {\n          url: 'localhost:6565',\n          protoPath: join(appInfo.appDir, 'proto/helloworld.proto'),\n          package: 'helloworld',\n        },\n      ],\n    },\n  };\n}\n")),(0,a.kt)("h3",{id:"code-call"},"Code call"),(0,a.kt)("p",null,"After configuration, we can call it in the code."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"@midwayjs/grpc")," provides ",(0,a.kt)("inlineCode",{parentName:"p"},"clients")," to easily obtain configured services. We just need to inject this object where it needs to be injected."),(0,a.kt)("p",null,"For example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {\n  Provide,\n  Inject,\n} from '@midwayjs/core';\nimport { helloworld, hero } from '../interface';\nimport { Clients } from '@midwayjs/grpc';\n\n@Provide()\nexport class UserService {\n  @Inject()\n  grpcClients: Clients;\n\n}\n")),(0,a.kt)("p",null,"We get the client instance of the other service through the ",(0,a.kt)("inlineCode",{parentName:"p"},"clients")," and call it."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {\n  Provide,\n  Inject,\n} from '@midwayjs/core';\nimport { helloworld, hero } from '../interface';\nimport { Clients } from '@midwayjs/grpc';\n\n@Provide()\nexport class UserService {\n  @Inject()\n  grpcClients: Clients;\n\n  async invoke() {\n    // Get Services\n    const greeterService = this.grpcClients.getService<helloworld. GreeterClient> (\n      'helloworld. Greeter'\n    );\n\n    // Call service\n    const result = await greeterService.sayHello()\n        .sendMessage({\n        name: 'harry'\n      });\n\n    // Return result\n    return result;\n  }\n\n}\n")),(0,a.kt)("p",null,"You can also use the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Init")," decorator to cache the services to be called to properties. This can be reused when other methods are called."),(0,a.kt)("p",null,"An example is as follows."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {\n  GrpcMethod,\n  MSProviderType,\n  Provider,\n  Inject,\n  Init,\n} from '@midwayjs/core';\nimport { helloworld, hero } from '../interface';\nimport { Clients } from '@midwayjs/grpc';\n\n@Provider(MSProviderType.GRPC, { package: 'hero' })\nexport class HeroService implements hero.HeroService {\n  // Injection client\n  @Inject()\n  grpcClients: Clients;\n\n  greeterService: helloworld.GreeterClient;\n\n  @Init()\n  async init() {\n    // Assign a service instance\n    this.greeterService = this.grpcClients.getService<helloworld. GreeterClient> (\n      'helloworld. Greeter'\n    );\n  }\n\n  @GrpcMethod()\n  async findOne(data) {\n    // Call service\n    const result = await greeterService.sayHello()\n        .sendMessage({\n        name: 'harry'\n      });\n\n    // Return result\n    return result;\n  }\n}\n\n")),(0,a.kt)("h2",{id:"streaming-service"},"Streaming service"),(0,a.kt)("p",null,"The streaming service of gRPC is used to reduce connections so that servers or clients can execute tasks without waiting, thus improving execution efficiency."),(0,a.kt)("p",null,"There are three types of gRPC streaming services. From the perspective of the server,"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Server receives flow (client push)"),(0,a.kt)("li",{parentName:"ul"},"Server response flow (server push)"),(0,a.kt)("li",{parentName:"ul"},"Bidirectional flow")),(0,a.kt)("p",null,"We will introduce them one by one."),(0,a.kt)("h3",{id:"streaming-proto-file"},"Streaming proto file"),(0,a.kt)("p",null,"The proto file for streaming is written differently. You must mark the ",(0,a.kt)("inlineCode",{parentName:"p"},"stream")," parameter where you want to use the stream."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},'\nsyntax = "proto3";\n\npackage math;\n\nmessage AddArgs {\n  int32 id = 1;\n  int32 num = 2;\n}\n\nmessage Num {\n  int32 id = 1;\n  int32 num = 2;\n}\n\nservice Math {\n  rpc Add (AddArgs) returns (Num) {\n  }\n\n    // Bidirectional flow\n  rpc AddMore (stream AddArgs) returns (stream Num) {\n  }\n\n  // The server pushes to the client.\n  rpc SumMany (AddArgs) returns (stream Num) {\n  }\n\n  // The client pushes to the server.\n  rpc AddMany (stream AddArgs) returns (Num) {\n  }\n}\n\n')),(0,a.kt)("p",null,"The interface generated by this service is defined:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {\n  IClientDuplexStreamService,\n  IClientReadableStreamService,\n  IClientUnaryService,\n  IClientWritableStreamService,\n  IClientOptions,\n} from '@midwayjs/grpc';\n\nexport namespace math {\n  export interface AddArgs {\n    id?: number;\n    num?: number;\n  }\n  export interface Num {\n    id?: number;\n    num?: number;\n  }\n\n  /**\n   * server interface\n   */\n  export interface Math {\n    add(data: AddArgs): Promise<Num>;\n    addMore(data: AddArgs): Promise<void>;\n    // server push, client read\n    sumMany(data: AddArgs): Promise<void>\n    // client push\uff0cserver read\n    addMany(num: AddArgs): Promise<void>;\n  }\n\n  /**\n   * client interface\n   */\n  export interface MathClient {\n    add(options?: IClientOptions): IClientUnaryService<AddArgs, Num>;\n    addMore(options?: IClientOptions): IClientDuplexStreamService<AddArgs, Num>;\n    // server push, client read\n    sumMany(options?: IClientOptions): IClientReadableStreamService<AddArgs, Num>;\n    // Push on the client side and read on the server side\n    addMany(options?: IClientOptions): IClientWritableStreamService<AddArgs, Num>;\n  }\n}\n\n")),(0,a.kt)("h3",{id:"server-push"},"Server push"),(0,a.kt)("p",null,"The client calls once and the server can return multiple times. The streaming type is identified by the parameter of ",(0,a.kt)("inlineCode",{parentName:"p"},"@GrpcMethod()"),"."),(0,a.kt)("p",null,"The available types are:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"GrpcStreamTypeEnum.WRITEABLE")," the server output stream (single work)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"GrpcStreamTypeEnum.READABLE")," the client output stream (single work), the server accepts multiple times"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"GrpcStreamTypeEnum.DUPLEX")," duplex flow")),(0,a.kt)("p",null,"The server example is as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { GrpcMethod, GrpcStreamTypeEnum, Inject, MSProviderType, Provider } from '@midwayjs/core';\nimport { Context, Metadata } from '@midwayjs/grpc';\nimport { math } from '../interface';\n\n/**\n */\n@Provider(MSProviderType.GRPC, { package: 'math' })\nexport class Math implements math.Math {\n\n  @Inject()\n  ctx: Context;\n\n  @GrpcMethod({type: GrpcStreamTypeEnum.WRITEABLE })\n  async sumMany(args: math.AddArgs) {\n    this.ctx.write({\n      num: 1 + args.num\n    });\n    this.ctx.write({\n      num: 2 + args.num\n    });\n    this.ctx.write({\n      num: 3 + args.num\n    });\n\n    this.ctx.end();\n  }\n\n  // ...\n}\n\n")),(0,a.kt)("p",null,"The server uses the ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.write")," method to return data. You can return data multiple times because it is a server stream."),(0,a.kt)("p",null,"After the response is completed, use the ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.end()")," method to disable the flow."),(0,a.kt)("p",null,"The client, called once, accepts multiple data."),(0,a.kt)("p",null,"For example, the accumulation logic below."),(0,a.kt)("p",null,"Promise writing method, it will wait for the server data to return before processing."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// Server push\nlet total = 0;\nlet result = await service.sumMany().sendMessage({\n  num: 1\n});\n\nresult.forEach(data => {\n  total += data.num;\n});\n\n// total = 9;\n")),(0,a.kt)("p",null,"Event writing, real-time processing."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// Server push\nlet call = service.sumMany().getCall();\n\ncall.on('data', data => {\n    // do something\n});\n\ncall.sendMessage({\n  num: 1\n});\n\n")),(0,a.kt)("h3",{id:"client-push"},"Client push"),(0,a.kt)("p",null,"The client calls multiple times, the server receives data multiple times, and returns a result. The streaming type is identified by the parameter of ",(0,a.kt)("inlineCode",{parentName:"p"},"@GrpcMethod({type: GrpcStreamTypeEnum.READABLE})"),"."),(0,a.kt)("p",null,"The server example is as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { GrpcMethod, GrpcStreamTypeEnum, Inject, MSProviderType, Provider } from '@midwayjs/core';\nimport { Context, Metadata } from '@midwayjs/grpc';\nimport { math } from '../interface';\n\n/**\n */\n@Provider(MSProviderType.GRPC, { package: 'math' })\nexport class Math implements math.Math {\n\n  sumDataList: number[] = [];\n\n  @Inject()\n  ctx: Context;\n\n  @GrpcMethod({type: GrpcStreamTypeEnum.READABLE, onEnd: 'sumEnd' })\n  async addMany(data: math.Num) {\n    this.sumDataList.push(data);\n  }\n\n  async sumEnd(): Promise<math.Num> {\n    const total = this.sumDataList.reduce((pre, cur) => {\n      return {\n        num: pre.num + cur.num\n      }\n    });\n    return total;\n  }\n\n  // ...\n}\n\n")),(0,a.kt)("p",null,"Each time the client calls, the ",(0,a.kt)("inlineCode",{parentName:"p"},"addMany")," method is triggered."),(0,a.kt)("p",null,"After the client sends the ",(0,a.kt)("inlineCode",{parentName:"p"},"end")," event, the method specified by the ",(0,a.kt)("inlineCode",{parentName:"p"},"onEnd")," parameter on the ",(0,a.kt)("inlineCode",{parentName:"p"},"@GrpcMethod")," decorator is called, and the return value of this method is the value obtained by the last client."),(0,a.kt)("p",null,"The client example is as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// Client push\nconst data = await service.addMany()\n.sendMessage({num: 1})\n.sendMessage({num: 2})\n.sendMessage({num: 3})\n.end();\n\n// data.num = 6\n")),(0,a.kt)("h3",{id:"bidirectional-flow"},"Bidirectional flow"),(0,a.kt)("p",null,"The client can call multiple times, and the server can also receive multiple data and return multiple results, similar to traditional TCP communication. The duplex streaming type is identified by the parameter of ",(0,a.kt)("inlineCode",{parentName:"p"},"@GrpcMethod({type: GrpcStreamTypeEnum.DUPLEX})"),"."),(0,a.kt)("p",null,"The server example is as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { GrpcMethod, GrpcStreamTypeEnum, Inject, MSProviderType, Provider } from '@midwayjs/core';\nimport { Context, Metadata } from '@midwayjs/grpc';\nimport { math } from '../interface';\n\n/**\n */\n@Provider(MSProviderType.GRPC, { package: 'math' })\nexport class Math implements math.Math {\n\n  @Inject()\n  ctx: Context;\n\n  @GrpcMethod({type: GrpcStreamTypeEnum.DUPLEX, onEnd: 'duplexEnd' })\n  async addMore(message: math.AddArgs) {\n    this.ctx.write({\n      id: message.id\n      num: message.num +10\n    });\n  }\n\n  async duplexEnd() {\n    console.log('got client end message');\n  }\n  // ...\n}\n\n")),(0,a.kt)("p",null,"The server can use ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.write")," to return data at any time, or use ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.end")," to disable the flow."),(0,a.kt)("p",null,"Client example:"),(0,a.kt)("p",null,"For clients of duplex communication, because the order of calling and returning cannot be guaranteed, we need to use the listening mode to consume the results."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"const clientStream = service.addMore().getCall();\n\nlet total = 0;\nlet idx = 0;\n\nduplexCall.on('data', (data: math.Num) => {\n  total += data.num;\n  idx++;\n  if (idx === 2) {\n    duplexCall.end();\n    // total => 29\n  }\n});\n\nduplexCall.write({\n  num: 3,\n});\n\nduplexCall.write({\n  num: 6\n});\n")),(0,a.kt)("p",null,"If you want to ensure the order of calls, we also provide a two-way flow call method that guarantees the order, but you need to define a fixed ID in the Proto to to ensure the order."),(0,a.kt)("p",null,"For example, our Math.proto adds a fixed id to each entry and exit parameter, so the order can be fixed."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'\nsyntax = "proto3";\n\npackage math;\n\nmessage AddArgs {\n  int32 id = 1; // The id name here is fixed\n  int32 num = 2;\n}\n\nmessage Num {\n  int32 id = 1; // The id name here is fixed\n  int32 num = 2;\n}\n\nservice Math {\n  rpc Add (AddArgs) returns (Num) {\n  }\n\n  rpc AddMore (stream AddArgs) returns (stream Num) {\n  }\n\n  // The server pushes to the client.\n  rpc SumMany (AddArgs) returns (stream Num) {\n  }\n\n  // The client pushes to the server.\n  rpc AddMany (stream AddArgs) returns (Num) {\n  }\n}\n\n')),(0,a.kt)("p",null,"The fixed-order client calls are as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// Ensure sequential bidirectional flow\nconst t = service.addMore();\n\nconst result4 = await new Promise<number>((resolve, reject) => {\n\n  let total = 0;\n\n  // First call and return\n  t.sendMessage({\n    num: 2\n  })\n    .then(res => {\n      expect(res.num).toEqual(12);\n      total += res.num;\n    })\n    .catch(err => console.error(err));\n\n  // Second call and return\n  t.sendMessage({\n    num: 5\n  }).then(res => {\n      expect(res.num).toEqual(15);\n      total += res.num;\n      resolve(total);\n    })\n    .catch(err => console.error(err));\n\n  t.end();\n});\n\n// result4 => 27\n")),(0,a.kt)("p",null,"The default ID is ",(0,a.kt)("inlineCode",{parentName:"p"},"id"),". If the server definition is different, you can change it."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// Ensure sequential bidirectional flow\nconst t = service.addMore({\n  messageKey: 'uid'\n});\n")),(0,a.kt)("h2",{id:"metadata-metadata"},"Metadata (Metadata)"),(0,a.kt)("p",null,"The metadata of gRPC is equivalent to the HTTP context."),(0,a.kt)("p",null,"The server returns metadata through the ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.sendMetadata")," method, and can also obtain the metadata passed by the client through ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.metadata"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {\n  MSProviderType,\n  Provider,\n  GrpcMethod\n} from '@midwayjs/core';\nimport { helloworld } from '../domain/helloworld';\nimport { Context, Metadata } from '@midwayjs/grpc';\n\n/**\n * Implementation of helloworld.Greeter Interface Services\n */\n@Provider(MSProviderType.GRPC, { package: 'helloworld' })\nexport class Greeter implements helloworld.Greeter {\n\n  @Inject()\n  ctx: Context;\n\n  @GrpcMethod()\n  async sayHello(request: helloworld.HelloRequest) {\n\n    // Metadata passed by the client\n    console.log(this.ctx.metadata);\n\n    // Create metadata\n    const meta = new Metadata();\n    this.ctx.metadata.add('xxx', 'bbb');\n    this.ctx.sendMetadata(meta);\n\n    return { message: 'Hello '+ request.name };\n  }\n}\n")),(0,a.kt)("p",null,"The client passes metadata through the options parameters of the method."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Metadata } from '@midwayjs/grpc';\n\nconst meta = new Metadata();\nmeta.add('key', 'value');\n\nconst result = await service.sayHello({\n  metadata: meta\n}).sendMessage({\n  name: 'harry'\n});\n")),(0,a.kt)("p",null,"Getting metadata is relatively cumbersome."),(0,a.kt)("p",null,"Ordinary unary calls (UnaryCall) require ",(0,a.kt)("inlineCode",{parentName:"p"},"sendMessageWithCallback")," methods to obtain metadata."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"const call = service.sayHello().sendMessageWithCallback({\n  name: 'zhangting'\n}, (err) => {\n  if (err) {\n    reject(err);\n  }\n});\ncall.on('metadata', (meta) => {\n  // output meta\n});\n")),(0,a.kt)("p",null,"For other streaming services, you can directly subscribe to the original client stream object by ",(0,a.kt)("inlineCode",{parentName:"p"},"getCall()")," method."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// Get the service. Note that there is no await here.\nconst call = service.addMany().getCall();\ncall.on('metadata', (meta) => {\n  // output meta\n});\n")),(0,a.kt)("h2",{id:"timeout-processing"},"Timeout processing"),(0,a.kt)("p",null,"We can pass parameters in milliseconds when calling the service."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"const result = await service.sayHello({\n  timeout: 5000\n}).sendMessage({\n  name: 'harry'\n});\n")))}m.isMDXComponent=!0}}]);