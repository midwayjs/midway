"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[99136],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>y});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),l=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,c=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=l(n),m=r,y=d["".concat(c,".").concat(m)]||d[m]||p[m]||o;return n?a.createElement(y,i(i({ref:t},u),{},{components:n})):a.createElement(y,i({ref:t},u))}));function y(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s[d]="string"==typeof e?e:r,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},72442:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var a=n(87462),r=(n(67294),n(3905));const o={},i="Data source management",s={unversionedId:"data_source",id:"data_source",title:"Data source management",description:"In the process of using database packages, we often have multi-database connection and management requirements. Different databases have certain differences in connection pool management, connection status, and usage methods.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/data_source.md",sourceDirName:".",slug:"/data_source",permalink:"/en/docs/data_source",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/data_source.md",tags:[],version:"current",frontMatter:{},sidebar:"common",previous:{title:"Data subscription",permalink:"/en/docs/data_listener"},next:{title:"\u6570\u636e\u54cd\u5e94",permalink:"/en/docs/data_response"}},c={},l=[{value:"Implement data source manager",id:"implement-data-source-manager",level:2},{value:"1. Create a data source interface",id:"1-create-a-data-source-interface",level:3},{value:"2. Provide initialization configuration",id:"2-provide-initialization-configuration",level:3},{value:"Entity binding",id:"entity-binding",level:2},{value:"1. Explicitly associate entity classes",id:"1-explicitly-associate-entity-classes",level:3},{value:"2. Directory Scan Associated Entities",id:"2-directory-scan-associated-entities",level:3},{value:"2. Obtain the data source according to the entity",id:"2-obtain-the-data-source-according-to-the-entity",level:3},{value:"Get data source",id:"get-data-source",level:2}],u={toc:l},d="wrapper";function p(e){let{components:t,...n}=e;return(0,r.kt)(d,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"data-source-management"},"Data source management"),(0,r.kt)("p",null,"In the process of using database packages, we often have multi-database connection and management requirements. Different databases have certain differences in connection pool management, connection status, and usage methods."),(0,r.kt)("p",null,"Although we can use the service factory to abstract, whether it is semantics or some functions, it is slightly different from the service factory, such as the ability to load entity classes, which is unique to the data source."),(0,r.kt)("p",null,"For this reason, Midway provides ",(0,r.kt)("inlineCode",{parentName:"p"},"DataSourceManager")," abstraction to facilitate the management of data sources."),(0,r.kt)("p",null,"Take ",(0,r.kt)("inlineCode",{parentName:"p"},"mysql2")," as an example to implement a ",(0,r.kt)("inlineCode",{parentName:"p"},"mysql2")," connection pool management class."),(0,r.kt)("p",null,"The following is the official example of ",(0,r.kt)("inlineCode",{parentName:"p"},"mysql2"),", as a preparatory work."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// get the client\nconst mysql = require('mysql2');\n\n// create the connection to database\nconst connection = mysql.createConnection({\n  host: 'localhost',\n  user: 'root',\n  database: 'test'\n});\n\n// simple query\nconnection.query (\n  'SELECT * FROM `table` WHERE `name` = \"Page\" AND `age` > 45',\n  function(err, results, fields) {\n    console.log(results); // results contains rows returned by server\n    console.log(fields); // fields contains extra meta data about results, if available\n  }\n);\n")),(0,r.kt)("p",null,"Similar to service factories, we need to implement some fixed methods."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"Method of creating a data source"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:2},(0,r.kt)("li",{parentName:"ol"},"check the connection method")))),(0,r.kt)("h2",{id:"implement-data-source-manager"},"Implement data source manager"),(0,r.kt)("p",null,"The data source manager is also a common export class in midway, for example, we can also put it in ",(0,r.kt)("inlineCode",{parentName:"p"},"src/manager/mysqlDataSourceManager.ts"),"."),(0,r.kt)("h3",{id:"1-create-a-data-source-interface"},"1. Create a data source interface"),(0,r.kt)("p",null,"We only need to inherit the built-in ",(0,r.kt)("inlineCode",{parentName:"p"},"DataSourceManager")," class to implement a data source manager."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"DataSourceManager")," contain a generic type, you need to declare the data type of the data source."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { DataSourceManager, Provide, Scope, ScopeEnum } from '@midwayjs/core';\nimport * as mysql from 'mysql2';\n\n@Provide()\n@Scope(ScopeEnum.Singleton)\nexport class MySqlDataSourceManager extends DataSourceManager<mysql.Connection> {\n  // ...\n}\n\n")),(0,r.kt)("p",null,"Since it is an abstract class, we need to implement several basic methods."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { DataSourceManager, Provide, Scope, ScopeEnum } from '@midwayjs/core';\nimport * as mysql from 'mysql2';\n\n@Provide()\n@Scope(ScopeEnum.Singleton)\nexport class MySqlDataSourceManager extends DataSourceManager<mysql.Connection> {\n    // Create a single instance\n  protected async createDataSource(config: any, dataSourceName: string): Promise<mysql.Connection> {\n    return mysql.createConnection(config);\n  }\n\n  getName(): string {\n    return 'mysql';\n  }\n\n  async checkConnected(dataSource: mysql.Connection): Promise<boolean> {\n    // Pseudocode\n    return dataSource.status === 'connected';\n  }\n\n  async destroyDataSource(dataSource: mysql.Connection): Promise<void> {\n    if (await this.checkConnected(dataSource)) {\n      await dataSource.destroy();\n    }\n  }\n}\n\n")),(0,r.kt)("h3",{id:"2-provide-initialization-configuration"},"2. Provide initialization configuration"),(0,r.kt)("p",null,"You can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Init")," decorator and the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Config")," decorator to provide initialization configurations."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { DataSourceManager, Provide, Scope, ScopeEnum, Init, Config } from '@midwayjs/core';\nimport * as mysql from 'mysql2';\n\n@Provide()\n@Scope(ScopeEnum.Singleton)\nexport class MySqlDataSourceManager extends DataSourceManager<mysql.Connection> {\n\n  @Config('mysql')\n  mysqlConfig;\n\n  @Inject()\n  baseDir: string;\n\n  @Init()\n  async init() {\n    // It should be noted that the second parameter here needs to pass in an entity class scan address\n    await this.initDataSource(this.mysqlConfig, this.baseDir);\n  }\n\n  // ...\n}\n\n\n")),(0,r.kt)("p",null,"In the ",(0,r.kt)("inlineCode",{parentName:"p"},"src/config/config.default"),", we can provide the configuration of multiple data sources to create multiple data sources."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// config.default.ts\nexport const mysql = {\n  dataSource: {\n    dataSource1: {\n      host: 'localhost',\n      user: 'root',\n      database: 'test'\n    },\n    dataSource2: {\n      host: 'localhost',\n      user: 'root',\n      database: 'test'\n    },\n    dataSource3: {\n      host: 'localhost',\n      user: 'root',\n      database: 'test'\n    },\n  }\n  // Other configurations\n}\n")),(0,r.kt)("p",null,"Data sources are naturally designed for multiple instances. Unlike service factories, there is no difference between single and multiple configurations."),(0,r.kt)("h2",{id:"entity-binding"},"Entity binding"),(0,r.kt)("p",null,"The most important part of the data source is the entity class, each data source can have its own entity class. For example, orm frameworks such as typeorm are designed based on this."),(0,r.kt)("h3",{id:"1-explicitly-associate-entity-classes"},"1. Explicitly associate entity classes"),(0,r.kt)("p",null,"Entity classes are generally the same class as the table structure."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/entity/user.entity.ts\n// Here is the pseudo code, the decorator needs to implement it by itself.\n@Entity()\nexport class SimpleUser {\n  @Column()\n  name: string;\n}\n\n@Entity()\nexport class User {\n  @Column()\n  name: string;\n\n  @Column()\n  age: number;\n}\n")),(0,r.kt)("p",null,"The data source manager binds these entity classes to the data source through a fixed configuration."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// config.default.ts\nimport { User, SimpleUser } from '../entity/user.entity';\n\nexport default {\n  mysql: {\n    dataSource: {\n      dataSource1: {\n        host: 'localhost',\n        user: 'root',\n        database: 'test',\n        entities: [User]\n      },\n      dataSource2: {\n        host: 'localhost',\n        user: 'root',\n        database: 'test',\n        entities: [SimpleUser]\n      },\n      // ...\n    }\n  }\n}\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"entities")," configuration of each data source can add its own entity class."),(0,r.kt)("h3",{id:"2-directory-scan-associated-entities"},"2. Directory Scan Associated Entities"),(0,r.kt)("p",null,"In some cases, we can also replace it with a matching path, such:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// config.default.ts\nimport { User, SimpleUser } from '../entity/user.entity';\n\nexport default {\n  mysql: {\n    dataSource: {\n      dataSource1: {\n        host: 'localhost',\n        user: 'root',\n        database: 'test',\n        entities: [\n          User\n          SimpleUser\n           'entity', // specific directory (equivalent to directory wildcard)\n           '**/abc/**', // Only get files in directories containing abc characters\n           'abc/**/*.ts', // specific directory + wildcard\n           'abc/*.entity.ts', // match suffix\n           '**/*.entity.ts', // wildcard plus suffix match\n           '**/*.{j,t}s', // suffix match\n        ]\n      },\n      // ...\n      // ...\n    }\n  }\n}\n")),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Attention"),(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"When filling in the directory string, use the second parameter of the initDataSource method as a relative path search, and the default is baseDir (src or dist)"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:2},(0,r.kt)("li",{parentName:"ol"},"If the suffix is matched, the path of entities should include the js and ts suffixes, otherwise the entity will not be found after compilation"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:3},(0,r.kt)("li",{parentName:"ol"},"The writing method of the string path does not support ","[single-file build deployment]","(./deployment#single-file build deployment) (bundle mode)"))))),(0,r.kt)("h3",{id:"2-obtain-the-data-source-according-to-the-entity"},"2. Obtain the data source according to the entity"),(0,r.kt)("p",null,"Generally, our API is on data source objects, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"connection.query"),"."),(0,r.kt)("p",null,"So in many cases, such as custom decorators, you need a method to get data source objects from entities."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// The following is the pseudo code\nimport { SimpleUser } from '../entity/user.entity';\n\nclass UserService {\n  // A Model corresponding to the entity class will be injected here, including adding, deleting, modifying and checking methods.\n  @InjectEntityModel(SimpleUser)\n  userModel;\n\n}\n")),(0,r.kt)("p",null,"If the entity class corresponds to only one data source, we can obtain the data source by ",(0,r.kt)("inlineCode",{parentName:"p"},"getDataSourceNameByModel"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"this.mysqlDataSourceManager.getDataSourceNameByModel(SimpleUser);\n\n// => dataSource1\n")),(0,r.kt)("p",null,"In the case of multiple data sources, the data source obtained by this method may not be accurate, and the last set data source will be obtained."),(0,r.kt)("p",null,"In this case, users are generally required to manually specify the data source, such:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// The following is the pseudo code\nimport { SimpleUser } from '../entity/user.entity';\n\nclass UserService {\n  @InjectEntityModel(SimpleUser, 'dataSource2')\n  userModel;\n}\n")),(0,r.kt)("p",null,"The default data source can also be specified explicitly via the ",(0,r.kt)("inlineCode",{parentName:"p"},"defaultDataSourceName")," configuration."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// config.default.ts\nexport const mysql = {\n  dataSource: {\n    dataSource1: {\n      // ...\n    },\n    dataSource2: {\n      // ...\n    },\n    dataSource3: {\n      // ...\n    },\n  }\n  defaultDataSourceName: 'dataSource2',\n}\n")),(0,r.kt)("h2",{id:"get-data-source"},"Get data source"),(0,r.kt)("p",null,"By injecting the data source manager, we can get the data source through the above methods."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { MySqlDataSourceManager } from './manager/mysqlDataSourceManager';\nimport { join } from 'path';\n\n@Provide()\nexport class UserService {\n\n  @Inject()\n  mysqlDataSourceManager: MySqlDataSourceManager;\n\n  async invoke() {\n\n    const dataSource = this.mysqlDataSourceManager.getDataSource('dataSource1');\n    // TODO\n\n  }\n}\n")),(0,r.kt)("p",null,"In addition, there are some other methods."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// Whether the data source exists\nthis.mysqlDataSourceManager.hasDataSource('dataSource1');\n// Get all data source names\nthis.mysqlDataSourceManager.getDataSourceNames();\n// Whether the data source is connected\nthis.mysqlDataSourceManager.isConnected('dataSource1')\n")))}p.isMDXComponent=!0}}]);